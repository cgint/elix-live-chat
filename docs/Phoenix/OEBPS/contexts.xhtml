<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
      xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>Contexts - Phoenix v1.7.21</title>
    <meta name="generator" content="ExDoc v0.37.3" />
    <link type="text/css" rel="stylesheet" href="dist/epub-elixir-FNUUKFP7.css" />
    <script src="dist/epub-4WIP524F.js"></script>

  </head>
  <body class="content-inner">

    <h1 id="content">
Contexts
    </h1>
<blockquote><p><strong>Requirement</strong>: This guide expects that you have gone through the <a href="installation.html">introductory guides</a> and got a Phoenix application <a href="up_and_running.html">up and running</a>.</p></blockquote><blockquote><p><strong>Requirement</strong>: This guide expects that you have gone through the <a href="request_lifecycle.html">Request life-cycle guide</a>.</p></blockquote><blockquote><p><strong>Requirement</strong>: This guide expects that you have gone through the <a href="ecto.html">Ecto guide</a>.</p></blockquote><p>So far, we've built pages, wired up controller actions through our routers, and learned how Ecto allows data to be validated and persisted. Now it's time to tie it all together by writing web-facing features that interact with our greater Elixir application.</p><p>When building a Phoenix project, we are first and foremost building an Elixir application. Phoenix's job is to provide a web interface into our Elixir application. Naturally, we compose our applications with modules and functions, but we often assign specific responsibilities to certain modules and give them names: such as controllers, routers, and live views.</p><p>As everything else, contexts in Phoenix are modules, but with the distinct reponsibility of drawing boundaries and grouping functionality. In other words, they allow us to reason and discuss about application design.</p><h2 id="thinking-about-contexts" class="section-heading">
  <a href="#thinking-about-contexts" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Thinking about contexts</span>
</h2>
<p>Contexts are dedicated modules that expose and group related functionality. For example, anytime you call Elixir's standard library, be it <a href="https://hexdocs.pm/logger/Logger.html#info/1"><code class="inline">Logger.info/1</code></a> or <a href="https://hexdocs.pm/elixir/Stream.html#map/2"><code class="inline">Stream.map/2</code></a>, you are accessing different contexts. Internally, Elixir's logger is made of multiple modules, but we never interact with those modules directly. We call the <a href="https://hexdocs.pm/logger/Logger.html"><code class="inline">Logger</code></a> module the context, exactly because it exposes and groups all of the logging functionality.</p><p>By giving modules that expose and group related functionality the name <strong>contexts</strong>, we help developers identify these patterns and talk about them. At the end of the day, contexts are just modules, as are your controllers, views, etc.</p><p>In Phoenix, contexts often encapsulate data access and data validation. They often talk to a database or APIs. Overall, think of them as boundaries to decouple and isolate parts of your application. Let's use these ideas to build out our web application. Our goal is to build an ecommerce system where we can showcase products, allow users to add products to their cart, and complete their orders.</p><blockquote><p>How to read this guide: Using the context generators is a great way for beginners and intermediate Elixir programmers alike to get up and running quickly while thoughtfully writing their applications. This guide focuses on those readers.</p></blockquote><h3 id="adding-a-catalog-context" class="section-heading">
  <a href="#adding-a-catalog-context" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Adding a Catalog Context</span>
</h3>
<p>An ecommerce platform has wide-reaching coupling across a codebase so it's important to think about writing well-defined modules. With that in mind, our goal is to build a product catalog API that handles creating, updating, and deleting the products available in our system. We'll start off with the basic features of showcasing our products, and we will add shopping cart features later. We'll see how starting with a solid foundation with isolated boundaries allows us to grow our application naturally as we add functionality.</p><p>Phoenix includes the <a href="Mix.Tasks.Phx.Gen.Html.xhtml"><code class="inline">mix phx.gen.html</code></a>, <a href="Mix.Tasks.Phx.Gen.Json.xhtml"><code class="inline">mix phx.gen.json</code></a>, <a href="Mix.Tasks.Phx.Gen.Live.xhtml"><code class="inline">mix phx.gen.live</code></a>, and <a href="Mix.Tasks.Phx.Gen.Context.xhtml"><code class="inline">mix phx.gen.context</code></a> generators that apply the ideas of isolating functionality in our applications into contexts. These generators are a great way to hit the ground running while Phoenix nudges you in the right direction to grow your application. Let's put these tools to use for our new product catalog context.</p><p>In order to run the context generators, we need to come up with a module name that groups the related functionality that we're building. In the <a href="ecto.html">Ecto guide</a>, we saw how we can use Changesets and Repos to validate and persist user schemas, but we didn't integrate this with our application at large. In fact, we didn't think about where a &quot;user&quot; in our application should live at all. Let's take a step back and think about the different parts of our system. We know that we'll have products to showcase on pages for sale, along with descriptions, pricing, etc. Along with selling products, we know we'll need to support carting, order checkout, and so on. While the products being purchased are related to the cart and checkout processes, showcasing a product and managing the <em>exhibition</em> of our products is distinctly different than tracking what a user has placed in their cart or how an order is placed. A <code class="inline">Catalog</code> context is a natural place for the management of our product details and the showcasing of those products we have for sale.</p><section role="note" class="admonition tip"><h4 class="admonition-title tip">Naming things is hard</h4><p>If you're stuck when trying to come up with a context name when the grouped functionality in your system isn't yet clear, you can simply use the plural form of the resource you're creating. For example, a <code class="inline">Products</code> context for managing products. As you grow your application and the parts of your system become clear, you can simply rename the context to a more refined one.</p></section><p>To jump-start our catalog context, we'll use <a href="Mix.Tasks.Phx.Gen.Html.xhtml"><code class="inline">mix phx.gen.html</code></a> which creates a context module that wraps up Ecto access for creating, updating, and deleting products, along with web files like controllers and templates for the web interface into our context. Run the following command at your project root:</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix phx.gen.html Catalog Product products title:string \
</span><span class="">description:string price:decimal views:integer
</span><span class="">
</span><span class="">* creating lib/hello_web/controllers/product_controller.ex
</span><span class="">* creating lib/hello_web/controllers/product_html/edit.html.heex
</span><span class="">* creating lib/hello_web/controllers/product_html/index.html.heex
</span><span class="">* creating lib/hello_web/controllers/product_html/new.html.heex
</span><span class="">* creating lib/hello_web/controllers/product_html/show.html.heex
</span><span class="">* creating lib/hello_web/controllers/product_html/product_form.html.heex
</span><span class="">* creating lib/hello_web/controllers/product_html.ex
</span><span class="">* creating test/hello_web/controllers/product_controller_test.exs
</span><span class="">* creating lib/hello/catalog/product.ex
</span><span class="">* creating priv/repo/migrations/20210201185747_create_products.exs
</span><span class="">* creating lib/hello/catalog.ex
</span><span class="">* injecting lib/hello/catalog.ex
</span><span class="">* creating test/hello/catalog_test.exs
</span><span class="">* injecting test/hello/catalog_test.exs
</span><span class="">* creating test/support/fixtures/catalog_fixtures.ex
</span><span class="">* injecting test/support/fixtures/catalog_fixtures.ex
</span><span class="">
</span><span class="">Add the resource to your browser scope in lib/hello_web/router.ex:
</span><span class="">
</span><span class="">    resources &quot;/products&quot;, ProductController
</span><span class="">
</span><span class="">
</span><span class="">Remember to update your repository by running migrations:
</span><span class="">
</span><span class="">    $ mix ecto.migrate
</span></code></pre><p>Phoenix generated the web files as expected in <code class="inline">lib/hello_web/</code>. We can also see our context files were generated inside a <code class="inline">lib/hello/catalog.ex</code> file and our product schema in the directory of the same name. Note the difference between <code class="inline">lib/hello</code> and <code class="inline">lib/hello_web</code>. We have a <code class="inline">Catalog</code> module to serve as the public API for product catalog functionality, as well as a <code class="inline">Catalog.Product</code> struct, which is an Ecto schema for casting and validating product data. Phoenix also provided web and context tests for us, it also included test helpers for creating entities via the <code class="inline">Hello.Catalog</code> context, which we'll look at later. For now, let's follow the instructions and add the route according to the console instructions, in <code class="inline">lib/hello_web/router.ex</code>:</p><pre><code class="makeup diff" translate="no"><span class="n">  scope &quot;/&quot;, HelloWeb do
</span><span class="n">    pipe_through :browser
</span><span class="w">
</span><span class="n">    get &quot;/&quot;, PageController, :index
</span><span class="gi">+</span><span class="gi">   resources &quot;/products&quot;, ProductController
</span><span class="n">  end</span></code></pre><p>With the new route in place, Phoenix reminds us to update our repo by running <a href="https://hexdocs.pm/ecto_sql/3.10.1/Mix.Tasks.Ecto.Migrate.html"><code class="inline">mix ecto.migrate</code></a>, but first we need to make a few tweaks to the generated migration in <code class="inline">priv/repo/migrations/*_create_products.exs</code>:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="k" data-group-id="1611289675-1">do</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="1611289675-2">(</span><span class="ss">:products</span><span class="p" data-group-id="1611289675-2">)</span><span class="w"> </span><span class="k" data-group-id="1611289675-3">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:description</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
</span><span class="o">-</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:price</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:price</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="p">,</span><span class="w"> </span><span class="ss">precision</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="ss">scale</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="ss">null</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
</span><span class="o">-</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:views</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:views</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="p">,</span><span class="w"> </span><span class="ss">default</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">null</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">

      </span><span class="n">timestamps</span><span class="p" data-group-id="1611289675-4">(</span><span class="p" data-group-id="1611289675-4">)</span><span class="w">
    </span><span class="k" data-group-id="1611289675-3">end</span></code></pre><p>We modified our price column to a specific precision of 15, scale of 6, along with a not-null constraint. This ensures we store currency with proper precision for any mathematical operations we may perform. Next, we added a default value and not-null constraint to our views count. With our changes in place, we're ready to migrate up our database. Let's do that now:</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix ecto.migrate
</span><span class="">14:09:02.260 [info] == Running 20210201185747 Hello.Repo.Migrations.CreateProducts.change/0 forward
</span><span class="">
</span><span class="">14:09:02.262 [info] create table products
</span><span class="">
</span><span class="">14:09:02.273 [info] == Migrated 20210201185747 in 0.0s
</span></code></pre><p>Before we jump into the generated code, let's start the server with <a href="Mix.Tasks.Phx.Server.xhtml"><code class="inline">mix phx.server</code></a> and visit <a href="http://localhost:4000/products">http://localhost:4000/products</a>. Let's follow the &quot;New Product&quot; link and click the &quot;Save&quot; button without providing any input. We should be greeted with the following output:</p><pre><code class="text">Oops, something went wrong! Please check the errors below.</code></pre><p>When we submit the form, we can see all the validation errors inline with the inputs. Nice! Out of the box, the context generator included the schema fields in our form template and we can see our default validations for required inputs are in effect. Let's enter some example product data and resubmit the form:</p><pre><code class="text">Product created successfully.

Title: Metaprogramming Elixir
Description: Write Less Code, Get More Done (and Have Fun!)
Price: 15.000000
Views: 0</code></pre><p>If we follow the &quot;Back&quot; link, we get a list of all products, which should contain the one we just created. Likewise, we can update this record or delete it. Now that we've seen how it works in the browser, it's time to take a look at the generated code.</p><h2 id="starting-with-generators" class="section-heading">
  <a href="#starting-with-generators" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Starting with generators</span>
</h2>
<p>That little <a href="Mix.Tasks.Phx.Gen.Html.xhtml"><code class="inline">mix phx.gen.html</code></a> command packed a surprising punch. We got a lot of functionality out-of-the-box for creating, updating, and deleting products in our catalog. This is far from a full-featured app, but remember, generators are first and foremost learning tools and a starting point for you to begin building real features. Code generation can't solve all your problems, but it will teach you the ins and outs of Phoenix and nudge you towards the proper mindset when designing your application.</p><p>Let's first check out the <code class="inline">ProductController</code> that was generated in <code class="inline">lib/hello_web/controllers/product_controller.ex</code>:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.ProductController</span><span class="w"> </span><span class="k" data-group-id="9011290727-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:controller</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Catalog</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Catalog.Product</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">index</span><span class="p" data-group-id="9011290727-2">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="c">_params</span><span class="p" data-group-id="9011290727-2">)</span><span class="w"> </span><span class="k" data-group-id="9011290727-3">do</span><span class="w">
    </span><span class="n">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Catalog</span><span class="o">.</span><span class="n">list_products</span><span class="p" data-group-id="9011290727-4">(</span><span class="p" data-group-id="9011290727-4">)</span><span class="w">
    </span><span class="n">render</span><span class="p" data-group-id="9011290727-5">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:index</span><span class="p">,</span><span class="w"> </span><span class="ss">products</span><span class="p">:</span><span class="w"> </span><span class="n">products</span><span class="p" data-group-id="9011290727-5">)</span><span class="w">
  </span><span class="k" data-group-id="9011290727-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">new</span><span class="p" data-group-id="9011290727-6">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="c">_params</span><span class="p" data-group-id="9011290727-6">)</span><span class="w"> </span><span class="k" data-group-id="9011290727-7">do</span><span class="w">
    </span><span class="n">changeset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Catalog</span><span class="o">.</span><span class="n">change_product</span><span class="p" data-group-id="9011290727-8">(</span><span class="p" data-group-id="9011290727-9">%</span><span class="nc" data-group-id="9011290727-9">Product</span><span class="p" data-group-id="9011290727-9">{</span><span class="p" data-group-id="9011290727-9">}</span><span class="p" data-group-id="9011290727-8">)</span><span class="w">
    </span><span class="n">render</span><span class="p" data-group-id="9011290727-10">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:new</span><span class="p">,</span><span class="w"> </span><span class="ss">changeset</span><span class="p">:</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="9011290727-10">)</span><span class="w">
  </span><span class="k" data-group-id="9011290727-7">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create</span><span class="p" data-group-id="9011290727-11">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9011290727-12">%{</span><span class="s">&quot;product&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">product_params</span><span class="p" data-group-id="9011290727-12">}</span><span class="p" data-group-id="9011290727-11">)</span><span class="w"> </span><span class="k" data-group-id="9011290727-13">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Catalog</span><span class="o">.</span><span class="n">create_product</span><span class="p" data-group-id="9011290727-14">(</span><span class="n">product_params</span><span class="p" data-group-id="9011290727-14">)</span><span class="w"> </span><span class="k" data-group-id="9011290727-15">do</span><span class="w">
      </span><span class="p" data-group-id="9011290727-16">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p" data-group-id="9011290727-16">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="9011290727-17">(</span><span class="ss">:info</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Product created successfully.&quot;</span><span class="p" data-group-id="9011290727-17">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="9011290727-18">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="sx">~p&quot;/products/</span><span class="si" data-group-id="9011290727-19">#{</span><span class="n">product</span><span class="si" data-group-id="9011290727-19">}</span><span class="sx">&quot;</span><span class="p" data-group-id="9011290727-18">)</span><span class="w">

      </span><span class="p" data-group-id="9011290727-20">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9011290727-21">%</span><span class="nc" data-group-id="9011290727-21">Ecto.Changeset</span><span class="p" data-group-id="9011290727-21">{</span><span class="p" data-group-id="9011290727-21">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="9011290727-20">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">render</span><span class="p" data-group-id="9011290727-22">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:new</span><span class="p">,</span><span class="w"> </span><span class="ss">changeset</span><span class="p">:</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="9011290727-22">)</span><span class="w">
    </span><span class="k" data-group-id="9011290727-15">end</span><span class="w">
  </span><span class="k" data-group-id="9011290727-13">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">show</span><span class="p" data-group-id="9011290727-23">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9011290727-24">%{</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="9011290727-24">}</span><span class="p" data-group-id="9011290727-23">)</span><span class="w"> </span><span class="k" data-group-id="9011290727-25">do</span><span class="w">
    </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Catalog</span><span class="o">.</span><span class="n">get_product!</span><span class="p" data-group-id="9011290727-26">(</span><span class="n">id</span><span class="p" data-group-id="9011290727-26">)</span><span class="w">
    </span><span class="n">render</span><span class="p" data-group-id="9011290727-27">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:show</span><span class="p">,</span><span class="w"> </span><span class="ss">product</span><span class="p">:</span><span class="w"> </span><span class="n">product</span><span class="p" data-group-id="9011290727-27">)</span><span class="w">
  </span><span class="k" data-group-id="9011290727-25">end</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="9011290727-1">end</span></code></pre><p>We've seen how controllers work in our <a href="controllers.html">controller guide</a>, so the code probably isn't too surprising. What is worth noticing is how our controller calls into the <code class="inline">Catalog</code> context. We can see that the <code class="inline">index</code> action fetches a list of products with <code class="inline">Catalog.list_products/0</code>, and how products are persisted in the <code class="inline">create</code> action with <code class="inline">Catalog.create_product/1</code>. We haven't yet looked at the catalog context, so we don't yet know how product fetching and creation is happening under the hood – <em>but that's the point</em>. Our Phoenix controller is the web interface into our greater application. It shouldn't be concerned with the details of how products are fetched from the database or persisted into storage. We only care about telling our application to perform some work for us. This is great because our business logic and storage details are decoupled from the web layer of our application. If we move to a full-text storage engine later for fetching products instead of a SQL query, our controller doesn't need to be changed. Likewise, we can reuse our context code from any other interface in our application, be it a channel, mix task, or long-running process importing CSV data.</p><p>In the case of our <code class="inline">create</code> action, when we successfully create a product, we use <a href="Phoenix.Controller.xhtml#put_flash/3"><code class="inline">Phoenix.Controller.put_flash/3</code></a> to show a success message, and then we redirect to the router's product show page. Conversely, if <code class="inline">Catalog.create_product/1</code> fails, we render our <code class="inline">&quot;new.html&quot;</code> template and pass along the Ecto changeset for the template to lift error messages from.</p><p>Next, let's dig deeper and check out our <code class="inline">Catalog</code> context in <code class="inline">lib/hello/catalog.ex</code>:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Hello.Catalog</span><span class="w"> </span><span class="k" data-group-id="1736882501-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  The Catalog context.
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Ecto.Query</span><span class="p">,</span><span class="w"> </span><span class="ss">warn</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Repo</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Catalog.Product</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Returns the list of products.

  ## Examples

      iex&gt; list_products()
      [%Product{}, ...]

  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">list_products</span><span class="w"> </span><span class="k" data-group-id="1736882501-2">do</span><span class="w">
    </span><span class="nc">Repo</span><span class="o">.</span><span class="n">all</span><span class="p" data-group-id="1736882501-3">(</span><span class="nc">Product</span><span class="p" data-group-id="1736882501-3">)</span><span class="w">
  </span><span class="k" data-group-id="1736882501-2">end</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="1736882501-1">end</span></code></pre><p>This module will be the public API for all product catalog functionality in our system. For example, in addition to product detail management, we may also handle product category classification and product variants for things like optional sizing, trims, etc. If we look at the <code class="inline">list_products/0</code> function, we can see the private details of product fetching. And it's super simple. We have a call to <code class="inline">Repo.all(Product)</code>. We saw how Ecto repo queries worked in the <a href="ecto.html">Ecto guide</a>, so this call should look familiar. Our <code class="inline">list_products</code> function is a generalized function name specifying the <em>intent</em> of our code – namely to list products. The details of that intent where we use our Repo to fetch the products from our PostgreSQL database is hidden from our callers. This is a common theme we'll see re-iterated as we use the Phoenix generators. Phoenix will push us to think about where we have different responsibilities in our application, and then to wrap up those different areas behind well-named modules and functions that make the intent of our code clear, while encapsulating the details.</p><p>Now we know how data is fetched, but how are products persisted? Let's take a look at the <code class="inline">Catalog.create_product/1</code> function:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Creates a product.

  ## Examples

      iex&gt; create_product(%{field: value})
      {:ok, %Product{}}

      iex&gt; create_product(%{field: bad_value})
      {:error, %Ecto.Changeset{}}

  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create_product</span><span class="p" data-group-id="9125494826-1">(</span><span class="n">attrs</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="9125494826-2">%{</span><span class="p" data-group-id="9125494826-2">}</span><span class="p" data-group-id="9125494826-1">)</span><span class="w"> </span><span class="k" data-group-id="9125494826-3">do</span><span class="w">
    </span><span class="p" data-group-id="9125494826-4">%</span><span class="nc" data-group-id="9125494826-4">Product</span><span class="p" data-group-id="9125494826-4">{</span><span class="p" data-group-id="9125494826-4">}</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Product</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="9125494826-5">(</span><span class="n">attrs</span><span class="p" data-group-id="9125494826-5">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p" data-group-id="9125494826-6">(</span><span class="p" data-group-id="9125494826-6">)</span><span class="w">
  </span><span class="k" data-group-id="9125494826-3">end</span></code></pre><p>There's more documentation than code here, but a couple of things are important to highlight. First, we can see again that our Ecto Repo is used under the hood for database access. You probably also noticed the call to <code class="inline">Product.changeset/2</code>. We talked about changesets before, and now we see them in action in our context.</p><p>If we open up the <code class="inline">Product</code> schema in <code class="inline">lib/hello/catalog/product.ex</code>, it will look immediately familiar:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Hello.Catalog.Product</span><span class="w"> </span><span class="k" data-group-id="0676805100-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="w">

  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;products&quot;</span><span class="w"> </span><span class="k" data-group-id="0676805100-2">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:description</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:price</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:views</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="w">

    </span><span class="n">timestamps</span><span class="p" data-group-id="0676805100-3">(</span><span class="p" data-group-id="0676805100-3">)</span><span class="w">
  </span><span class="k" data-group-id="0676805100-2">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="no">false</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">changeset</span><span class="p" data-group-id="0676805100-4">(</span><span class="n">product</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="0676805100-4">)</span><span class="w"> </span><span class="k" data-group-id="0676805100-5">do</span><span class="w">
    </span><span class="n">product</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">cast</span><span class="p" data-group-id="0676805100-6">(</span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0676805100-7">[</span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">:description</span><span class="p">,</span><span class="w"> </span><span class="ss">:price</span><span class="p">,</span><span class="w"> </span><span class="ss">:views</span><span class="p" data-group-id="0676805100-7">]</span><span class="p" data-group-id="0676805100-6">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">validate_required</span><span class="p" data-group-id="0676805100-8">(</span><span class="p" data-group-id="0676805100-9">[</span><span class="ss">:title</span><span class="p">,</span><span class="w"> </span><span class="ss">:description</span><span class="p">,</span><span class="w"> </span><span class="ss">:price</span><span class="p">,</span><span class="w"> </span><span class="ss">:views</span><span class="p" data-group-id="0676805100-9">]</span><span class="p" data-group-id="0676805100-8">)</span><span class="w">
  </span><span class="k" data-group-id="0676805100-5">end</span><span class="w">
</span><span class="k" data-group-id="0676805100-1">end</span></code></pre><p>This is just what we saw before when we ran <a href="Mix.Tasks.Phx.Gen.Schema.xhtml"><code class="inline">mix phx.gen.schema</code></a>, except here we see a <code class="inline">@doc false</code> above our <code class="inline">changeset/2</code> function. This tells us that while this function is publicly callable, it's not part of the public context API. Callers that build changesets do so via the context API. For example, <code class="inline">Catalog.create_product/1</code> calls into our <code class="inline">Product.changeset/2</code> to build the changeset from user input. Callers, such as our controller actions, do not access <code class="inline">Product.changeset/2</code> directly. All interaction with our product changesets is done through the public <code class="inline">Catalog</code> context.</p><h2 id="adding-catalog-functions" class="section-heading">
  <a href="#adding-catalog-functions" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Adding Catalog functions</span>
</h2>
<p>As we've seen, your context modules are dedicated modules that expose and group related functionality. Phoenix generates generic functions, such as <code class="inline">list_products</code> and <code class="inline">update_product</code>, but they only serve as a basis for you to grow your business logic and application from. Let's add one of the basic features of our catalog by tracking product page view count.</p><p>For any ecommerce system, the ability to track how many times a product page has been viewed is essential for marketing, suggestions, ranking, etc. While we could try to use the existing <code class="inline">Catalog.update_product</code> function, along the lines of <code class="inline">Catalog.update_product(product, %{views: product.views + 1})</code>, this would not only be prone to race conditions, but it would also require the caller to know too much about our Catalog system. To see why the race condition exists, let's walk through the possible execution of events:</p><p>Intuitively, you would assume the following events:</p><ol><li>User 1 loads the product page with count of 13</li><li>User 1 saves the product page with count of 14</li><li>User 2 loads the product page with count of 14</li><li>User 2 saves the product page with count of 15</li></ol><p>While in practice this would happen:</p><ol><li>User 1 loads the product page with count of 13</li><li>User 2 loads the product page with count of 13</li><li>User 1 saves the product page with count of 14</li><li>User 2 saves the product page with count of 14</li></ol><p>The race conditions would make this an unreliable way to update the existing table since multiple callers may be updating out of date view values. There's a better way.</p><p>Let's think of a function that describes what we want to accomplish. Here's how we would like to use it:</p><pre><code class="makeup elixir" translate="no"><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Catalog</span><span class="o">.</span><span class="n">inc_page_views</span><span class="p" data-group-id="1875035312-1">(</span><span class="n">product</span><span class="p" data-group-id="1875035312-1">)</span></code></pre><p>That looks great. Our callers will have no confusion over what this function does, and we can wrap up the increment in an atomic operation to prevent race conditions.</p><p>Open up your catalog context (<code class="inline">lib/hello/catalog.ex</code>), and add this new function:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">inc_page_views</span><span class="p" data-group-id="3892165548-1">(</span><span class="p" data-group-id="3892165548-2">%</span><span class="nc" data-group-id="3892165548-2">Product</span><span class="p" data-group-id="3892165548-2">{</span><span class="p" data-group-id="3892165548-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">product</span><span class="p" data-group-id="3892165548-1">)</span><span class="w"> </span><span class="k" data-group-id="3892165548-3">do</span><span class="w">
    </span><span class="p" data-group-id="3892165548-4">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3892165548-5">[</span><span class="p" data-group-id="3892165548-6">%</span><span class="nc" data-group-id="3892165548-6">Product</span><span class="p" data-group-id="3892165548-6">{</span><span class="ss">views</span><span class="p">:</span><span class="w"> </span><span class="n">views</span><span class="p" data-group-id="3892165548-6">}</span><span class="p" data-group-id="3892165548-5">]</span><span class="p" data-group-id="3892165548-4">}</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">from</span><span class="p" data-group-id="3892165548-7">(</span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Product</span><span class="p">,</span><span class="w"> </span><span class="ss">where</span><span class="p">:</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="ss">select</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3892165548-8">[</span><span class="ss">:views</span><span class="p" data-group-id="3892165548-8">]</span><span class="p" data-group-id="3892165548-7">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">update_all</span><span class="p" data-group-id="3892165548-9">(</span><span class="ss">inc</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3892165548-10">[</span><span class="ss">views</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="3892165548-10">]</span><span class="p" data-group-id="3892165548-9">)</span><span class="w">

    </span><span class="n">put_in</span><span class="p" data-group-id="3892165548-11">(</span><span class="n">product</span><span class="o">.</span><span class="n">views</span><span class="p">,</span><span class="w"> </span><span class="n">views</span><span class="p" data-group-id="3892165548-11">)</span><span class="w">
  </span><span class="k" data-group-id="3892165548-3">end</span></code></pre><p>We built a query for fetching the current product given its ID which we pass to <code class="inline">Repo.update_all</code>. Ecto's <code class="inline">Repo.update_all</code> allows us to perform batch updates against the database, and is perfect for atomically updating values, such as incrementing our views count. The result of the repo operation returns the number of updated records, along with the selected schema values specified by the <code class="inline">select</code> option. When we receive the new product views, we use <code class="inline">put_in(product.views, views)</code> to place the new view count within the product struct.</p><p>With our context function in place, let's make use of it in our product controller. Update your <code class="inline">show</code> action in <code class="inline">lib/hello_web/controllers/product_controller.ex</code> to call our new function:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">show</span><span class="p" data-group-id="1298772079-1">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1298772079-2">%{</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="1298772079-2">}</span><span class="p" data-group-id="1298772079-1">)</span><span class="w"> </span><span class="k" data-group-id="1298772079-3">do</span><span class="w">
    </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">id</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Catalog</span><span class="o">.</span><span class="n">get_product!</span><span class="p" data-group-id="1298772079-4">(</span><span class="p" data-group-id="1298772079-4">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Catalog</span><span class="o">.</span><span class="n">inc_page_views</span><span class="p" data-group-id="1298772079-5">(</span><span class="p" data-group-id="1298772079-5">)</span><span class="w">

    </span><span class="n">render</span><span class="p" data-group-id="1298772079-6">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:show</span><span class="p">,</span><span class="w"> </span><span class="ss">product</span><span class="p">:</span><span class="w"> </span><span class="n">product</span><span class="p" data-group-id="1298772079-6">)</span><span class="w">
  </span><span class="k" data-group-id="1298772079-3">end</span></code></pre><p>We modified our <code class="inline">show</code> action to pipe our fetched product into <code class="inline">Catalog.inc_page_views/1</code>, which will return the updated product. Then we rendered our template just as before. Let's try it out. Refresh one of your product pages a few times and watch the view count increase.</p><p>We can also see our atomic update in action in the ecto debug logs:</p><pre><code class="text">[debug] QUERY OK source=&quot;products&quot; db=0.5ms idle=834.5ms
UPDATE &quot;products&quot; AS p0 SET &quot;views&quot; = p0.&quot;views&quot; + $1 WHERE (p0.&quot;id&quot; = $2) RETURNING p0.&quot;views&quot; [1, 1]</code></pre><p>Good work!</p><p>As we've seen, designing with contexts gives you a solid foundation to grow your application from. Using discrete, well-defined APIs that expose the intent of your system allows you to write more maintainable applications with reusable code. Now that we know how to start extending our context API, lets explore handling relationships within a context.</p><h2 id="in-context-relationships" class="section-heading">
  <a href="#in-context-relationships" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">In-context relationships</span>
</h2>
<p>Our basic catalog features are nice, but let's take it up a notch by categorizing products. Many ecommerce solutions allow products to be categorized in different ways, such as a product being marked for fashion, power tools, and so on. Starting with a one-to-one relationship between product and categories will cause major code changes later if we need to start supporting multiple categories. Let's set up a category association that will allow us to start off tracking a single category per product, but easily support more later as we grow our features.</p><p>For now, categories will contain only textual information. Our first order of business is to decide where categories live in the application. We have our <code class="inline">Catalog</code> context, which manages the exhibition of our products. Product categorization is a natural fit here. Phoenix is also smart enough to generate code inside an existing context, which makes adding new resources to a context a breeze. Run the following command at your project root:</p><blockquote><p>Sometimes it may be tricky to determine if two resources belong to the same context or not. In those cases, prefer distinct contexts per resource and refactor later if necessary. Otherwise you can easily end up with large contexts of loosely related entities. Also keep in mind that the fact two resources are related does not necessarily mean they belong to the same context, otherwise you would quickly end up with one large context, as the majority of resources in an application are connected to each other. To sum it up: if you are unsure, you should prefer separate modules (contexts).</p></blockquote><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix phx.gen.context Catalog Category categories \
</span><span class="">title:string:unique
</span><span class="">
</span><span class="">You are generating into an existing context.
</span><span class="">...
</span><span class="">Would you like to proceed? [Yn] y
</span><span class="">* creating lib/hello/catalog/category.ex
</span><span class="">* creating priv/repo/migrations/20210203192325_create_categories.exs
</span><span class="">* injecting lib/hello/catalog.ex
</span><span class="">* injecting test/hello/catalog_test.exs
</span><span class="">* injecting test/support/fixtures/catalog_fixtures.ex
</span><span class="">
</span><span class="">Remember to update your repository by running migrations:
</span><span class="">
</span><span class="">    $ mix ecto.migrate
</span></code></pre><p>This time around, we used <a href="Mix.Tasks.Phx.Gen.Context.xhtml"><code class="inline">mix phx.gen.context</code></a>, which is just like <a href="Mix.Tasks.Phx.Gen.Html.xhtml"><code class="inline">mix phx.gen.html</code></a>, except it doesn't generate the web files for us. Since we already have controllers and templates for managing products, we can integrate the new category features into our existing web form and product show page. We can see we now have a new <code class="inline">Category</code> schema alongside our product schema at <code class="inline">lib/hello/catalog/category.ex</code>, and Phoenix told us it was <em>injecting</em> new functions in our existing Catalog context for the category functionality. The injected functions will look very familiar to our product functions, with new functions like <code class="inline">create_category</code>, <code class="inline">list_categories</code>, and so on. Before we migrate up, we need to do a second bit of code generation. Our category schema is great for representing an individual category in the system, but we need to support a many-to-many relationship between products and categories. Fortunately, ecto allows us to do this simply with a join table, so let's generate that now with the <code class="inline">ecto.gen.migration</code> command:</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix ecto.gen.migration create_product_categories
</span><span class="">
</span><span class="">* creating priv/repo/migrations/20210203192958_create_product_categories.exs
</span></code></pre><p>Next, let's open up the new migration file and add the following code to the <code class="inline">change</code> function:</p><pre><code class="makeup elixir" translate="no"><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Hello.Repo.Migrations.CreateProductCategories</span><span class="w"> </span><span class="k" data-group-id="0978324791-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="k" data-group-id="0978324791-2">do</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="0978324791-3">(</span><span class="ss">:product_categories</span><span class="p">,</span><span class="w"> </span><span class="ss">primary_key</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="0978324791-3">)</span><span class="w"> </span><span class="k" data-group-id="0978324791-4">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:product_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="0978324791-5">(</span><span class="ss">:products</span><span class="p">,</span><span class="w"> </span><span class="ss">on_delete</span><span class="p">:</span><span class="w"> </span><span class="ss">:delete_all</span><span class="p" data-group-id="0978324791-5">)</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:category_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="0978324791-6">(</span><span class="ss">:categories</span><span class="p">,</span><span class="w"> </span><span class="ss">on_delete</span><span class="p">:</span><span class="w"> </span><span class="ss">:delete_all</span><span class="p" data-group-id="0978324791-6">)</span><span class="w">
    </span><span class="k" data-group-id="0978324791-4">end</span><span class="w">

    </span><span class="n">create</span><span class="w"> </span><span class="n">index</span><span class="p" data-group-id="0978324791-7">(</span><span class="ss">:product_categories</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0978324791-8">[</span><span class="ss">:product_id</span><span class="p" data-group-id="0978324791-8">]</span><span class="p" data-group-id="0978324791-7">)</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="n">unique_index</span><span class="p" data-group-id="0978324791-9">(</span><span class="ss">:product_categories</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0978324791-10">[</span><span class="ss">:category_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:product_id</span><span class="p" data-group-id="0978324791-10">]</span><span class="p" data-group-id="0978324791-9">)</span><span class="w">
  </span><span class="k" data-group-id="0978324791-2">end</span><span class="w">
</span><span class="k" data-group-id="0978324791-1">end</span></code></pre><p>We created a <code class="inline">product_categories</code> table and used the <code class="inline">primary_key: false</code> option since our join table does not need a primary key. Next we defined our <code class="inline">:product_id</code> and <code class="inline">:category_id</code> foreign key fields, and passed <code class="inline">on_delete: :delete_all</code> to ensure the database prunes our join table records if a linked product or category is deleted. By using a database constraint, we enforce data integrity at the database level, rather than relying on ad-hoc and error-prone application logic.</p><p>Next, we created indexes for our foreign keys, one of which is a unique index to ensure a product cannot have duplicate categories. Note that we do not necessarily need single-column index for <code class="inline">category_id</code> because it is in the leftmost prefix of multicolumn index, which is enough for the database optimizer. Adding a redundant index, on the other hand, only adds overhead on write.</p><p>With our migrations in place, we can migrate up.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix ecto.migrate
</span><span class="">
</span><span class="">18:20:36.489 [info] == Running 20210222231834 Hello.Repo.Migrations.CreateCategories.change/0 forward
</span><span class="">
</span><span class="">18:20:36.493 [info] create table categories
</span><span class="">
</span><span class="">18:20:36.508 [info] create index categories_title_index
</span><span class="">
</span><span class="">18:20:36.512 [info] == Migrated 20210222231834 in 0.0s
</span><span class="">
</span><span class="">18:20:36.547 [info] == Running 20210222231930 Hello.Repo.Migrations.CreateProductCategories.change/0 forward
</span><span class="">
</span><span class="">18:20:36.547 [info] create table product_categories
</span><span class="">
</span><span class="">18:20:36.557 [info] create index product_categories_product_id_index
</span><span class="">
</span><span class="">18:20:36.560 [info]  create index product_categories_category_id_product_id_index
</span><span class="">
</span><span class="">18:20:36.562 [info] == Migrated 20210222231930 in 0.0s
</span></code></pre><p>Now that we have a <code class="inline">Catalog.Product</code> schema and a join table to associate products and categories, we're nearly ready to start wiring up our new features. Before we dive in, we first need real categories to select in our web UI. Let's quickly seed some new categories in the application. Add the following code to your seeds file in <code class="inline">priv/repo/seeds.exs</code>:</p><pre><code class="makeup elixir" translate="no"><span class="k">for</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p" data-group-id="1619926462-1">[</span><span class="s">&quot;Home Improvement&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Power Tools&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Gardening&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Books&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Education&quot;</span><span class="p" data-group-id="1619926462-1">]</span><span class="w"> </span><span class="k" data-group-id="1619926462-2">do</span><span class="w">
  </span><span class="p" data-group-id="1619926462-3">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="1619926462-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Hello.Catalog</span><span class="o">.</span><span class="n">create_category</span><span class="p" data-group-id="1619926462-4">(</span><span class="p" data-group-id="1619926462-5">%{</span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="n">title</span><span class="p" data-group-id="1619926462-5">}</span><span class="p" data-group-id="1619926462-4">)</span><span class="w">
</span><span class="k" data-group-id="1619926462-2">end</span></code></pre><p>We simply enumerate over a list of category titles and use the generated <code class="inline">create_category/1</code> function of our catalog context to persist the new records. We can run the seeds with <a href="https://hexdocs.pm/mix/Mix.Tasks.Run.html"><code class="inline">mix run</code></a>:</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix run priv/repo/seeds.exs
</span><span class="">
</span><span class="">[debug] QUERY OK db=3.1ms decode=1.1ms queue=0.7ms idle=2.2ms
</span><span class="">INSERT INTO &quot;categories&quot; (&quot;title&quot;,&quot;inserted_at&quot;,&quot;updated_at&quot;) VALUES ($1,$2,$3) RETURNING &quot;id&quot; [&quot;Home Improvement&quot;, ~N[2021-02-03 19:39:53], ~N[2021-02-03 19:39:53]]
</span><span class="">[debug] QUERY OK db=1.2ms queue=1.3ms idle=12.3ms
</span><span class="">INSERT INTO &quot;categories&quot; (&quot;title&quot;,&quot;inserted_at&quot;,&quot;updated_at&quot;) VALUES ($1,$2,$3) RETURNING &quot;id&quot; [&quot;Power Tools&quot;, ~N[2021-02-03 19:39:53], ~N[2021-02-03 19:39:53]]
</span><span class="">[debug] QUERY OK db=1.1ms queue=1.1ms idle=15.1ms
</span><span class="">INSERT INTO &quot;categories&quot; (&quot;title&quot;,&quot;inserted_at&quot;,&quot;updated_at&quot;) VALUES ($1,$2,$3) RETURNING &quot;id&quot; [&quot;Gardening&quot;, ~N[2021-02-03 19:39:53], ~N[2021-02-03 19:39:53]]
</span><span class="">[debug] QUERY OK db=2.4ms queue=1.0ms idle=17.6ms
</span><span class="">INSERT INTO &quot;categories&quot; (&quot;title&quot;,&quot;inserted_at&quot;,&quot;updated_at&quot;) VALUES ($1,$2,$3) RETURNING &quot;id&quot; [&quot;Books&quot;, ~N[2021-02-03 19:39:53], ~N[2021-02-03 19:39:53]]
</span></code></pre><p>Perfect. Before we integrate categories in the web layer, we need to let our context know how to associate products and categories. First, open up <code class="inline">lib/hello/catalog/product.ex</code> and add the following association:</p><pre><code class="makeup diff" translate="no"><span class="gi">+</span><span class="gi"> alias Hello.Catalog.Category
</span><span class="w">
</span><span class="n">  schema &quot;products&quot; do
</span><span class="n">    field :description, :string
</span><span class="n">    field :price, :decimal
</span><span class="n">    field :title, :string
</span><span class="n">    field :views, :integer
</span><span class="w">
</span><span class="gi">+</span><span class="gi">   many_to_many :categories, Category, join_through: &quot;product_categories&quot;, on_replace: :delete
</span><span class="w">
</span><span class="n">    timestamps()
</span><span class="n">  end
</span></code></pre><p>We used <a href="https://hexdocs.pm/ecto/3.10.1/Ecto.Schema.html"><code class="inline">Ecto.Schema</code></a>'s <code class="inline">many_to_many</code> macro to let Ecto know how to associate our product to multiple categories through the <code class="inline">&quot;product_categories&quot;</code> join table. We also used the <code class="inline">on_replace: :delete</code> option to declare that any existing join records should be deleted when we are changing our categories.</p><p>With our schema associations set up, we can implement the selection of categories in our product form. To do so, we need to translate the user input of catalog IDs from the front-end to our many-to-many association. Fortunately Ecto makes this a breeze now that our schema is set up. Open up your catalog context and make the following changes:</p><pre><code class="makeup diff" translate="no"><span class="gi">+</span><span class="gi"> alias Hello.Catalog.Category
</span><span class="w">
</span><span class="gd">-</span><span class="gd"> def get_product!(id), do: Repo.get!(Product, id)
</span><span class="gi">+</span><span class="gi"> def get_product!(id) do
</span><span class="gi">+</span><span class="gi">   Product |&gt; Repo.get!(id) |&gt; Repo.preload(:categories)
</span><span class="gi">+</span><span class="gi"> end
</span><span class="w">
</span><span class="n">  def create_product(attrs \\ %{}) do
</span><span class="n">    %Product{}
</span><span class="gd">-</span><span class="gd">   |&gt; Product.changeset(attrs)
</span><span class="gi">+</span><span class="gi">   |&gt; change_product(attrs)
</span><span class="n">    |&gt; Repo.insert()
</span><span class="n">  end
</span><span class="w">
</span><span class="n">  def update_product(%Product{} = product, attrs) do
</span><span class="n">    product
</span><span class="gd">-</span><span class="gd">   |&gt; Product.changeset(attrs)
</span><span class="gi">+</span><span class="gi">   |&gt; change_product(attrs)
</span><span class="n">    |&gt; Repo.update()
</span><span class="n">  end
</span><span class="w">
</span><span class="n">  def change_product(%Product{} = product, attrs \\ %{}) do
</span><span class="gd">-</span><span class="gd">   Product.changeset(product, attrs)
</span><span class="gi">+</span><span class="gi">   categories = list_categories_by_id(attrs[&quot;category_ids&quot;])
</span><span class="w">
</span><span class="gi">+</span><span class="gi">   product
</span><span class="gi">+</span><span class="gi">   |&gt; Repo.preload(:categories)
</span><span class="gi">+</span><span class="gi">   |&gt; Product.changeset(attrs)
</span><span class="gi">+</span><span class="gi">   |&gt; Ecto.Changeset.put_assoc(:categories, categories)
</span><span class="n">  end
</span><span class="w">
</span><span class="gi">+</span><span class="gi"> def list_categories_by_id(nil), do: []
</span><span class="gi">+</span><span class="gi"> def list_categories_by_id(category_ids) do
</span><span class="gi">+</span><span class="gi">   Repo.all(from c in Category, where: c.id in ^category_ids)
</span><span class="gi">+</span><span class="gi"> end</span></code></pre><p>First, we added <code class="inline">Repo.preload</code> to preload our categories when we fetch a product. This will allow us to reference <code class="inline">product.categories</code> in our controllers, templates, and anywhere else we want to make use of category information. Next, we modified our <code class="inline">create_product</code> and <code class="inline">update_product</code> functions to call into our existing <code class="inline">change_product</code> function to produce a changeset. Within <code class="inline">change_product</code> we added a lookup to find all categories if the <code class="inline">&quot;category_ids&quot;</code> attribute is present. Then we preloaded categories and called <code class="inline">Ecto.Changeset.put_assoc</code> to place the fetched categories into the changeset. Finally, we implemented the <code class="inline">list_categories_by_id/1</code> function to query the categories matching the category IDs, or return an empty list if no <code class="inline">&quot;category_ids&quot;</code> attribute is present. Now our <code class="inline">create_product</code> and <code class="inline">update_product</code> functions receive a changeset with the category associations all ready to go once we attempt an insert or update against our repo.</p><p>Next, let's expose our new feature to the web by adding the category input to our product form. To keep our form template tidy, let's write a new function to wrap up the details of rendering a category select input for our product. Open up your <code class="inline">ProductHTML</code> view in <code class="inline">lib/hello_web/controllers/product_html.ex</code> and key this in:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">category_opts</span><span class="p" data-group-id="1486239379-1">(</span><span class="n">changeset</span><span class="p" data-group-id="1486239379-1">)</span><span class="w"> </span><span class="k" data-group-id="1486239379-2">do</span><span class="w">
    </span><span class="n">existing_ids</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">changeset</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">get_change</span><span class="p" data-group-id="1486239379-3">(</span><span class="ss">:categories</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1486239379-4">[</span><span class="p" data-group-id="1486239379-4">]</span><span class="p" data-group-id="1486239379-3">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="1486239379-5">(</span><span class="o">&amp;</span><span class="w"> </span><span class="ni">&amp;1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="1486239379-5">)</span><span class="w">

    </span><span class="k">for</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Hello.Catalog</span><span class="o">.</span><span class="n">list_categories</span><span class="p" data-group-id="1486239379-6">(</span><span class="p" data-group-id="1486239379-6">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1486239379-7">[</span><span class="ss">key</span><span class="p">:</span><span class="w"> </span><span class="n">cat</span><span class="o">.</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="n">cat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="ss">selected</span><span class="p">:</span><span class="w"> </span><span class="n">cat</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">existing_ids</span><span class="p" data-group-id="1486239379-7">]</span><span class="w">
  </span><span class="k" data-group-id="1486239379-2">end</span></code></pre><p>We added a new <code class="inline">category_opts/1</code> function which generates the select options for a multiple select tag we will add soon. We calculated the existing category IDs from our changeset, then used those values when we generate the select options for the input tag. We did this by enumerating over all of our categories and returning the appropriate <code class="inline">key</code>, <code class="inline">value</code>, and <code class="inline">selected</code> values. We marked an option as selected if the category ID was found in those category IDs in our changeset.</p><p>With our <code class="inline">category_opts</code> function in place, we can open up <code class="inline">lib/hello_web/controllers/product_html/product_form.html.heex</code> and add:</p><pre><code class="makeup diff" translate="no"><span class="n">  ...
</span><span class="n">  &lt;.input field={f[:views]} type=&quot;number&quot; label=&quot;Views&quot; /&gt;
</span><span class="w">
</span><span class="gi">+</span><span class="gi"> &lt;.input field={f[:category_ids]} type=&quot;select&quot; multiple={true} options={category_opts(@changeset)} /&gt;
</span><span class="w">
</span><span class="n">  &lt;:actions&gt;
</span><span class="n">    &lt;.button&gt;Save Product&lt;/.button&gt;
</span><span class="n">  &lt;/:actions&gt;</span></code></pre><p>We added a <code class="inline">category_select</code> above our save button. Now let's try it out. Next, let's show the product's categories in the product show template. Add the following code to the list in <code class="inline">lib/hello_web/controllers/product_html/show.html.heex</code>:</p><pre><code class="makeup heex" translate="no"><span class="p">&lt;</span><span class="nt">.list</span><span class="p">&gt;</span><span class="w">
</span><span class="n">  ...
</span><span class="n">+ </span><span class="p">&lt;</span><span class="nt">:item</span><span class="w"> </span><span class="ni">title</span><span class="p">=</span><span class="p">&quot;</span><span class="s2">Categories</span><span class="p">&quot;</span><span class="p">&gt;</span><span class="w">
</span><span class="n">+   </span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span><span class="w">
</span><span class="n">+     </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="ni">:for</span><span class="p">=</span><span class="p" data-group-id="3374398981-1">{</span><span class="n">cat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="na">@product</span><span class="o">.</span><span class="n">categories</span><span class="p" data-group-id="3374398981-1">}</span><span class="p">&gt;</span><span class="p" data-group-id="3374398981-2">{</span><span class="n">cat</span><span class="o">.</span><span class="n">title</span><span class="p" data-group-id="3374398981-2">}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span><span class="w">
</span><span class="n">+   </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span><span class="w">
</span><span class="n">+ </span><span class="p">&lt;/</span><span class="nt">:item</span><span class="p">&gt;</span><span class="w">
</span><span class="p">&lt;/</span><span class="nt">.list</span><span class="p">&gt;</span></code></pre><p>Now if we start the server with <a href="Mix.Tasks.Phx.Server.xhtml"><code class="inline">mix phx.server</code></a> and visit <a href="http://localhost:4000/products/new">http://localhost:4000/products/new</a>, we'll see the new category multiple select input. Enter some valid product details, select a category or two, and click save.</p><pre><code class="text">Title: Elixir Flashcards
Description: Flash card set for the Elixir programming language
Price: 5.000000
Views: 0
Categories:
Education
Books</code></pre><p>It's not much to look at yet, but it works! We added relationships within our context complete with data integrity enforced by the database. Not bad. Let's keep building!</p><h2 id="cross-context-dependencies" class="section-heading">
  <a href="#cross-context-dependencies" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Cross-context dependencies</span>
</h2>
<p>Now that we have the beginnings of our product catalog features, let's begin to work on the other main features of our application – carting products from the catalog. In order to properly track products that have been added to a user's cart, we'll need a new place to persist this information, along with point-in-time product information like the price at time of carting. This is necessary so we can detect product price changes in the future. We know what we need to build, but now we need to decide where the cart functionality lives in our application.</p><p>If we take a step back and think about the isolation of our application, the exhibition of products in our catalog distinctly differs from the responsibilities of managing a user's cart. A product catalog shouldn't care about the rules of our shopping cart system, and vice-versa. There's a clear need here for a separate context to handle the new cart responsibilities. Let's call it <code class="inline">ShoppingCart</code>.</p><p>Let's create a <code class="inline">ShoppingCart</code> context to handle basic cart duties. Before we write code, let's imagine we have the following feature requirements:</p><ol><li>Add products to a user's cart from the product show page</li><li>Store point-in-time product price information at time of carting</li><li>Store and update quantities in cart</li><li>Calculate and display sum of cart prices</li></ol><p>From the description, it's clear we need a <code class="inline">Cart</code> resource for storing the user's cart, along with a <code class="inline">CartItem</code> to track products in the cart. With our plan set, let's get to work. Run the following command to generate our new context:</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix phx.gen.context ShoppingCart Cart carts user_uuid:uuid:unique
</span><span class="">
</span><span class="">* creating lib/hello/shopping_cart/cart.ex
</span><span class="">* creating priv/repo/migrations/20210205203128_create_carts.exs
</span><span class="">* creating lib/hello/shopping_cart.ex
</span><span class="">* injecting lib/hello/shopping_cart.ex
</span><span class="">* creating test/hello/shopping_cart_test.exs
</span><span class="">* injecting test/hello/shopping_cart_test.exs
</span><span class="">* creating test/support/fixtures/shopping_cart_fixtures.ex
</span><span class="">* injecting test/support/fixtures/shopping_cart_fixtures.ex
</span><span class="">
</span><span class="">Some of the generated database columns are unique. Please provide
</span><span class="">unique implementations for the following fixture function(s) in
</span><span class="">test/support/fixtures/shopping_cart_fixtures.ex:
</span><span class="">
</span><span class="">    def unique_cart_user_uuid do
</span><span class="">      raise &quot;implement the logic to generate a unique cart user_uuid&quot;
</span><span class="">    end
</span><span class="">
</span><span class="">Remember to update your repository by running migrations:
</span><span class="">
</span><span class="">    $ mix ecto.migrate
</span></code></pre><p>We generated our new context <code class="inline">ShoppingCart</code>, with a new <code class="inline">ShoppingCart.Cart</code> schema to tie a user to their cart which holds cart items. We don't have real users yet, so for now our cart will be tracked by an anonymous user UUID that we'll add to our plug session in a moment. With our cart in place, let's generate our cart items:</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix phx.gen.context ShoppingCart CartItem cart_items \
</span><span class="">cart_id:references:carts product_id:references:products \
</span><span class="">price_when_carted:decimal quantity:integer
</span><span class="">
</span><span class="">You are generating into an existing context.
</span><span class="">...
</span><span class="">Would you like to proceed? [Yn] y
</span><span class="">* creating lib/hello/shopping_cart/cart_item.ex
</span><span class="">* creating priv/repo/migrations/20210205213410_create_cart_items.exs
</span><span class="">* injecting lib/hello/shopping_cart.ex
</span><span class="">* injecting test/hello/shopping_cart_test.exs
</span><span class="">* injecting test/support/fixtures/shopping_cart_fixtures.ex
</span><span class="">
</span><span class="">Remember to update your repository by running migrations:
</span><span class="">
</span><span class="">    $ mix ecto.migrate
</span><span class="">
</span></code></pre><p>We generated a new resource inside our <code class="inline">ShoppingCart</code> named <code class="inline">CartItem</code>. This schema and table will hold references to a cart and product, along with the price at the time we added the item to our cart, and the quantity the user wishes to purchase. Let's touch up the generated migration file in <code class="inline">priv/repo/migrations/*_create_cart_items.ex</code>:</p><pre><code class="makeup elixir" translate="no"><span class="w">    </span><span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="7299622507-1">(</span><span class="ss">:cart_items</span><span class="p" data-group-id="7299622507-1">)</span><span class="w"> </span><span class="k" data-group-id="7299622507-2">do</span><span class="w">
</span><span class="o">-</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:price_when_carted</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:price_when_carted</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="p">,</span><span class="w"> </span><span class="ss">precision</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="ss">scale</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="ss">null</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:quantity</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
</span><span class="o">-</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:cart_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="7299622507-3">(</span><span class="ss">:carts</span><span class="p">,</span><span class="w"> </span><span class="ss">on_delete</span><span class="p">:</span><span class="w"> </span><span class="ss">:nothing</span><span class="p" data-group-id="7299622507-3">)</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:cart_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="7299622507-4">(</span><span class="ss">:carts</span><span class="p">,</span><span class="w"> </span><span class="ss">on_delete</span><span class="p">:</span><span class="w"> </span><span class="ss">:delete_all</span><span class="p" data-group-id="7299622507-4">)</span><span class="w">
</span><span class="o">-</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:product_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="7299622507-5">(</span><span class="ss">:products</span><span class="p">,</span><span class="w"> </span><span class="ss">on_delete</span><span class="p">:</span><span class="w"> </span><span class="ss">:nothing</span><span class="p" data-group-id="7299622507-5">)</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:product_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="7299622507-6">(</span><span class="ss">:products</span><span class="p">,</span><span class="w"> </span><span class="ss">on_delete</span><span class="p">:</span><span class="w"> </span><span class="ss">:delete_all</span><span class="p" data-group-id="7299622507-6">)</span><span class="w">

      </span><span class="n">timestamps</span><span class="p" data-group-id="7299622507-7">(</span><span class="p" data-group-id="7299622507-7">)</span><span class="w">
    </span><span class="k" data-group-id="7299622507-2">end</span><span class="w">

</span><span class="o">-</span><span class="w">   </span><span class="n">create</span><span class="w"> </span><span class="n">index</span><span class="p" data-group-id="7299622507-8">(</span><span class="ss">:cart_items</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7299622507-9">[</span><span class="ss">:cart_id</span><span class="p" data-group-id="7299622507-9">]</span><span class="p" data-group-id="7299622507-8">)</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="n">index</span><span class="p" data-group-id="7299622507-10">(</span><span class="ss">:cart_items</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7299622507-11">[</span><span class="ss">:product_id</span><span class="p" data-group-id="7299622507-11">]</span><span class="p" data-group-id="7299622507-10">)</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">create</span><span class="w"> </span><span class="n">unique_index</span><span class="p" data-group-id="7299622507-12">(</span><span class="ss">:cart_items</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7299622507-13">[</span><span class="ss">:cart_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:product_id</span><span class="p" data-group-id="7299622507-13">]</span><span class="p" data-group-id="7299622507-12">)</span></code></pre><p>We used the <code class="inline">:delete_all</code> strategy again to enforce data integrity. This way, when a cart or product is deleted from the application, we don't have to rely on application code in our <code class="inline">ShoppingCart</code> or <code class="inline">Catalog</code> contexts to worry about cleaning up the records. This keeps our application code decoupled and the data integrity enforcement where it belongs – in the database. We also added a unique constraint to ensure a duplicate product is not allowed to be added to a cart. As with the <code class="inline">product_categories</code> table, using a multi-column index lets us remove the separate index for the leftmost field (<code class="inline">cart_id</code>). With our database tables in place, we can now migrate up:</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix ecto.migrate
</span><span class="">
</span><span class="">16:59:51.941 [info] == Running 20210205203342 Hello.Repo.Migrations.CreateCarts.change/0 forward
</span><span class="">
</span><span class="">16:59:51.945 [info] create table carts
</span><span class="">
</span><span class="">16:59:51.949 [info] create index carts_user_uuid_index
</span><span class="">
</span><span class="">16:59:51.952 [info] == Migrated 20210205203342 in 0.0s
</span><span class="">
</span><span class="">16:59:51.988 [info] == Running 20210205213410 Hello.Repo.Migrations.CreateCartItems.change/0 forward
</span><span class="">
</span><span class="">16:59:51.988 [info] create table cart_items
</span><span class="">
</span><span class="">16:59:51.998 [info] create index cart_items_cart_id_index
</span><span class="">
</span><span class="">16:59:52.000 [info] create index cart_items_product_id_index
</span><span class="">
</span><span class="">16:59:52.001 [info] create index cart_items_cart_id_product_id_index
</span><span class="">
</span><span class="">16:59:52.002 [info] == Migrated 20210205213410 in 0.0s
</span></code></pre><p>Our database is ready to go with new <code class="inline">carts</code> and <code class="inline">cart_items</code> tables, but now we need to map that back into application code. You may be wondering how we can mix database foreign keys across different tables and how that relates to the context pattern of isolated, grouped functionality. Let's jump in and discuss the approaches and their tradeoffs.</p><h3 id="cross-context-data" class="section-heading">
  <a href="#cross-context-data" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Cross-context data</span>
</h3>
<p>So far, we've done a great job isolating the two main contexts of our application from each other, but now we have a necessary dependency to handle.</p><p>Our <code class="inline">Catalog.Product</code> resource serves to keep the responsibilities of representing a product inside the catalog, but ultimately for an item to exist in the cart, a product from the catalog must be present. Given this, our <code class="inline">ShoppingCart</code> context will have a data dependency on the <code class="inline">Catalog</code> context. With that in mind, we have two options. One is to expose APIs on the <code class="inline">Catalog</code> context that allows us to efficiently fetch product data for use in the <code class="inline">ShoppingCart</code> system, which we would manually stitch together. Or we can use database joins to fetch the dependent data. Both are valid options given your tradeoffs and application size, but joining data from the database when you have a hard data dependency is just fine for a large class of applications and is the approach we will take here.</p><p>Now that we know where our data dependencies exist, let's add our schema associations so we can tie shopping cart items to products. First, let's make a quick change to our cart schema in <code class="inline">lib/hello/shopping_cart/cart.ex</code> to associate a cart to its items:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;carts&quot;</span><span class="w"> </span><span class="k" data-group-id="8705768058-1">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:user_uuid</span><span class="p">,</span><span class="w"> </span><span class="nc">Ecto.UUID</span><span class="w">

</span><span class="o">+</span><span class="w">   </span><span class="n">has_many</span><span class="w"> </span><span class="ss">:items</span><span class="p">,</span><span class="w"> </span><span class="nc">Hello.ShoppingCart.CartItem</span><span class="w">

    </span><span class="n">timestamps</span><span class="p" data-group-id="8705768058-2">(</span><span class="p" data-group-id="8705768058-2">)</span><span class="w">
  </span><span class="k" data-group-id="8705768058-1">end</span></code></pre><p>Now that our cart is associated to the items we place in it, let's set up the cart item associations inside <code class="inline">lib/hello/shopping_cart/cart_item.ex</code>:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;cart_items&quot;</span><span class="w"> </span><span class="k" data-group-id="3742191444-1">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:price_when_carted</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:quantity</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="n">field</span><span class="w"> </span><span class="ss">:cart_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:id</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="n">field</span><span class="w"> </span><span class="ss">:product_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:id</span><span class="w">

</span><span class="o">+</span><span class="w">   </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:cart</span><span class="p">,</span><span class="w"> </span><span class="nc">Hello.ShoppingCart.Cart</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:product</span><span class="p">,</span><span class="w"> </span><span class="nc">Hello.Catalog.Product</span><span class="w">

    </span><span class="n">timestamps</span><span class="p" data-group-id="3742191444-2">(</span><span class="p" data-group-id="3742191444-2">)</span><span class="w">
  </span><span class="k" data-group-id="3742191444-1">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="no">false</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">changeset</span><span class="p" data-group-id="3742191444-3">(</span><span class="n">cart_item</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="3742191444-3">)</span><span class="w"> </span><span class="k" data-group-id="3742191444-4">do</span><span class="w">
    </span><span class="n">cart_item</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">cast</span><span class="p" data-group-id="3742191444-5">(</span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3742191444-6">[</span><span class="ss">:price_when_carted</span><span class="p">,</span><span class="w"> </span><span class="ss">:quantity</span><span class="p" data-group-id="3742191444-6">]</span><span class="p" data-group-id="3742191444-5">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">validate_required</span><span class="p" data-group-id="3742191444-7">(</span><span class="p" data-group-id="3742191444-8">[</span><span class="ss">:price_when_carted</span><span class="p">,</span><span class="w"> </span><span class="ss">:quantity</span><span class="p" data-group-id="3742191444-8">]</span><span class="p" data-group-id="3742191444-7">)</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">validate_number</span><span class="p" data-group-id="3742191444-9">(</span><span class="ss">:quantity</span><span class="p">,</span><span class="w"> </span><span class="ss">greater_than_or_equal_to</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">less_than</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p" data-group-id="3742191444-9">)</span><span class="w">
  </span><span class="k" data-group-id="3742191444-4">end</span></code></pre><p>First, we replaced the <code class="inline">cart_id</code> field with a standard <code class="inline">belongs_to</code> pointing at our <code class="inline">ShoppingCart.Cart</code> schema. Next, we replaced our <code class="inline">product_id</code> field by adding our first cross-context data dependency with a <code class="inline">belongs_to</code> for the <code class="inline">Catalog.Product</code> schema. Here, we intentionally coupled the data boundaries because it provides exactly what we need: an isolated context API with the bare minimum knowledge necessary to reference a product in our system. Next, we added a new validation to our changeset. With <code class="inline">validate_number/3</code>, we ensure any quantity provided by user input is between 0 and 100.</p><p>With our schemas in place, we can start integrating the new data structures and <code class="inline">ShoppingCart</code> context APIs into our web-facing features.</p><h3 id="adding-shopping-cart-functions" class="section-heading">
  <a href="#adding-shopping-cart-functions" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Adding Shopping Cart functions</span>
</h3>
<p>As we mentioned before, the context generators are only a starting point for our application. We can and should write well-named, purpose built functions to accomplish the goals of our context. We have a few new features to implement. First, we need to ensure every user of our application is granted a cart if one does not yet exist. From there, we can then allow users to add items to their cart, update item quantities, and calculate cart totals. Let's get started!</p><p>We won't focus on a real user authentication system at this point, but by the time we're done, you'll be able to naturally integrate one with what we've written here. To simulate a current user session, open up your <code class="inline">lib/hello_web/router.ex</code> and key this in:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="n">pipeline</span><span class="w"> </span><span class="ss">:browser</span><span class="w"> </span><span class="k" data-group-id="5144212179-1">do</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:accepts</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5144212179-2">[</span><span class="s">&quot;html&quot;</span><span class="p" data-group-id="5144212179-2">]</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:fetch_session</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:fetch_live_flash</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:put_root_layout</span><span class="p">,</span><span class="w"> </span><span class="ss">html</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5144212179-3">{</span><span class="nc">HelloWeb.LayoutView</span><span class="p">,</span><span class="w"> </span><span class="ss">:root</span><span class="p" data-group-id="5144212179-3">}</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:protect_from_forgery</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:put_secure_browser_headers</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">plug</span><span class="w"> </span><span class="ss">:fetch_current_user</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">plug</span><span class="w"> </span><span class="ss">:fetch_current_cart</span><span class="w">
  </span><span class="k" data-group-id="5144212179-1">end</span><span class="w">

</span><span class="o">+</span><span class="w"> </span><span class="kd">defp</span><span class="w"> </span><span class="nf">fetch_current_user</span><span class="p" data-group-id="5144212179-4">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="5144212179-4">)</span><span class="w"> </span><span class="k" data-group-id="5144212179-5">do</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="n">user_uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_session</span><span class="p" data-group-id="5144212179-6">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:current_uuid</span><span class="p" data-group-id="5144212179-6">)</span><span class="w"> </span><span class="k" data-group-id="5144212179-7">do</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">assign</span><span class="p" data-group-id="5144212179-8">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:current_uuid</span><span class="p">,</span><span class="w"> </span><span class="n">user_uuid</span><span class="p" data-group-id="5144212179-8">)</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="k" data-group-id="5144212179-7">else</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">new_uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ecto.UUID</span><span class="o">.</span><span class="n">generate</span><span class="p" data-group-id="5144212179-9">(</span><span class="p" data-group-id="5144212179-9">)</span><span class="w">
</span><span class="o">+</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">conn</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="5144212179-10">(</span><span class="ss">:current_uuid</span><span class="p">,</span><span class="w"> </span><span class="n">new_uuid</span><span class="p" data-group-id="5144212179-10">)</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_session</span><span class="p" data-group-id="5144212179-11">(</span><span class="ss">:current_uuid</span><span class="p">,</span><span class="w"> </span><span class="n">new_uuid</span><span class="p" data-group-id="5144212179-11">)</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="k" data-group-id="5144212179-7">end</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="k" data-group-id="5144212179-5">end</span><span class="w">

</span><span class="o">+</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.ShoppingCart</span><span class="w">
</span><span class="o">+</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="kd">defp</span><span class="w"> </span><span class="nf">fetch_current_cart</span><span class="p" data-group-id="5144212179-12">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="c">_opts</span><span class="p" data-group-id="5144212179-12">)</span><span class="w"> </span><span class="k" data-group-id="5144212179-13">do</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="n">cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ShoppingCart</span><span class="o">.</span><span class="n">get_cart_by_user_uuid</span><span class="p" data-group-id="5144212179-14">(</span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">current_uuid</span><span class="p" data-group-id="5144212179-14">)</span><span class="w"> </span><span class="k" data-group-id="5144212179-15">do</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">assign</span><span class="p" data-group-id="5144212179-16">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:cart</span><span class="p">,</span><span class="w"> </span><span class="n">cart</span><span class="p" data-group-id="5144212179-16">)</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="k" data-group-id="5144212179-15">else</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="p" data-group-id="5144212179-17">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">new_cart</span><span class="p" data-group-id="5144212179-17">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ShoppingCart</span><span class="o">.</span><span class="n">create_cart</span><span class="p" data-group-id="5144212179-18">(</span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">current_uuid</span><span class="p" data-group-id="5144212179-18">)</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">assign</span><span class="p" data-group-id="5144212179-19">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:cart</span><span class="p">,</span><span class="w"> </span><span class="n">new_cart</span><span class="p" data-group-id="5144212179-19">)</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="k" data-group-id="5144212179-15">end</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="k" data-group-id="5144212179-13">end</span></code></pre><p>We added a new <code class="inline">:fetch_current_user</code> and <code class="inline">:fetch_current_cart</code> plug to our browser pipeline to run on all browser-based requests. Next, we implemented the <code class="inline">fetch_current_user</code> plug which simply checks the session for a user UUID that was previously added. If we find one, we add a <code class="inline">current_uuid</code> assign to the connection and we're done. In the case we haven't yet identified this visitor, we generate a unique UUID with <code class="inline">Ecto.UUID.generate()</code>, then we place that value in the <code class="inline">current_uuid</code> assign, along with a new session value to identify this visitor on future requests. A random, unique ID isn't much to represent a user, but it's enough for us to track and identify a visitor across requests, which is all we need for now. Later as our application becomes more complete, you'll be ready to migrate to a complete user authentication solution. With a guaranteed current user, we then implemented the <code class="inline">fetch_current_cart</code> plug which either finds a cart for the user UUID or creates a cart for the current user and assigns the result in the connection assigns. We'll need to implement our <code class="inline">ShoppingCart.get_cart_by_user_uuid/1</code> and modify the create cart function to accept a UUID, but let's add our routes first.</p><p>We'll need to implement a cart controller for handling cart operations like viewing a cart, updating quantities, and initiating the checkout process, as well as a cart items controller for adding and removing individual items to and from the cart. Add the following routes to your router in <code class="inline">lib/hello_web/router.ex</code>:</p><pre><code class="makeup diff" translate="no"><span class="n">  scope &quot;/&quot;, HelloWeb do
</span><span class="n">    pipe_through :browser
</span><span class="w">
</span><span class="n">    get &quot;/&quot;, PageController, :index
</span><span class="n">    resources &quot;/products&quot;, ProductController
</span><span class="w">
</span><span class="gi">+</span><span class="gi">   resources &quot;/cart_items&quot;, CartItemController, only: [:create, :delete]
</span><span class="w">
</span><span class="gi">+</span><span class="gi">   get &quot;/cart&quot;, CartController, :show
</span><span class="gi">+</span><span class="gi">   put &quot;/cart&quot;, CartController, :update
</span><span class="n">  end</span></code></pre><p>We added a <code class="inline">resources</code> declaration for a <code class="inline">CartItemController</code>, which will wire up the routes for a create and delete action for adding and removing individual cart items. Next, we added two new routes pointing at a <code class="inline">CartController</code>. The first route, a GET request, will map to our show action, to show the cart contents. The second route, a PUT request, will handle the submission of a form for updating our cart quantities.</p><p>With our routes in place, let's add the ability to add an item to our cart from the product show page. Create a new file at <code class="inline">lib/hello_web/controllers/cart_item_controller.ex</code> and key this in:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.CartItemController</span><span class="w"> </span><span class="k" data-group-id="1342610745-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:controller</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.ShoppingCart</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create</span><span class="p" data-group-id="1342610745-2">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1342610745-3">%{</span><span class="s">&quot;product_id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">product_id</span><span class="p" data-group-id="1342610745-3">}</span><span class="p" data-group-id="1342610745-2">)</span><span class="w"> </span><span class="k" data-group-id="1342610745-4">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">ShoppingCart</span><span class="o">.</span><span class="n">add_item_to_cart</span><span class="p" data-group-id="1342610745-5">(</span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">cart</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p" data-group-id="1342610745-5">)</span><span class="w"> </span><span class="k" data-group-id="1342610745-6">do</span><span class="w">
      </span><span class="p" data-group-id="1342610745-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="c">_item</span><span class="p" data-group-id="1342610745-7">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="1342610745-8">(</span><span class="ss">:info</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Item added to your cart&quot;</span><span class="p" data-group-id="1342610745-8">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="1342610745-9">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="sx">~p&quot;/cart&quot;</span><span class="p" data-group-id="1342610745-9">)</span><span class="w">

      </span><span class="p" data-group-id="1342610745-10">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="c">_changeset</span><span class="p" data-group-id="1342610745-10">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="1342610745-11">(</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;There was an error adding the item to your cart&quot;</span><span class="p" data-group-id="1342610745-11">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="1342610745-12">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="sx">~p&quot;/cart&quot;</span><span class="p" data-group-id="1342610745-12">)</span><span class="w">
    </span><span class="k" data-group-id="1342610745-6">end</span><span class="w">
  </span><span class="k" data-group-id="1342610745-4">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">delete</span><span class="p" data-group-id="1342610745-13">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1342610745-14">%{</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">product_id</span><span class="p" data-group-id="1342610745-14">}</span><span class="p" data-group-id="1342610745-13">)</span><span class="w"> </span><span class="k" data-group-id="1342610745-15">do</span><span class="w">
    </span><span class="p" data-group-id="1342610745-16">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="c">_cart</span><span class="p" data-group-id="1342610745-16">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ShoppingCart</span><span class="o">.</span><span class="n">remove_item_from_cart</span><span class="p" data-group-id="1342610745-17">(</span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">cart</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p" data-group-id="1342610745-17">)</span><span class="w">
    </span><span class="n">redirect</span><span class="p" data-group-id="1342610745-18">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="sx">~p&quot;/cart&quot;</span><span class="p" data-group-id="1342610745-18">)</span><span class="w">
  </span><span class="k" data-group-id="1342610745-15">end</span><span class="w">
</span><span class="k" data-group-id="1342610745-1">end</span></code></pre><p>We defined a new <code class="inline">CartItemController</code> with the create and delete actions that we declared in our router. For <code class="inline">create</code>, we call a <code class="inline">ShoppingCart.add_item_to_cart/2</code> function which we'll implement in a moment. If successful, we show a flash successful message and redirect to the cart show page; else, we show a flash error message and redirect to the cart show page. For <code class="inline">delete</code>, we'll call a <code class="inline">remove_item_from_cart</code> function which we'll implement on our <code class="inline">ShoppingCart</code> context  and then redirect back to the cart show page. We haven't implemented these two shopping cart functions yet, but notice how their names scream their intent: <code class="inline">add_item_to_cart</code> and <code class="inline">remove_item_from_cart</code> make it obvious what we are accomplishing here. It also allows us to spec out our web layer and context APIs without thinking about all the implementation details at once.</p><p>Let's implement the new interface for the <code class="inline">ShoppingCart</code> context API in <code class="inline">lib/hello/shopping_cart.ex</code>:</p><pre><code class="makeup elixir" translate="no"><span class="o">+</span><span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Catalog</span><span class="w">
</span><span class="o">-</span><span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.ShoppingCart.Cart</span><span class="w">
</span><span class="o">+</span><span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.ShoppingCart</span><span class="o">.</span><span class="p" data-group-id="3236429946-1">{</span><span class="nc">Cart</span><span class="p">,</span><span class="w"> </span><span class="nc">CartItem</span><span class="p" data-group-id="3236429946-1">}</span><span class="w">

</span><span class="o">+</span><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">get_cart_by_user_uuid</span><span class="p" data-group-id="3236429946-2">(</span><span class="n">user_uuid</span><span class="p" data-group-id="3236429946-2">)</span><span class="w"> </span><span class="k" data-group-id="3236429946-3">do</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="nc">Repo</span><span class="o">.</span><span class="n">one</span><span class="p" data-group-id="3236429946-4">(</span><span class="w">
</span><span class="o">+</span><span class="w">      </span><span class="n">from</span><span class="p" data-group-id="3236429946-5">(</span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Cart</span><span class="p">,</span><span class="w">
</span><span class="o">+</span><span class="w">        </span><span class="ss">where</span><span class="p">:</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">user_uuid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">user_uuid</span><span class="p">,</span><span class="w">
</span><span class="o">+</span><span class="w">        </span><span class="ss">left_join</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">assoc</span><span class="p" data-group-id="3236429946-6">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="ss">:items</span><span class="p" data-group-id="3236429946-6">)</span><span class="p">,</span><span class="w">
</span><span class="o">+</span><span class="w">        </span><span class="ss">left_join</span><span class="p">:</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">assoc</span><span class="p" data-group-id="3236429946-7">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="ss">:product</span><span class="p" data-group-id="3236429946-7">)</span><span class="p">,</span><span class="w">
</span><span class="o">+</span><span class="w">        </span><span class="ss">order_by</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3236429946-8">[</span><span class="ss">asc</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="o">.</span><span class="n">inserted_at</span><span class="p" data-group-id="3236429946-8">]</span><span class="p">,</span><span class="w">
</span><span class="o">+</span><span class="w">        </span><span class="ss">preload</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3236429946-9">[</span><span class="ss">items</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3236429946-10">{</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="ss">product</span><span class="p">:</span><span class="w"> </span><span class="n">p</span><span class="p" data-group-id="3236429946-10">}</span><span class="p" data-group-id="3236429946-9">]</span><span class="w">
</span><span class="o">+</span><span class="w">      </span><span class="p" data-group-id="3236429946-5">)</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="p" data-group-id="3236429946-4">)</span><span class="w">
</span><span class="o">+</span><span class="w">  </span><span class="k" data-group-id="3236429946-3">end</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="kd">def</span><span class="w"> </span><span class="nf">create_cart</span><span class="p" data-group-id="3236429946-11">(</span><span class="n">attrs</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="3236429946-12">%{</span><span class="p" data-group-id="3236429946-12">}</span><span class="p" data-group-id="3236429946-11">)</span><span class="w"> </span><span class="k" data-group-id="3236429946-13">do</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="p" data-group-id="3236429946-14">%</span><span class="nc" data-group-id="3236429946-14">Cart</span><span class="p" data-group-id="3236429946-14">{</span><span class="p" data-group-id="3236429946-14">}</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Cart</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="3236429946-15">(</span><span class="n">attrs</span><span class="p" data-group-id="3236429946-15">)</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="kd">def</span><span class="w"> </span><span class="nf">create_cart</span><span class="p" data-group-id="3236429946-16">(</span><span class="n">user_uuid</span><span class="p" data-group-id="3236429946-16">)</span><span class="w"> </span><span class="k" data-group-id="3236429946-17">do</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="p" data-group-id="3236429946-18">%</span><span class="nc" data-group-id="3236429946-18">Cart</span><span class="p" data-group-id="3236429946-18">{</span><span class="ss">user_uuid</span><span class="p">:</span><span class="w"> </span><span class="n">user_uuid</span><span class="p" data-group-id="3236429946-18">}</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Cart</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="3236429946-19">(</span><span class="p" data-group-id="3236429946-20">%{</span><span class="p" data-group-id="3236429946-20">}</span><span class="p" data-group-id="3236429946-19">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p" data-group-id="3236429946-21">(</span><span class="p" data-group-id="3236429946-21">)</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="o">|&gt;</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="k" data-group-id="3236429946-22">do</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="p" data-group-id="3236429946-23">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">cart</span><span class="p" data-group-id="3236429946-23">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="3236429946-24">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">reload_cart</span><span class="p" data-group-id="3236429946-25">(</span><span class="n">cart</span><span class="p" data-group-id="3236429946-25">)</span><span class="p" data-group-id="3236429946-24">}</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="p" data-group-id="3236429946-26">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="3236429946-26">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="3236429946-27">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="3236429946-27">}</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="k" data-group-id="3236429946-22">end</span><span class="w">
  </span><span class="k" data-group-id="3236429946-17">end</span><span class="w">

</span><span class="o">+</span><span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">reload_cart</span><span class="p" data-group-id="3236429946-28">(</span><span class="p" data-group-id="3236429946-29">%</span><span class="nc" data-group-id="3236429946-29">Cart</span><span class="p" data-group-id="3236429946-29">{</span><span class="p" data-group-id="3236429946-29">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cart</span><span class="p" data-group-id="3236429946-28">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">get_cart_by_user_uuid</span><span class="p" data-group-id="3236429946-30">(</span><span class="n">cart</span><span class="o">.</span><span class="n">user_uuid</span><span class="p" data-group-id="3236429946-30">)</span><span class="w">
</span><span class="o">+</span><span class="w">
</span><span class="o">+</span><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">add_item_to_cart</span><span class="p" data-group-id="3236429946-31">(</span><span class="p" data-group-id="3236429946-32">%</span><span class="nc" data-group-id="3236429946-32">Cart</span><span class="p" data-group-id="3236429946-32">{</span><span class="p" data-group-id="3236429946-32">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cart</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p" data-group-id="3236429946-31">)</span><span class="w"> </span><span class="k" data-group-id="3236429946-33">do</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Catalog</span><span class="o">.</span><span class="n">get_product!</span><span class="p" data-group-id="3236429946-34">(</span><span class="n">product_id</span><span class="p" data-group-id="3236429946-34">)</span><span class="w">
</span><span class="o">+</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="p" data-group-id="3236429946-35">%</span><span class="nc" data-group-id="3236429946-35">CartItem</span><span class="p" data-group-id="3236429946-35">{</span><span class="ss">quantity</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">price_when_carted</span><span class="p">:</span><span class="w"> </span><span class="n">product</span><span class="o">.</span><span class="n">price</span><span class="p" data-group-id="3236429946-35">}</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">CartItem</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="3236429946-36">(</span><span class="p" data-group-id="3236429946-37">%{</span><span class="p" data-group-id="3236429946-37">}</span><span class="p" data-group-id="3236429946-36">)</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">put_assoc</span><span class="p" data-group-id="3236429946-38">(</span><span class="ss">:cart</span><span class="p">,</span><span class="w"> </span><span class="n">cart</span><span class="p" data-group-id="3236429946-38">)</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">put_assoc</span><span class="p" data-group-id="3236429946-39">(</span><span class="ss">:product</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p" data-group-id="3236429946-39">)</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p" data-group-id="3236429946-40">(</span><span class="w">
</span><span class="o">+</span><span class="w">      </span><span class="ss">on_conflict</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3236429946-41">[</span><span class="ss">inc</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3236429946-42">[</span><span class="ss">quantity</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="3236429946-42">]</span><span class="p" data-group-id="3236429946-41">]</span><span class="p">,</span><span class="w">
</span><span class="o">+</span><span class="w">      </span><span class="ss">conflict_target</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3236429946-43">[</span><span class="ss">:cart_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:product_id</span><span class="p" data-group-id="3236429946-43">]</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="p" data-group-id="3236429946-40">)</span><span class="w">
</span><span class="o">+</span><span class="w">  </span><span class="k" data-group-id="3236429946-33">end</span><span class="w">
</span><span class="o">+</span><span class="w">
</span><span class="o">+</span><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">remove_item_from_cart</span><span class="p" data-group-id="3236429946-44">(</span><span class="p" data-group-id="3236429946-45">%</span><span class="nc" data-group-id="3236429946-45">Cart</span><span class="p" data-group-id="3236429946-45">{</span><span class="p" data-group-id="3236429946-45">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cart</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p" data-group-id="3236429946-44">)</span><span class="w"> </span><span class="k" data-group-id="3236429946-46">do</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="p" data-group-id="3236429946-47">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="3236429946-47">}</span><span class="w"> </span><span class="o">=</span><span class="w">
</span><span class="o">+</span><span class="w">      </span><span class="nc">Repo</span><span class="o">.</span><span class="n">delete_all</span><span class="p" data-group-id="3236429946-48">(</span><span class="w">
</span><span class="o">+</span><span class="w">        </span><span class="n">from</span><span class="p" data-group-id="3236429946-49">(</span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">CartItem</span><span class="p">,</span><span class="w">
</span><span class="o">+</span><span class="w">          </span><span class="ss">where</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="o">.</span><span class="n">cart_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">cart</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w">
</span><span class="o">+</span><span class="w">          </span><span class="ss">where</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="o">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">product_id</span><span class="w">
</span><span class="o">+</span><span class="w">        </span><span class="p" data-group-id="3236429946-49">)</span><span class="w">
</span><span class="o">+</span><span class="w">      </span><span class="p" data-group-id="3236429946-48">)</span><span class="w">
</span><span class="o">+</span><span class="w">
</span><span class="o">+</span><span class="w">    </span><span class="p" data-group-id="3236429946-50">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">reload_cart</span><span class="p" data-group-id="3236429946-51">(</span><span class="n">cart</span><span class="p" data-group-id="3236429946-51">)</span><span class="p" data-group-id="3236429946-50">}</span><span class="w">
</span><span class="o">+</span><span class="w">  </span><span class="k" data-group-id="3236429946-46">end</span></code></pre><p>We started by implementing  <code class="inline">get_cart_by_user_uuid/1</code> which fetches our cart and joins the cart items, and their products so that we have the full cart populated with all preloaded data. Next, we modified our <code class="inline">create_cart</code> function to accept a user UUID instead of attributes, which we used to populate the <code class="inline">user_uuid</code> field. If the insert is successful, we reload the cart contents by calling a private <code class="inline">reload_cart/1</code> function, which simply calls <code class="inline">get_cart_by_user_uuid/1</code> to refetch data.</p><p>Next, we wrote our new <code class="inline">add_item_to_cart/2</code> function which accepts a cart struct and a product id. We proceed to fetch the product with <code class="inline">Catalog.get_product!/1</code>, showing how contexts can naturally invoke other contexts if required. You could also have chosen to receive the product as argument and you would achieve similar results. Then we used an upsert operation against our repo to either insert a new cart item into the database, or increase the quantity by one if it already exists in the cart. This is accomplished via the <code class="inline">on_conflict</code> and <code class="inline">conflict_target</code> options, which tells our repo how to handle an insert conflict.</p><p>Finally, we implemented <code class="inline">remove_item_from_cart/2</code> where we simply issue a <code class="inline">Repo.delete_all</code> call with a query to delete the cart item in our cart that matches the product ID. Finally, we reload the cart contents by calling <code class="inline">reload_cart/1</code>.</p><p>With our new cart functions in place, we can now expose the &quot;Add to cart&quot; button on the product catalog show page. Open up your template in <code class="inline">lib/hello_web/controllers/product_html/show.html.heex</code> and make the following changes:</p><pre><code class="makeup diff" translate="no"><span class="n">...
</span><span class="n">     &lt;.link href={~p&quot;/products/#{@product}/edit&quot;}&gt;
</span><span class="n">       &lt;.button&gt;Edit product&lt;/.button&gt;
</span><span class="n">     &lt;/.link&gt;
</span><span class="gi">+</span><span class="gi">    &lt;.link href={~p&quot;/cart_items?product_id=#{@product.id}&quot;} method=&quot;post&quot;&gt;
</span><span class="gi">+</span><span class="gi">      &lt;.button&gt;Add to cart&lt;/.button&gt;
</span><span class="gi">+</span><span class="gi">    &lt;/.link&gt;
</span><span class="n">...</span></code></pre><p>The <code class="inline">link</code> function component from <code class="inline">Phoenix.Component</code> accepts a <code class="inline">:method</code> attribute to issue an HTTP verb when clicked, instead of the default GET request. With this link in place, the &quot;Add to cart&quot; link will issue a POST request, which will be matched by the route we defined in router which dispatches to the <code class="inline">CartItemController.create/2</code> function.</p><p>Let's try it out. Start your server with <a href="Mix.Tasks.Phx.Server.xhtml"><code class="inline">mix phx.server</code></a> and visit a product page. If we try clicking the add to cart link, we'll be greeted by an error page with the following logs in the console:</p><pre><code class="text">[info] POST /cart_items
[debug] Processing with HelloWeb.CartItemController.create/2
  Parameters: %{&quot;_method&quot; =&gt; &quot;post&quot;, &quot;product_id&quot; =&gt; &quot;1&quot;, ...}
  Pipelines: [:browser]
INSERT INTO &quot;cart_items&quot; ...
[info] Sent 302 in 24ms
[info] GET /cart
[debug] Processing with HelloWeb.CartController.show/2
  Parameters: %{}
  Pipelines: [:browser]
[debug] QUERY OK source=&quot;carts&quot; db=1.9ms idle=1798.5ms

[error] #PID&lt;0.856.0&gt; running HelloWeb.Endpoint (connection #PID&lt;0.841.0&gt;, stream id 5) terminated
Server: localhost:4000 (http)
Request: GET /cart
** (exit) an exception was raised:
    ** (UndefinedFunctionError) function HelloWeb.CartController.init/1 is undefined
       (module HelloWeb.CartController is not available)
       ...</code></pre><p>It's working! Kind of. If we follow the logs, we see our POST to the <code class="inline">/cart_items</code> path. Next, we can see our <code class="inline">ShoppingCart.add_item_to_cart</code> function successfully inserted a row into the <code class="inline">cart_items</code> table, and then we issued a redirect to <code class="inline">/cart</code>. Before our error, we also see a query to the <code class="inline">carts</code> table, which means we're fetching the current user's cart. So far so good. We know our <code class="inline">CartItem</code> controller and new <code class="inline">ShoppingCart</code> context functions are doing their jobs, but we've hit our next unimplemented feature when the router attempts to dispatch to a nonexistent cart controller. Let's create the cart controller, view, and template to display and manage user carts.</p><p>Create a new file at <code class="inline">lib/hello_web/controllers/cart_controller.ex</code> and key this in:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.CartController</span><span class="w"> </span><span class="k" data-group-id="6955704973-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:controller</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.ShoppingCart</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">show</span><span class="p" data-group-id="6955704973-2">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="c">_params</span><span class="p" data-group-id="6955704973-2">)</span><span class="w"> </span><span class="k" data-group-id="6955704973-3">do</span><span class="w">
    </span><span class="n">render</span><span class="p" data-group-id="6955704973-4">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:show</span><span class="p">,</span><span class="w"> </span><span class="ss">changeset</span><span class="p">:</span><span class="w"> </span><span class="nc">ShoppingCart</span><span class="o">.</span><span class="n">change_cart</span><span class="p" data-group-id="6955704973-5">(</span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">cart</span><span class="p" data-group-id="6955704973-5">)</span><span class="p" data-group-id="6955704973-4">)</span><span class="w">
  </span><span class="k" data-group-id="6955704973-3">end</span><span class="w">
</span><span class="k" data-group-id="6955704973-1">end</span></code></pre><p>We defined a new cart controller to handle the <code class="inline">get &quot;/cart&quot;</code> route. For showing a cart, we render a <code class="inline">&quot;show.html&quot;</code> template which we'll create in a moment. We know we need to allow the cart items to be changed by quantity updates, so right away we know we'll need a cart changeset. Fortunately, the context generator included a <code class="inline">ShoppingCart.change_cart/1</code> function, which we'll use. We pass it our cart struct which is already in the connection assigns thanks to the <code class="inline">fetch_current_cart</code> plug we defined in the router.</p><p>Next, we can implement the view and template. Create a new view file at <code class="inline">lib/hello_web/controllers/cart_html.ex</code> with the following content:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.CartHTML</span><span class="w"> </span><span class="k" data-group-id="9583637223-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:html</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.ShoppingCart</span><span class="w">

  </span><span class="n">embed_templates</span><span class="w"> </span><span class="s">&quot;cart_html/*&quot;</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">currency_to_str</span><span class="p" data-group-id="9583637223-2">(</span><span class="p" data-group-id="9583637223-3">%</span><span class="nc" data-group-id="9583637223-3">Decimal</span><span class="p" data-group-id="9583637223-3">{</span><span class="p" data-group-id="9583637223-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p" data-group-id="9583637223-2">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;$</span><span class="si" data-group-id="9583637223-4">#{</span><span class="nc">Decimal</span><span class="o">.</span><span class="n">round</span><span class="p" data-group-id="9583637223-5">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="9583637223-5">)</span><span class="si" data-group-id="9583637223-4">}</span><span class="s">&quot;</span><span class="w">
</span><span class="k" data-group-id="9583637223-1">end</span></code></pre><p>We created a view to render our <code class="inline">show.html</code> template and aliased our <code class="inline">ShoppingCart</code> context so it will be in scope for our template. We'll need to display the cart prices like product item price, cart total, etc, so we defined a <code class="inline">currency_to_str/1</code> which takes our decimal struct, rounds it properly for display, and prepends a USD dollar sign.</p><p>Next we can create the template at <code class="inline">lib/hello_web/controllers/cart_html/show.html.heex</code>:</p><pre><code class="makeup heex" translate="no"><span class="p">&lt;</span><span class="nt">.header</span><span class="p">&gt;</span><span class="w">
</span><span class="n">  My Cart
</span><span class="w">  </span><span class="p">&lt;</span><span class="nt">:subtitle</span><span class="w"> </span><span class="ni">:if</span><span class="p">=</span><span class="p" data-group-id="2666343792-1">{</span><span class="na">@cart</span><span class="o">.</span><span class="n">items</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p" data-group-id="2666343792-ex-1">[</span><span class="p" data-group-id="2666343792-ex-1">]</span><span class="p" data-group-id="2666343792-1">}</span><span class="p">&gt;</span><span class="n">Your cart is empty</span><span class="p">&lt;/</span><span class="nt">:subtitle</span><span class="p">&gt;</span><span class="w">
</span><span class="p">&lt;/</span><span class="nt">.header</span><span class="p">&gt;</span><span class="w">
</span><span class="w">
</span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="ni">:if</span><span class="p">=</span><span class="p" data-group-id="2666343792-2">{</span><span class="na">@cart</span><span class="o">.</span><span class="n">items</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="p" data-group-id="2666343792-ex-2">[</span><span class="p" data-group-id="2666343792-ex-2">]</span><span class="p" data-group-id="2666343792-2">}</span><span class="p">&gt;</span><span class="w">
</span><span class="w">  </span><span class="p">&lt;</span><span class="nt">.simple_form</span><span class="w"> </span><span class="ni">:let</span><span class="p">=</span><span class="p" data-group-id="2666343792-3">{</span><span class="n">f</span><span class="p" data-group-id="2666343792-3">}</span><span class="w"> </span><span class="ni">for</span><span class="p">=</span><span class="p" data-group-id="2666343792-4">{</span><span class="na">@changeset</span><span class="p" data-group-id="2666343792-4">}</span><span class="w"> </span><span class="ni">action</span><span class="p">=</span><span class="p" data-group-id="2666343792-5">{</span><span class="sx">~p&quot;/cart&quot;</span><span class="p" data-group-id="2666343792-5">}</span><span class="p">&gt;</span><span class="w">
</span><span class="w">    </span><span class="p">&lt;</span><span class="nt">.inputs_for</span><span class="w"> </span><span class="ni">:let</span><span class="p">=</span><span class="p" data-group-id="2666343792-6">{</span><span class="p" data-group-id="2666343792-ex-3">%{</span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">item</span><span class="p" data-group-id="2666343792-ex-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item_form</span><span class="p" data-group-id="2666343792-6">}</span><span class="w"> </span><span class="ni">field</span><span class="p">=</span><span class="p" data-group-id="2666343792-7">{</span><span class="n">f</span><span class="p" data-group-id="2666343792-ex-4">[</span><span class="ss">:items</span><span class="p" data-group-id="2666343792-ex-4">]</span><span class="p" data-group-id="2666343792-7">}</span><span class="p">&gt;</span><span class="w">
</span><span class="w">      </span><span class="p">&lt;</span><span class="nt">.input</span><span class="w"> </span><span class="ni">field</span><span class="p">=</span><span class="p" data-group-id="2666343792-8">{</span><span class="n">item_form</span><span class="p" data-group-id="2666343792-ex-5">[</span><span class="ss">:quantity</span><span class="p" data-group-id="2666343792-ex-5">]</span><span class="p" data-group-id="2666343792-8">}</span><span class="w"> </span><span class="ni">type</span><span class="p">=</span><span class="p">&quot;</span><span class="s2">number</span><span class="p">&quot;</span><span class="w"> </span><span class="ni">label</span><span class="p">=</span><span class="p" data-group-id="2666343792-9">{</span><span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">title</span><span class="p" data-group-id="2666343792-9">}</span><span class="w"> </span><span class="p">/&gt;</span><span class="w">
</span><span class="w">      </span><span class="p" data-group-id="2666343792-10">{</span><span class="n">currency_to_str</span><span class="p" data-group-id="2666343792-ex-6">(</span><span class="nc">ShoppingCart</span><span class="o">.</span><span class="n">total_item_price</span><span class="p" data-group-id="2666343792-ex-7">(</span><span class="n">item</span><span class="p" data-group-id="2666343792-ex-7">)</span><span class="p" data-group-id="2666343792-ex-6">)</span><span class="p" data-group-id="2666343792-10">}</span><span class="w">
</span><span class="w">    </span><span class="p">&lt;/</span><span class="nt">.inputs_for</span><span class="p">&gt;</span><span class="w">
</span><span class="w">    </span><span class="p">&lt;</span><span class="nt">:actions</span><span class="p">&gt;</span><span class="w">
</span><span class="w">      </span><span class="p">&lt;</span><span class="nt">.button</span><span class="p">&gt;</span><span class="n">Update cart</span><span class="p">&lt;/</span><span class="nt">.button</span><span class="p">&gt;</span><span class="w">
</span><span class="w">    </span><span class="p">&lt;/</span><span class="nt">:actions</span><span class="p">&gt;</span><span class="w">
</span><span class="w">  </span><span class="p">&lt;/</span><span class="nt">.simple_form</span><span class="p">&gt;</span><span class="w">
</span><span class="w">  </span><span class="p">&lt;</span><span class="nt">b</span><span class="p">&gt;</span><span class="n">Total</span><span class="p">&lt;/</span><span class="nt">b</span><span class="p">&gt;</span><span class="n">: </span><span class="p" data-group-id="2666343792-11">{</span><span class="n">currency_to_str</span><span class="p" data-group-id="2666343792-ex-8">(</span><span class="nc">ShoppingCart</span><span class="o">.</span><span class="n">total_cart_price</span><span class="p" data-group-id="2666343792-ex-9">(</span><span class="na">@cart</span><span class="p" data-group-id="2666343792-ex-9">)</span><span class="p" data-group-id="2666343792-ex-8">)</span><span class="p" data-group-id="2666343792-11">}</span><span class="n">
</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span><span class="w">
</span><span class="w">
</span><span class="p">&lt;</span><span class="nt">.back</span><span class="w"> </span><span class="ni">navigate</span><span class="p">=</span><span class="p" data-group-id="2666343792-12">{</span><span class="sx">~p&quot;/products&quot;</span><span class="p" data-group-id="2666343792-12">}</span><span class="p">&gt;</span><span class="n">Back to products</span><span class="p">&lt;/</span><span class="nt">.back</span><span class="p">&gt;</span></code></pre><p>We started by showing the empty cart message if our preloaded <code class="inline">cart.items</code> is empty. If we have items, we use the <code class="inline">simple_form</code> component provided by our <code class="inline">HelloWeb.CoreComponents</code> to take our cart changeset that we assigned in the <code class="inline">CartController.show/2</code> action and create a form which maps to our cart controller <code class="inline">update/2</code> action. Within the form, we use the <code class="inline">inputs_for</code> component to render inputs for the nested cart items. This will allow us to map item inputs back together when the form is submitted. Next, we display a number input for the item quantity and label it with the product title. We finish the item form by converting the item price to string. We haven't written the <code class="inline">ShoppingCart.total_item_price/1</code> function yet, but again we employed the idea of clear, descriptive public interfaces for our contexts. After rendering inputs for all the cart items, we show an &quot;update cart&quot; submit button, along with the total price of the entire cart. This is accomplished with another new <code class="inline">ShoppingCart.total_cart_price/1</code> function which we'll implement in a moment. Finally, we added a <code class="inline">back</code> component to go back to our products page.</p><p>We're almost ready to try out our cart page, but first we need to implement our new currency calculation functions. Open up your shopping cart context at <code class="inline">lib/hello/shopping_cart.ex</code> and add these new functions:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">total_item_price</span><span class="p" data-group-id="8715770159-1">(</span><span class="p" data-group-id="8715770159-2">%</span><span class="nc" data-group-id="8715770159-2">CartItem</span><span class="p" data-group-id="8715770159-2">{</span><span class="p" data-group-id="8715770159-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p" data-group-id="8715770159-1">)</span><span class="w"> </span><span class="k" data-group-id="8715770159-3">do</span><span class="w">
    </span><span class="nc">Decimal</span><span class="o">.</span><span class="n">mult</span><span class="p" data-group-id="8715770159-4">(</span><span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p" data-group-id="8715770159-4">)</span><span class="w">
  </span><span class="k" data-group-id="8715770159-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">total_cart_price</span><span class="p" data-group-id="8715770159-5">(</span><span class="p" data-group-id="8715770159-6">%</span><span class="nc" data-group-id="8715770159-6">Cart</span><span class="p" data-group-id="8715770159-6">{</span><span class="p" data-group-id="8715770159-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cart</span><span class="p" data-group-id="8715770159-5">)</span><span class="w"> </span><span class="k" data-group-id="8715770159-7">do</span><span class="w">
    </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p" data-group-id="8715770159-8">(</span><span class="n">cart</span><span class="o">.</span><span class="n">items</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="8715770159-9">fn</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">item</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">total_item_price</span><span class="p" data-group-id="8715770159-10">(</span><span class="p" data-group-id="8715770159-10">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Decimal</span><span class="o">.</span><span class="n">add</span><span class="p" data-group-id="8715770159-11">(</span><span class="n">acc</span><span class="p" data-group-id="8715770159-11">)</span><span class="w">
    </span><span class="k" data-group-id="8715770159-9">end</span><span class="p" data-group-id="8715770159-8">)</span><span class="w">
  </span><span class="k" data-group-id="8715770159-7">end</span></code></pre><p>We implemented <code class="inline">total_item_price/1</code> which accepts a <code class="inline">%CartItem{}</code> struct. To calculate the total price, we simply take the preloaded product's price and multiply it by the item's quantity. We used <a href="https://hexdocs.pm/decimal/2.1.1/Decimal.html#mult/2"><code class="inline">Decimal.mult/2</code></a> to take our decimal currency struct and multiply it with proper precision. Similarly for calculating the total cart price, we implemented a <code class="inline">total_cart_price/1</code> function which accepts the cart and sums the preloaded product prices for items in the cart. We again make use of the <a href="https://hexdocs.pm/decimal/2.1.1/Decimal.html"><code class="inline">Decimal</code></a> functions to add our decimal structs together.</p><p>Now that we can calculate price totals, let's try it out! Visit <a href="http://localhost:4000/cart"><code class="inline">http://localhost:4000/cart</code></a> and you should already see your first item in the cart. Going back to the same product and clicking &quot;add to cart&quot; will show our upsert in action. Your quantity should now be two. Nice work!</p><p>Our cart page is almost complete, but submitting the form will yield yet another error.</p><pre><code class="text">Request: POST /cart
** (exit) an exception was raised:
    ** (UndefinedFunctionError) function HelloWeb.CartController.update/2 is undefined or private</code></pre><p>Let's head back to our <code class="inline">CartController</code> at <code class="inline">lib/hello_web/controllers/cart_controller.ex</code> and implement the update action:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">update</span><span class="p" data-group-id="0977306909-1">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0977306909-2">%{</span><span class="s">&quot;cart&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">cart_params</span><span class="p" data-group-id="0977306909-2">}</span><span class="p" data-group-id="0977306909-1">)</span><span class="w"> </span><span class="k" data-group-id="0977306909-3">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">ShoppingCart</span><span class="o">.</span><span class="n">update_cart</span><span class="p" data-group-id="0977306909-4">(</span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">cart</span><span class="p">,</span><span class="w"> </span><span class="n">cart_params</span><span class="p" data-group-id="0977306909-4">)</span><span class="w"> </span><span class="k" data-group-id="0977306909-5">do</span><span class="w">
      </span><span class="p" data-group-id="0977306909-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="c">_cart</span><span class="p" data-group-id="0977306909-6">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">redirect</span><span class="p" data-group-id="0977306909-7">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="sx">~p&quot;/cart&quot;</span><span class="p" data-group-id="0977306909-7">)</span><span class="w">

      </span><span class="p" data-group-id="0977306909-8">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="c">_changeset</span><span class="p" data-group-id="0977306909-8">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="0977306909-9">(</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;There was an error updating your cart&quot;</span><span class="p" data-group-id="0977306909-9">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="0977306909-10">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="sx">~p&quot;/cart&quot;</span><span class="p" data-group-id="0977306909-10">)</span><span class="w">
    </span><span class="k" data-group-id="0977306909-5">end</span><span class="w">
  </span><span class="k" data-group-id="0977306909-3">end</span></code></pre><p>We started by plucking out the cart params from the form submit. Next, we call our existing <code class="inline">ShoppingCart.update_cart/2</code> function which was added by the context generator. We'll need to make some changes to this function, but the interface is good as is. If the update is successful, we redirect back to the cart page, otherwise we show a flash error message and send the user back to the cart page to fix any mistakes. Out-of-the-box, our <code class="inline">ShoppingCart.update_cart/2</code> function only concerned itself with casting the cart params into a changeset and updates it against our repo. For our purposes, we now need it to handle nested cart item associations, and most importantly, business logic for how to handle quantity updates like zero-quantity items being removed from the cart.</p><p>Head back over to your shopping cart context in <code class="inline">lib/hello/shopping_cart.ex</code> and replace your <code class="inline">update_cart/2</code> function with the following implementation:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">update_cart</span><span class="p" data-group-id="0621802206-1">(</span><span class="p" data-group-id="0621802206-2">%</span><span class="nc" data-group-id="0621802206-2">Cart</span><span class="p" data-group-id="0621802206-2">{</span><span class="p" data-group-id="0621802206-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cart</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="0621802206-1">)</span><span class="w"> </span><span class="k" data-group-id="0621802206-3">do</span><span class="w">
    </span><span class="n">changeset</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">cart</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Cart</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="0621802206-4">(</span><span class="n">attrs</span><span class="p" data-group-id="0621802206-4">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">cast_assoc</span><span class="p" data-group-id="0621802206-5">(</span><span class="ss">:items</span><span class="p">,</span><span class="w"> </span><span class="ss">with</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nc">CartItem</span><span class="o">.</span><span class="n">changeset</span><span class="o">/</span><span class="mi">2</span><span class="p" data-group-id="0621802206-5">)</span><span class="w">

    </span><span class="nc">Ecto.Multi</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="0621802206-6">(</span><span class="p" data-group-id="0621802206-6">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Multi</span><span class="o">.</span><span class="n">update</span><span class="p" data-group-id="0621802206-7">(</span><span class="ss">:cart</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="0621802206-7">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Multi</span><span class="o">.</span><span class="n">delete_all</span><span class="p" data-group-id="0621802206-8">(</span><span class="ss">:discarded_items</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="0621802206-9">fn</span><span class="w"> </span><span class="p" data-group-id="0621802206-10">%{</span><span class="ss">cart</span><span class="p">:</span><span class="w"> </span><span class="n">cart</span><span class="p" data-group-id="0621802206-10">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">from</span><span class="p" data-group-id="0621802206-11">(</span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">CartItem</span><span class="p">,</span><span class="w"> </span><span class="ss">where</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="o">.</span><span class="n">cart_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">cart</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">i</span><span class="o">.</span><span class="n">quantity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="0621802206-11">)</span><span class="w">
    </span><span class="k" data-group-id="0621802206-9">end</span><span class="p" data-group-id="0621802206-8">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">transaction</span><span class="p" data-group-id="0621802206-12">(</span><span class="p" data-group-id="0621802206-12">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="k" data-group-id="0621802206-13">do</span><span class="w">
      </span><span class="p" data-group-id="0621802206-14">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0621802206-15">%{</span><span class="ss">cart</span><span class="p">:</span><span class="w"> </span><span class="n">cart</span><span class="p" data-group-id="0621802206-15">}</span><span class="p" data-group-id="0621802206-14">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="0621802206-16">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">cart</span><span class="p" data-group-id="0621802206-16">}</span><span class="w">
      </span><span class="p" data-group-id="0621802206-17">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:cart</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="c">_changes_so_far</span><span class="p" data-group-id="0621802206-17">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="0621802206-18">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="0621802206-18">}</span><span class="w">
    </span><span class="k" data-group-id="0621802206-13">end</span><span class="w">
  </span><span class="k" data-group-id="0621802206-3">end</span></code></pre><p>We started much like how our out-of-the-box code started – we take the cart struct and cast the user input to a cart changeset, except this time we use <a href="https://hexdocs.pm/ecto/3.10.1/Ecto.Changeset.html#cast_assoc/3"><code class="inline">Ecto.Changeset.cast_assoc/3</code></a> to cast the nested item data into <code class="inline">CartItem</code> changesets. Remember the <code class="inline">&lt;.inputs_for /&gt;</code> call in our cart form template? That hidden ID data is what allows Ecto's <code class="inline">cast_assoc</code> to map item data back to existing item associations in the cart. Next we use <a href="https://hexdocs.pm/ecto/3.10.1/Ecto.Multi.html#new/0"><code class="inline">Ecto.Multi.new/0</code></a>, which you may not have seen before. Ecto's <code class="inline">Multi</code> is a feature that allows lazily defining a chain of named operations to eventually execute inside a database transaction. Each operation in the multi chain receives the values from the previous steps and executes until a failed step is encountered. When an operation fails, the transaction is rolled back and an error is returned, otherwise the transaction is committed.</p><p>For our multi operations, we start by issuing an update of our cart, which we named <code class="inline">:cart</code>. After the cart update is issued, we perform a multi <code class="inline">delete_all</code> operation, which takes the updated cart and applies our zero-quantity logic. We prune any items in the cart with zero quantity by returning an ecto query that finds all cart items for this cart with an empty quantity. Calling <code class="inline">Repo.transaction/1</code> with our multi will execute the operations in a new transaction and we return the success or failure result to the caller just like the original function.</p><p>Let's head back to the browser and try it out. Add a few products to your cart, update the quantities, and watch the values changes along with the price calculations. Setting any quantity to 0 will also remove the item. Pretty neat!</p><h2 id="adding-an-orders-context" class="section-heading">
  <a href="#adding-an-orders-context" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Adding an Orders context</span>
</h2>
<p>With our <code class="inline">Catalog</code> and <code class="inline">ShoppingCart</code> contexts, we're seeing first-hand how our well-considered modules and function names are yielding clear and maintainable code. Our last order of business is to allow the user to initiate the checkout process. We won't go as far as integrating payment processing or order fulfillment, but we'll get you started in that direction. Like before, we need to decide where code for completing an order should live. Is it part of the catalog? Clearly not, but what about the shopping cart? Shopping carts are related to orders – after all, the user has to add items in order to purchase any products – but should the order checkout process be grouped here?</p><p>If we stop and consider the order process, we'll see that orders involve related, but distinctly different data from the cart contents. Also, business rules around the checkout process are much different than carting. For example, we may allow a user to add a back-ordered item to their cart, but we could not allow an order with no inventory to be completed. Additionally, we need to capture point-in-time product information when an order is completed, such as the price of the items <em>at payment transaction time</em>. This is essential because a product price may change in the future, but the line items in our order must always record and display what we charged at time of purchase. For these reasons, we can start to see that ordering can stand on its own with its own data concerns and business rules.</p><p>Naming wise, <code class="inline">Orders</code> clearly defines the scope of our context, so let's get started by again taking advantage of the context generators. Run the following command in your console:</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix phx.gen.context Orders Order orders user_uuid:uuid total_price:decimal
</span><span class="">
</span><span class="">* creating lib/hello/orders/order.ex
</span><span class="">* creating priv/repo/migrations/20210209214612_create_orders.exs
</span><span class="">* creating lib/hello/orders.ex
</span><span class="">* injecting lib/hello/orders.ex
</span><span class="">* creating test/hello/orders_test.exs
</span><span class="">* injecting test/hello/orders_test.exs
</span><span class="">* creating test/support/fixtures/orders_fixtures.ex
</span><span class="">* injecting test/support/fixtures/orders_fixtures.ex
</span><span class="">
</span><span class="">Remember to update your repository by running migrations:
</span><span class="">
</span><span class="">    $ mix ecto.migrate
</span></code></pre><p>We generated an <code class="inline">Orders</code> context. We added a <code class="inline">user_uuid</code> field to associate our placeholder current user to an order, along with a <code class="inline">total_price</code> column. With our starting point in place, let's open up the newly created migration in <code class="inline">priv/repo/migrations/*_create_orders.exs</code> and make the following changes:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="k" data-group-id="5774194961-1">do</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="5774194961-2">(</span><span class="ss">:orders</span><span class="p" data-group-id="5774194961-2">)</span><span class="w"> </span><span class="k" data-group-id="5774194961-3">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:user_uuid</span><span class="p">,</span><span class="w"> </span><span class="ss">:uuid</span><span class="w">
</span><span class="o">-</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:total_price</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:total_price</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="p">,</span><span class="w"> </span><span class="ss">precision</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="ss">scale</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="ss">null</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">

      </span><span class="n">timestamps</span><span class="p" data-group-id="5774194961-4">(</span><span class="p" data-group-id="5774194961-4">)</span><span class="w">
    </span><span class="k" data-group-id="5774194961-3">end</span><span class="w">
  </span><span class="k" data-group-id="5774194961-1">end</span></code></pre><p>Like we did previously, we gave appropriate precision and scale options for our decimal column which will allow us to store currency without precision loss. We also added a not-null constraint to enforce all orders to have a price.</p><p>The orders table alone doesn't hold much information, but we know we'll need to store point-in-time product price information of all the items in the order. For that, we'll add an additional struct for this context named <code class="inline">LineItem</code>. Line items will capture the price of the product <em>at payment transaction time</em>. Please run the following command:</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix phx.gen.context Orders LineItem order_line_items \
</span><span class="">price:decimal quantity:integer \
</span><span class="">order_id:references:orders product_id:references:products
</span><span class="">
</span><span class="">You are generating into an existing context.
</span><span class="">...
</span><span class="">Would you like to proceed? [Yn] y
</span><span class="">* creating lib/hello/orders/line_item.ex
</span><span class="">* creating priv/repo/migrations/20210209215050_create_order_line_items.exs
</span><span class="">* injecting lib/hello/orders.ex
</span><span class="">* injecting test/hello/orders_test.exs
</span><span class="">* injecting test/support/fixtures/orders_fixtures.ex
</span><span class="">
</span><span class="">Remember to update your repository by running migrations:
</span><span class="">
</span><span class="">    $ mix ecto.migrate
</span></code></pre><p>We used the <code class="inline">phx.gen.context</code> command to generate the <code class="inline">LineItem</code> Ecto schema and inject supporting functions into our orders context. Like before, let's modify the migration in <code class="inline">priv/repo/migrations/*_create_order_line_items.exs</code> and make the following decimal field changes:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="k" data-group-id="0812080158-1">do</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="0812080158-2">(</span><span class="ss">:order_line_items</span><span class="p" data-group-id="0812080158-2">)</span><span class="w"> </span><span class="k" data-group-id="0812080158-3">do</span><span class="w">
</span><span class="o">-</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:price</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="w">
</span><span class="o">+</span><span class="w">     </span><span class="n">add</span><span class="w"> </span><span class="ss">:price</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="p">,</span><span class="w"> </span><span class="ss">precision</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="ss">scale</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="ss">null</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:quantity</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:order_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="0812080158-4">(</span><span class="ss">:orders</span><span class="p">,</span><span class="w"> </span><span class="ss">on_delete</span><span class="p">:</span><span class="w"> </span><span class="ss">:nothing</span><span class="p" data-group-id="0812080158-4">)</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:product_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="0812080158-5">(</span><span class="ss">:products</span><span class="p">,</span><span class="w"> </span><span class="ss">on_delete</span><span class="p">:</span><span class="w"> </span><span class="ss">:nothing</span><span class="p" data-group-id="0812080158-5">)</span><span class="w">

      </span><span class="n">timestamps</span><span class="p" data-group-id="0812080158-6">(</span><span class="p" data-group-id="0812080158-6">)</span><span class="w">
    </span><span class="k" data-group-id="0812080158-3">end</span><span class="w">

    </span><span class="n">create</span><span class="w"> </span><span class="n">index</span><span class="p" data-group-id="0812080158-7">(</span><span class="ss">:order_line_items</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0812080158-8">[</span><span class="ss">:order_id</span><span class="p" data-group-id="0812080158-8">]</span><span class="p" data-group-id="0812080158-7">)</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="n">index</span><span class="p" data-group-id="0812080158-9">(</span><span class="ss">:order_line_items</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0812080158-10">[</span><span class="ss">:product_id</span><span class="p" data-group-id="0812080158-10">]</span><span class="p" data-group-id="0812080158-9">)</span><span class="w">
  </span><span class="k" data-group-id="0812080158-1">end</span></code></pre><p>With our migration in place, let's wire up our orders and line items associations in <code class="inline">lib/hello/orders/order.ex</code>:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;orders&quot;</span><span class="w"> </span><span class="k" data-group-id="5217018035-1">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:total_price</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:user_uuid</span><span class="p">,</span><span class="w"> </span><span class="nc">Ecto.UUID</span><span class="w">

</span><span class="o">+</span><span class="w">   </span><span class="n">has_many</span><span class="w"> </span><span class="ss">:line_items</span><span class="p">,</span><span class="w"> </span><span class="nc">Hello.Orders.LineItem</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">has_many</span><span class="w"> </span><span class="ss">:products</span><span class="p">,</span><span class="w"> </span><span class="ss">through</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5217018035-2">[</span><span class="ss">:line_items</span><span class="p">,</span><span class="w"> </span><span class="ss">:product</span><span class="p" data-group-id="5217018035-2">]</span><span class="w">

    </span><span class="n">timestamps</span><span class="p" data-group-id="5217018035-3">(</span><span class="p" data-group-id="5217018035-3">)</span><span class="w">
  </span><span class="k" data-group-id="5217018035-1">end</span></code></pre><p>We used <code class="inline">has_many :line_items</code> to associate orders and line items, just like we've seen before. Next, we used the <code class="inline">:through</code> feature of <code class="inline">has_many</code>, which allows us to instruct ecto how to associate resources across another relationship. In this case, we can associate products of an order by finding all products through associated line items. Next, let's wire up the association in the other direction in <code class="inline">lib/hello/orders/line_item.ex</code>:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;order_line_items&quot;</span><span class="w"> </span><span class="k" data-group-id="4055534940-1">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:price</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:quantity</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="n">field</span><span class="w"> </span><span class="ss">:order_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:id</span><span class="w">
</span><span class="o">-</span><span class="w">   </span><span class="n">field</span><span class="w"> </span><span class="ss">:product_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:id</span><span class="w">

</span><span class="o">+</span><span class="w">   </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:order</span><span class="p">,</span><span class="w"> </span><span class="nc">Hello.Orders.Order</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:product</span><span class="p">,</span><span class="w"> </span><span class="nc">Hello.Catalog.Product</span><span class="w">

    </span><span class="n">timestamps</span><span class="p" data-group-id="4055534940-2">(</span><span class="p" data-group-id="4055534940-2">)</span><span class="w">
  </span><span class="k" data-group-id="4055534940-1">end</span></code></pre><p>We used <code class="inline">belongs_to</code> to associate line items to orders and products. With our associations in place, we can start integrating the web interface into our order process. Open up your router <code class="inline">lib/hello_web/router.ex</code> and add the following line:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="n">scope</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="w"> </span><span class="k" data-group-id="9141469664-1">do</span><span class="w">
    </span><span class="n">pipe_through</span><span class="w"> </span><span class="ss">:browser</span><span class="w">

    </span><span class="n">...</span><span class="w">
</span><span class="o">+</span><span class="w">   </span><span class="n">resources</span><span class="w"> </span><span class="s">&quot;/orders&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">OrderController</span><span class="p">,</span><span class="w"> </span><span class="ss">only</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9141469664-2">[</span><span class="ss">:create</span><span class="p">,</span><span class="w"> </span><span class="ss">:show</span><span class="p" data-group-id="9141469664-2">]</span><span class="w">
  </span><span class="k" data-group-id="9141469664-1">end</span></code></pre><p>We wired up <code class="inline">create</code> and <code class="inline">show</code> routes for our generated <code class="inline">OrderController</code>, since these are the only actions we need at the moment. With our routes in place, we can now migrate up:</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix ecto.migrate
</span><span class="">
</span><span class="">17:14:37.715 [info] == Running 20210209214612 Hello.Repo.Migrations.CreateOrders.change/0 forward
</span><span class="">
</span><span class="">17:14:37.720 [info] create table orders
</span><span class="">
</span><span class="">17:14:37.755 [info] == Migrated 20210209214612 in 0.0s
</span><span class="">
</span><span class="">17:14:37.784 [info] == Running 20210209215050 Hello.Repo.Migrations.CreateOrderLineItems.change/0 forward
</span><span class="">
</span><span class="">17:14:37.785 [info] create table order_line_items
</span><span class="">
</span><span class="">17:14:37.795 [info] create index order_line_items_order_id_index
</span><span class="">
</span><span class="">17:14:37.796 [info] create index order_line_items_product_id_index
</span><span class="">
</span><span class="">17:14:37.798 [info] == Migrated 20210209215050 in 0.0s
</span></code></pre><p>Before we render information about our orders, we need to ensure our order data is fully populated and can be looked up by a current user. Open up your orders context in <code class="inline">lib/hello/orders.ex</code> and replace your <code class="inline">get_order!/1</code> function by a new <code class="inline">get_order!/2</code> definition:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">get_order!</span><span class="p" data-group-id="5657608672-1">(</span><span class="n">user_uuid</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="5657608672-1">)</span><span class="w"> </span><span class="k" data-group-id="5657608672-2">do</span><span class="w">
    </span><span class="nc">Order</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">get_by!</span><span class="p" data-group-id="5657608672-3">(</span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="ss">user_uuid</span><span class="p">:</span><span class="w"> </span><span class="n">user_uuid</span><span class="p" data-group-id="5657608672-3">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">preload</span><span class="p" data-group-id="5657608672-4">(</span><span class="p" data-group-id="5657608672-5">[</span><span class="ss">line_items</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5657608672-6">[</span><span class="ss">:product</span><span class="p" data-group-id="5657608672-6">]</span><span class="p" data-group-id="5657608672-5">]</span><span class="p" data-group-id="5657608672-4">)</span><span class="w">
  </span><span class="k" data-group-id="5657608672-2">end</span></code></pre><p>We rewrote the function to accept a user UUID and query our repo for an order matching the user's ID for a given order ID. Then we populated the order by preloading our line item and product associations.</p><p>To complete an order, our cart page can issue a POST to the <code class="inline">OrderController.create</code> action, but we need to implement the operations and logic to actually complete an order. Like before, we'll start at the web interface. Create a new file at <code class="inline">lib/hello_web/controllers/order_controller.ex</code> and key this in:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.OrderController</span><span class="w"> </span><span class="k" data-group-id="4381076525-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:controller</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Orders</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create</span><span class="p" data-group-id="4381076525-2">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="4381076525-2">)</span><span class="w"> </span><span class="k" data-group-id="4381076525-3">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Orders</span><span class="o">.</span><span class="n">complete_order</span><span class="p" data-group-id="4381076525-4">(</span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">cart</span><span class="p" data-group-id="4381076525-4">)</span><span class="w"> </span><span class="k" data-group-id="4381076525-5">do</span><span class="w">
      </span><span class="p" data-group-id="4381076525-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="4381076525-6">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="4381076525-7">(</span><span class="ss">:info</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Order created successfully.&quot;</span><span class="p" data-group-id="4381076525-7">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="4381076525-8">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="sx">~p&quot;/orders/</span><span class="si" data-group-id="4381076525-9">#{</span><span class="n">order</span><span class="si" data-group-id="4381076525-9">}</span><span class="sx">&quot;</span><span class="p" data-group-id="4381076525-8">)</span><span class="w">

      </span><span class="p" data-group-id="4381076525-10">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="c">_reason</span><span class="p" data-group-id="4381076525-10">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="4381076525-11">(</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;There was an error processing your order&quot;</span><span class="p" data-group-id="4381076525-11">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="4381076525-12">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="sx">~p&quot;/cart&quot;</span><span class="p" data-group-id="4381076525-12">)</span><span class="w">
    </span><span class="k" data-group-id="4381076525-5">end</span><span class="w">
  </span><span class="k" data-group-id="4381076525-3">end</span><span class="w">
</span><span class="k" data-group-id="4381076525-1">end</span></code></pre><p>We wrote the <code class="inline">create</code> action to call an as-yet-implemented <code class="inline">Orders.complete_order/1</code> function. Our code is technically &quot;creating&quot; an order, but it's important to step back and consider the naming of your interfaces. The act of <em>completing</em> an order is extremely important in our system. Money changes hands in a transaction, physical goods could be automatically shipped, etc. Such an operation deserves a better, more obvious function name, such as <code class="inline">complete_order</code>. If the order is completed successfully we redirect to the show page, otherwise a flash error is shown as we redirect back to the cart page.</p><p>Here is also a good opportunity to highlight that contexts can naturally work with data defined by other contexts too. This will be especially common with data that is used throughout the application, such as the cart here (but it can also be the current user or the current project, and so forth, depending on your project).</p><p>Now we can implement our <code class="inline">Orders.complete_order/1</code> function. To complete an order, our job will require a few operations:</p><ol><li>A new order record must be persisted with the total price of the order</li><li>All items in the cart must be transformed into new order line items records
with quantity and point-in-time product price information</li><li>After successful order insert (and eventual payment), items must be pruned
from the cart</li></ol><p>From our requirements alone, we can start to see why a generic <code class="inline">create_order</code> function doesn't cut it. Let's implement this new function in <code class="inline">lib/hello/orders.ex</code>:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Orders.LineItem</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.ShoppingCart</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">complete_order</span><span class="p" data-group-id="9207687033-1">(</span><span class="p" data-group-id="9207687033-2">%</span><span class="nc" data-group-id="9207687033-2">ShoppingCart.Cart</span><span class="p" data-group-id="9207687033-2">{</span><span class="p" data-group-id="9207687033-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cart</span><span class="p" data-group-id="9207687033-1">)</span><span class="w"> </span><span class="k" data-group-id="9207687033-3">do</span><span class="w">
    </span><span class="n">line_items</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="9207687033-4">(</span><span class="n">cart</span><span class="o">.</span><span class="n">items</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="9207687033-5">fn</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="9207687033-6">%{</span><span class="ss">product_id</span><span class="p">:</span><span class="w"> </span><span class="n">item</span><span class="o">.</span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="ss">price</span><span class="p">:</span><span class="w"> </span><span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="ss">quantity</span><span class="p">:</span><span class="w"> </span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p" data-group-id="9207687033-6">}</span><span class="w">
      </span><span class="k" data-group-id="9207687033-5">end</span><span class="p" data-group-id="9207687033-4">)</span><span class="w">

    </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">change</span><span class="p" data-group-id="9207687033-7">(</span><span class="p" data-group-id="9207687033-8">%</span><span class="nc" data-group-id="9207687033-8">Order</span><span class="p" data-group-id="9207687033-8">{</span><span class="p" data-group-id="9207687033-8">}</span><span class="p">,</span><span class="w">
        </span><span class="ss">user_uuid</span><span class="p">:</span><span class="w"> </span><span class="n">cart</span><span class="o">.</span><span class="n">user_uuid</span><span class="p">,</span><span class="w">
        </span><span class="ss">total_price</span><span class="p">:</span><span class="w"> </span><span class="nc">ShoppingCart</span><span class="o">.</span><span class="n">total_cart_price</span><span class="p" data-group-id="9207687033-9">(</span><span class="n">cart</span><span class="p" data-group-id="9207687033-9">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">line_items</span><span class="p">:</span><span class="w"> </span><span class="n">line_items</span><span class="w">
      </span><span class="p" data-group-id="9207687033-7">)</span><span class="w">

    </span><span class="nc">Ecto.Multi</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="9207687033-10">(</span><span class="p" data-group-id="9207687033-10">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Multi</span><span class="o">.</span><span class="n">insert</span><span class="p" data-group-id="9207687033-11">(</span><span class="ss">:order</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="9207687033-11">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Multi</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="9207687033-12">(</span><span class="ss">:prune_cart</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="9207687033-13">fn</span><span class="w"> </span><span class="c">_repo</span><span class="p">,</span><span class="w"> </span><span class="c">_changes</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">ShoppingCart</span><span class="o">.</span><span class="n">prune_cart_items</span><span class="p" data-group-id="9207687033-14">(</span><span class="n">cart</span><span class="p" data-group-id="9207687033-14">)</span><span class="w">
    </span><span class="k" data-group-id="9207687033-13">end</span><span class="p" data-group-id="9207687033-12">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">transaction</span><span class="p" data-group-id="9207687033-15">(</span><span class="p" data-group-id="9207687033-15">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="k" data-group-id="9207687033-16">do</span><span class="w">
      </span><span class="p" data-group-id="9207687033-17">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9207687033-18">%{</span><span class="ss">order</span><span class="p">:</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="9207687033-18">}</span><span class="p" data-group-id="9207687033-17">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="9207687033-19">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="9207687033-19">}</span><span class="w">
      </span><span class="p" data-group-id="9207687033-20">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="c">_changes_so_far</span><span class="p" data-group-id="9207687033-20">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="9207687033-21">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9207687033-22">{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p" data-group-id="9207687033-22">}</span><span class="p" data-group-id="9207687033-21">}</span><span class="w">
    </span><span class="k" data-group-id="9207687033-16">end</span><span class="w">
  </span><span class="k" data-group-id="9207687033-3">end</span></code></pre><p>We started by mapping the <code class="inline">%ShoppingCart.CartItem{}</code>'s in our shopping cart into a map of order line items structs. The job of the order line item record is to capture the price of the product <em>at payment transaction time</em>, so we reference the product's price here. Next, we create a bare order changeset with <a href="https://hexdocs.pm/ecto/3.10.1/Ecto.Changeset.html#change/2"><code class="inline">Ecto.Changeset.change/2</code></a> and associate our user UUID, set our total price calculation, and place our order line items in the changeset. With a fresh order changeset ready to be inserted, we can again make use of <a href="https://hexdocs.pm/ecto/3.10.1/Ecto.Multi.html"><code class="inline">Ecto.Multi</code></a> to execute our operations in a database transaction. We start by inserting the order, followed by a <code class="inline">run</code> operation. The <a href="https://hexdocs.pm/ecto/3.10.1/Ecto.Multi.html#run/3"><code class="inline">Ecto.Multi.run/3</code></a> function allows us to run any code in the function which must either succeed with <code class="inline">{:ok, result}</code> or error, which halts and rolls back the transaction. Here, we simply call into our shopping cart context and ask it to prune all items in a cart. Running the transaction will execute the multi as before and we return the result to the caller.</p><p>To close out our order completion, we need to implement the <code class="inline">ShoppingCart.prune_cart_items/1</code> function in <code class="inline">lib/hello/shopping_cart.ex</code>:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">prune_cart_items</span><span class="p" data-group-id="1424555116-1">(</span><span class="p" data-group-id="1424555116-2">%</span><span class="nc" data-group-id="1424555116-2">Cart</span><span class="p" data-group-id="1424555116-2">{</span><span class="p" data-group-id="1424555116-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cart</span><span class="p" data-group-id="1424555116-1">)</span><span class="w"> </span><span class="k" data-group-id="1424555116-3">do</span><span class="w">
    </span><span class="p" data-group-id="1424555116-4">{</span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="1424555116-4">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">delete_all</span><span class="p" data-group-id="1424555116-5">(</span><span class="n">from</span><span class="p" data-group-id="1424555116-6">(</span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">CartItem</span><span class="p">,</span><span class="w"> </span><span class="ss">where</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="o">.</span><span class="n">cart_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">cart</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="1424555116-6">)</span><span class="p" data-group-id="1424555116-5">)</span><span class="w">
    </span><span class="p" data-group-id="1424555116-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">reload_cart</span><span class="p" data-group-id="1424555116-8">(</span><span class="n">cart</span><span class="p" data-group-id="1424555116-8">)</span><span class="p" data-group-id="1424555116-7">}</span><span class="w">
  </span><span class="k" data-group-id="1424555116-3">end</span></code></pre><p>Our new function accepts the cart struct and issues a <code class="inline">Repo.delete_all</code> which accepts a query of all items for the provided cart. We return a success result by simply reloading the pruned cart to the caller. With our context complete, we now need to show the user their completed order. Head back to your order controller and add the <code class="inline">show/2</code> action:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">show</span><span class="p" data-group-id="4554431469-1">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4554431469-2">%{</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="4554431469-2">}</span><span class="p" data-group-id="4554431469-1">)</span><span class="w"> </span><span class="k" data-group-id="4554431469-3">do</span><span class="w">
    </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Orders</span><span class="o">.</span><span class="n">get_order!</span><span class="p" data-group-id="4554431469-4">(</span><span class="n">conn</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">current_uuid</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="4554431469-4">)</span><span class="w">
    </span><span class="n">render</span><span class="p" data-group-id="4554431469-5">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:show</span><span class="p">,</span><span class="w"> </span><span class="ss">order</span><span class="p">:</span><span class="w"> </span><span class="n">order</span><span class="p" data-group-id="4554431469-5">)</span><span class="w">
  </span><span class="k" data-group-id="4554431469-3">end</span></code></pre><p>We added the show action to pass our <code class="inline">conn.assigns.current_uuid</code> to <code class="inline">get_order!</code> which authorizes orders to be viewable only by the owner of the order. Next, we can implement the view and template. Create a new view file at <code class="inline">lib/hello_web/controllers/order_html.ex</code> with the following content:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.OrderHTML</span><span class="w"> </span><span class="k" data-group-id="9801899512-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:html</span><span class="w">

  </span><span class="n">embed_templates</span><span class="w"> </span><span class="s">&quot;order_html/*&quot;</span><span class="w">
</span><span class="k" data-group-id="9801899512-1">end</span></code></pre><p>Next we can create the template at <code class="inline">lib/hello_web/controllers/order_html/show.html.heex</code>:</p><pre><code class="makeup heex" translate="no"><span class="p">&lt;</span><span class="nt">.header</span><span class="p">&gt;</span><span class="w">
</span><span class="n">  Thank you for your order!
</span><span class="w">  </span><span class="p">&lt;</span><span class="nt">:subtitle</span><span class="p">&gt;</span><span class="w">
</span><span class="w">     </span><span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span><span class="n">User uuid: </span><span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span><span class="p" data-group-id="6216448932-1">{</span><span class="na">@order</span><span class="o">.</span><span class="n">user_uuid</span><span class="p" data-group-id="6216448932-1">}</span><span class="w">
</span><span class="w">  </span><span class="p">&lt;/</span><span class="nt">:subtitle</span><span class="p">&gt;</span><span class="w">
</span><span class="p">&lt;/</span><span class="nt">.header</span><span class="p">&gt;</span><span class="w">
</span><span class="w">
</span><span class="p">&lt;</span><span class="nt">.table</span><span class="w"> </span><span class="ni">id</span><span class="p">=</span><span class="p">&quot;</span><span class="s2">items</span><span class="p">&quot;</span><span class="w"> </span><span class="ni">rows</span><span class="p">=</span><span class="p" data-group-id="6216448932-2">{</span><span class="na">@order</span><span class="o">.</span><span class="n">line_items</span><span class="p" data-group-id="6216448932-2">}</span><span class="p">&gt;</span><span class="w">
</span><span class="w">  </span><span class="p">&lt;</span><span class="nt">:col</span><span class="w"> </span><span class="ni">:let</span><span class="p">=</span><span class="p" data-group-id="6216448932-3">{</span><span class="n">item</span><span class="p" data-group-id="6216448932-3">}</span><span class="w"> </span><span class="ni">label</span><span class="p">=</span><span class="p">&quot;</span><span class="s2">Title</span><span class="p">&quot;</span><span class="p">&gt;</span><span class="p" data-group-id="6216448932-4">{</span><span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">title</span><span class="p" data-group-id="6216448932-4">}</span><span class="p">&lt;/</span><span class="nt">:col</span><span class="p">&gt;</span><span class="w">
</span><span class="w">  </span><span class="p">&lt;</span><span class="nt">:col</span><span class="w"> </span><span class="ni">:let</span><span class="p">=</span><span class="p" data-group-id="6216448932-5">{</span><span class="n">item</span><span class="p" data-group-id="6216448932-5">}</span><span class="w"> </span><span class="ni">label</span><span class="p">=</span><span class="p">&quot;</span><span class="s2">Quantity</span><span class="p">&quot;</span><span class="p">&gt;</span><span class="p" data-group-id="6216448932-6">{</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p" data-group-id="6216448932-6">}</span><span class="p">&lt;/</span><span class="nt">:col</span><span class="p">&gt;</span><span class="w">
</span><span class="w">  </span><span class="p">&lt;</span><span class="nt">:col</span><span class="w"> </span><span class="ni">:let</span><span class="p">=</span><span class="p" data-group-id="6216448932-7">{</span><span class="n">item</span><span class="p" data-group-id="6216448932-7">}</span><span class="w"> </span><span class="ni">label</span><span class="p">=</span><span class="p">&quot;</span><span class="s2">Price</span><span class="p">&quot;</span><span class="p">&gt;</span><span class="w">
</span><span class="w">    </span><span class="p" data-group-id="6216448932-8">{</span><span class="nc">HelloWeb.CartHTML</span><span class="o">.</span><span class="n">currency_to_str</span><span class="p" data-group-id="6216448932-ex-1">(</span><span class="n">item</span><span class="o">.</span><span class="n">price</span><span class="p" data-group-id="6216448932-ex-1">)</span><span class="p" data-group-id="6216448932-8">}</span><span class="w">
</span><span class="w">  </span><span class="p">&lt;/</span><span class="nt">:col</span><span class="p">&gt;</span><span class="w">
</span><span class="p">&lt;/</span><span class="nt">.table</span><span class="p">&gt;</span><span class="w">
</span><span class="w">
</span><span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span><span class="n">Total price:</span><span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span><span class="w">
</span><span class="p" data-group-id="6216448932-9">{</span><span class="nc">HelloWeb.CartHTML</span><span class="o">.</span><span class="n">currency_to_str</span><span class="p" data-group-id="6216448932-ex-2">(</span><span class="na">@order</span><span class="o">.</span><span class="n">total_price</span><span class="p" data-group-id="6216448932-ex-2">)</span><span class="p" data-group-id="6216448932-9">}</span><span class="w">
</span><span class="w">
</span><span class="p">&lt;</span><span class="nt">.back</span><span class="w"> </span><span class="ni">navigate</span><span class="p">=</span><span class="p" data-group-id="6216448932-10">{</span><span class="sx">~p&quot;/products&quot;</span><span class="p" data-group-id="6216448932-10">}</span><span class="p">&gt;</span><span class="n">Back to products</span><span class="p">&lt;/</span><span class="nt">.back</span><span class="p">&gt;</span></code></pre><p>To show our completed order, we displayed the order's user, followed by the line item listing with product title, quantity, and the price we &quot;transacted&quot; when completing the order, along with the total price.</p><p>Our last addition will be to add the &quot;complete order&quot; button to our cart page to allow completing an order. Add the following button to the &lt;.header&gt; of the cart show template in <code class="inline">lib/hello_web/controllers/cart_html/show.html.heex</code>:</p><pre><code class="makeup diff" translate="no"><span class="n">  &lt;.header&gt;
</span><span class="n">    My Cart
</span><span class="gi">+</span><span class="gi">   &lt;:actions&gt;
</span><span class="gi">+</span><span class="gi">     &lt;.link href={~p&quot;/orders&quot;} method=&quot;post&quot;&gt;
</span><span class="gi">+</span><span class="gi">       &lt;.button&gt;Complete order&lt;/.button&gt;
</span><span class="gi">+</span><span class="gi">     &lt;/.link&gt;
</span><span class="gi">+</span><span class="gi">   &lt;/:actions&gt;
</span><span class="n">  &lt;/.header&gt;</span></code></pre><p>We added a link with <code class="inline">method=&quot;post&quot;</code> to send a POST request to our <code class="inline">OrderController.create</code> action. If we head back to our cart page at <a href="http://localhost:4000/cart"><code class="inline">http://localhost:4000/cart</code></a> and complete an order, we'll be greeted by our rendered template:</p><pre><code class="text">Thank you for your order!

User uuid: 08964c7c-908c-4a55-bcd3-9811ad8b0b9d
Title                   Quantity Price
Metaprogramming Elixir  2        $15.00

Total price: $30.00</code></pre><p>Nice work! We haven't added payments, but we can already see how our <code class="inline">ShoppingCart</code> and <code class="inline">Orders</code> context splitting is driving us towards a maintainable solution. With our cart items separated from our order line items, we are well equipped in the future to add payment transactions, cart price detection, and more.</p><p>Great work!</p><h2 id="faq" class="section-heading">
  <a href="#faq" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">FAQ</span>
</h2>
<h3 id="when-to-use-code-generators" class="section-heading">
  <a href="#when-to-use-code-generators" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">When to use code generators?</span>
</h3>
<p>In this guide, we have used code generators for schemas, contexts, controllers, and more. If you are happy to move forward with Phoenix defaults, feel free to rely on generators to scaffold large parts of your application. When using Phoenix generators, the main question you need to answer is: does this new functionality (with its schema, table, and fields) belong to one of the existing contexts or a new one?</p><p>This way, Phoenix generators guide you to use contexts to group related functionality, instead of having several dozens of schemas laying around without any structure. And remember: if you're stuck when trying to come up with a context name, you can simply use the plural form of the resource you're creating.</p><h3 id="how-do-i-structure-code-inside-contexts" class="section-heading">
  <a href="#how-do-i-structure-code-inside-contexts" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">How do I structure code inside contexts?</span>
</h3>
<p>You may wonder how to organize the code inside contexts. For example, should you define a module for changesets (such as ProductChangesets) and another module for queries (such as ProductQueries)?</p><p>One important benefit of contexts is that this decision does not matter much. The context is your public API, the other modules are private. Contexts isolate these modules into small groups so the surface area of your application is the context and not <em>all of your code</em>.</p><p>So while you and your team could establish patterns for organizing these private modules, it is also our opinion it is completely fine for them to be different. The major focus should be on how the contexts are defined and how they interact with each other (and with your web application).</p><p>Think about it as a well-kept neighbourhood. Your contexts are houses, you want to keep them well-preserved, well-connected, etc. Inside the houses, they may all be a little bit different, and that's fine.</p><h3 id="returning-ecto-structures-from-context-apis" class="section-heading">
  <a href="#returning-ecto-structures-from-context-apis" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Returning Ecto structures from context APIs</span>
</h3>
<p>As we explored the context API, you might have wondered:</p><blockquote><p>If one of the goals of our context is to encapsulate Ecto Repo access, why does <code class="inline">create_user/1</code> return an <a href="https://hexdocs.pm/ecto/3.10.1/Ecto.Changeset.html"><code class="inline">Ecto.Changeset</code></a> struct when we fail to create a user?</p></blockquote><p>Although Changesets are part of Ecto, they are not tied to the database, and they can be used to map data from and to any source, which makes it a general and useful data structure for tracking field changes, perform validations, and generate error messages.</p><p>For those reasons, <code class="inline">%Ecto.Changeset{}</code> is a good choice to model the data changes between your contexts and your web layer - regardless if you are talking to an API or the database.</p><p>Finally, note that your controllers and views are not hardcoded to work exclusively with Ecto either. Instead, Phoenix defines protocols such as <a href="Phoenix.Param.xhtml"><code class="inline">Phoenix.Param</code></a> and <a href="https://hexdocs.pm/phoenix_html/4.0.0/Phoenix.HTML.FormData.html"><code class="inline">Phoenix.HTML.FormData</code></a>, which allow any library to extend how Phoenix generates URL parameters or renders forms. Conveniently for us, the <code class="inline">phoenix_ecto</code> project implements those protocols, but you could as well bring your own data structures and implement them yourself.</p>

  </body>
</html>
