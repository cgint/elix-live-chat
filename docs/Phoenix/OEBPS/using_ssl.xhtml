<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
      xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>Using SSL - Phoenix v1.7.21</title>
    <meta name="generator" content="ExDoc v0.37.3" />
    <link type="text/css" rel="stylesheet" href="dist/epub-elixir-FNUUKFP7.css" />
    <script src="dist/epub-4WIP524F.js"></script>

  </head>
  <body class="content-inner">

    <h1 id="content">
Using SSL
    </h1>
<p>To prepare an application to serve requests over SSL, we need to add a little bit of configuration and two environment variables. In order for SSL to actually work, we'll need a key file and certificate file from a certificate authority. The environment variables that we'll need are paths to those two files.</p><p>The configuration consists of a new <code class="inline">https:</code> key for our endpoint whose value is a keyword list of port, path to the key file, and path to the cert (PEM) file. If we add the <code class="inline">otp_app:</code> key whose value is the name of our application, Plug will begin to look for them at the root of our application. We can then put those files in our <code class="inline">priv</code> directory and set the paths to <code class="inline">priv/our_keyfile.key</code> and <code class="inline">priv/our_cert.crt</code>.</p><p>Here's an example configuration from <code class="inline">config/runtime.exs</code>.</p><pre><code class="makeup elixir" translate="no"><span class="kn">import</span><span class="w"> </span><span class="nc">Config</span><span class="w">

</span><span class="n">config</span><span class="w"> </span><span class="ss">:hello</span><span class="p">,</span><span class="w"> </span><span class="nc">HelloWeb.Endpoint</span><span class="p">,</span><span class="w">
  </span><span class="ss">http</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3918767290-1">[</span><span class="ss">port</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3918767290-2">{</span><span class="ss">:system</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PORT&quot;</span><span class="p" data-group-id="3918767290-2">}</span><span class="p" data-group-id="3918767290-1">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">url</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3918767290-3">[</span><span class="ss">host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;example.com&quot;</span><span class="p" data-group-id="3918767290-3">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">cache_static_manifest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;priv/static/cache_manifest.json&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">https</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3918767290-4">[</span><span class="w">
    </span><span class="ss">port</span><span class="p">:</span><span class="w"> </span><span class="mi">443</span><span class="p">,</span><span class="w">
    </span><span class="ss">cipher_suite</span><span class="p">:</span><span class="w"> </span><span class="ss">:strong</span><span class="p">,</span><span class="w">
    </span><span class="ss">otp_app</span><span class="p">:</span><span class="w"> </span><span class="ss">:hello</span><span class="p">,</span><span class="w">
    </span><span class="ss">keyfile</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="3918767290-5">(</span><span class="s">&quot;SOME_APP_SSL_KEY_PATH&quot;</span><span class="p" data-group-id="3918767290-5">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">certfile</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="3918767290-6">(</span><span class="s">&quot;SOME_APP_SSL_CERT_PATH&quot;</span><span class="p" data-group-id="3918767290-6">)</span><span class="p">,</span><span class="w">
    </span><span class="c1"># OPTIONAL Key for intermediate certificates:</span><span class="w">
    </span><span class="ss">cacertfile</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="3918767290-7">(</span><span class="s">&quot;INTERMEDIATE_CERTFILE_PATH&quot;</span><span class="p" data-group-id="3918767290-7">)</span><span class="w">
  </span><span class="p" data-group-id="3918767290-4">]</span><span class="w">
</span></code></pre><p>Without the <code class="inline">otp_app:</code> key, we need to provide absolute paths to the files wherever they are on the filesystem in order for Plug to find them.</p><pre><code class="makeup elixir" translate="no"><span class="nc">Path</span><span class="o">.</span><span class="n">expand</span><span class="p" data-group-id="0333490260-1">(</span><span class="s">&quot;../../../some/path/to/ssl/key.pem&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">__DIR__</span><span class="p" data-group-id="0333490260-1">)</span></code></pre><p>The options under the <code class="inline">https:</code> key are passed to the Plug adapter, typically <code class="inline">Bandit</code>, which in turn uses <a href="https://hexdocs.pm/plug/1.15.3/Plug.SSL.html"><code class="inline">Plug.SSL</code></a> to select the TLS socket options. Please refer to the documentation for <a href="https://hexdocs.pm/plug/Plug.SSL.html#configure/1">Plug.SSL.configure/1</a> for more information on the available options and their defaults. The <a href="https://hexdocs.pm/plug/https.html">Plug HTTPS Guide</a> and the <a href="https://www.erlang.org/doc/man/ssl.html">Erlang/OTP ssl</a> documentation also provide valuable information.</p><h2 id="ssl-in-development" class="section-heading">
  <a href="#ssl-in-development" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">SSL in Development</span>
</h2>
<p>If you would like to use HTTPS in development, a self-signed certificate can be generated by running: <a href="Mix.Tasks.Phx.Gen.Cert.xhtml"><code class="inline">mix phx.gen.cert</code></a>. This requires Erlang/OTP 20 or later.</p><p>With your self-signed certificate, your development configuration in <code class="inline">config/dev.exs</code> can be updated to run an HTTPS endpoint:</p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:my_app</span><span class="p">,</span><span class="w"> </span><span class="nc">MyAppWeb.Endpoint</span><span class="p">,</span><span class="w">
  </span><span class="n">...</span><span class="w">
  </span><span class="ss">https</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6922136284-1">[</span><span class="w">
    </span><span class="ss">port</span><span class="p">:</span><span class="w"> </span><span class="mi">4001</span><span class="p">,</span><span class="w">
    </span><span class="ss">cipher_suite</span><span class="p">:</span><span class="w"> </span><span class="ss">:strong</span><span class="p">,</span><span class="w">
    </span><span class="ss">keyfile</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;priv/cert/selfsigned_key.pem&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">certfile</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;priv/cert/selfsigned.pem&quot;</span><span class="w">
  </span><span class="p" data-group-id="6922136284-1">]</span></code></pre><p>This can replace your <code class="inline">http</code> configuration, or you can run HTTP and HTTPS servers on different ports.</p><h2 id="force-ssl" class="section-heading">
  <a href="#force-ssl" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Force SSL</span>
</h2>
<p>In many cases, you'll want to force all incoming requests to use SSL by redirecting HTTP to HTTPS. This can be accomplished by setting the <code class="inline">:force_ssl</code> option in your endpoint configuration. It expects a list of options which are forwarded to <a href="https://hexdocs.pm/plug/1.15.3/Plug.SSL.html"><code class="inline">Plug.SSL</code></a>. By default, it sets the &quot;strict-transport-security&quot; header in HTTPS requests, forcing browsers to always use HTTPS. If an unsafe (HTTP) request is sent, it redirects to the HTTPS version using the <code class="inline">:host</code> specified in the <code class="inline">:url</code> configuration. For example:</p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:my_app</span><span class="p">,</span><span class="w"> </span><span class="nc">MyAppWeb.Endpoint</span><span class="p">,</span><span class="w">
  </span><span class="ss">force_ssl</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1291668951-1">[</span><span class="ss">rewrite_on</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1291668951-2">[</span><span class="ss">:x_forwarded_proto</span><span class="p" data-group-id="1291668951-2">]</span><span class="p" data-group-id="1291668951-1">]</span></code></pre><p>To dynamically redirect to the <code class="inline">host</code> of the current request, set <code class="inline">:host</code> in the <code class="inline">:force_ssl</code> configuration to <code class="inline">nil</code>.</p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:my_app</span><span class="p">,</span><span class="w"> </span><span class="nc">MyAppWeb.Endpoint</span><span class="p">,</span><span class="w">
  </span><span class="ss">force_ssl</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6468771113-1">[</span><span class="ss">rewrite_on</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6468771113-2">[</span><span class="ss">:x_forwarded_proto</span><span class="p" data-group-id="6468771113-2">]</span><span class="p">,</span><span class="w"> </span><span class="ss">host</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="6468771113-1">]</span></code></pre><p>In these examples, the <code class="inline">rewrite_on:</code> key specifies the HTTP header used by a reverse proxy or load balancer in front of the application to indicate whether the request was received over HTTP or HTTPS. For more information on the implications of offloading TLS to an external element, in particular relating to secure cookies, refer to the <a href="https://hexdocs.pm/plug/https.html#offloading-tls">Plug HTTPS Guide</a>. Keep in mind that the options passed to <a href="https://hexdocs.pm/plug/1.15.3/Plug.SSL.html"><code class="inline">Plug.SSL</code></a> in that document should be set using the <code class="inline">force_ssl:</code> endpoint option in a Phoenix application.</p><p>It is important to note that <code class="inline">force_ssl:</code> is a <em>compile</em> time config, so it normally is set in <code class="inline">prod.exs</code>, it will not work when set from <code class="inline">runtime.exs</code>.</p><h2 id="hsts" class="section-heading">
  <a href="#hsts" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">HSTS</span>
</h2>
<p>HSTS, short for 'HTTP Strict-Transport-Security', is a mechanism that allows websites to declare themselves as accessible exclusively through a secure connection (HTTPS). It was introduced to prevent man-in-the-middle attacks that strip SSL/TLS encryption. HSTS causes web browsers to redirect from HTTP to HTTPS and to refuse to connect unless the connection uses SSL/TLS.</p><p>With <code class="inline">force_ssl: [hsts: true]</code> set, the <code class="inline">Strict-Transport-Security</code> header is added with a max-age that defines the duration for which the policy is valid. Modern web browsers will respond to this by redirecting from HTTP to HTTPS, among other consequences. <a href="https://tools.ietf.org/html/rfc6797">RFC6797</a>, which defines HSTS, also specifies that <strong>the browser should keep track of a host's policy and apply it until it expires.</strong> It further specifies that <strong>traffic on any port other than 80 is assumed to be encrypted</strong> as per the policy.</p><p>While HSTS is recommended in production, it can lead to unexpected behavior when accessing applications on localhost. For instance, accessing an application with HSTS enabled at <code class="inline">https://localhost:4000</code> leads to a situation where all subsequent traffic from localhost, except for port 80, is expected to be encrypted. This can disrupt traffic to other local servers or proxies running on your computer that are unrelated to your Phoenix application and may not support encrypted traffic.</p><p>If you inadvertently enable HSTS for localhost, you may need to reset your browser's cache before it will accept HTTP traffic from localhost again.</p><p>For Chrome:</p><ol><li>Open the Developer Tools Panel.</li><li>Click and hold the reload icon next to the address bar to reveal a dropdown menu.</li><li>Select &quot;Empty Cache and Hard Reload&quot;.</li></ol><p>For Safari:</p><ol><li>Clear your browser cache.</li><li>Remove the entry from <code class="inline">~/Library/Cookies/HSTS.plist</code> or delete the file entirely.</li><li>Restart Safari.</li></ol><p>For other browsers, please consult the documentation for HSTS.</p><p>Alternatively, setting the <code class="inline">:expires</code> option on <code class="inline">force_ssl</code> to <code class="inline">0</code> should expire the entry and disable HSTS.</p><p>For more information on HSTS options, see <a href="https://hexdocs.pm/plug/Plug.SSL.html">Plug.SSL</a>.</p>

  </body>
</html>
