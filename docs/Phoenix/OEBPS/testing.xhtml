<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
      xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>Introduction to Testing - Phoenix v1.7.21</title>
    <meta name="generator" content="ExDoc v0.37.3" />
    <link type="text/css" rel="stylesheet" href="dist/epub-elixir-FNUUKFP7.css" />
    <script src="dist/epub-4WIP524F.js"></script>

  </head>
  <body class="content-inner">

    <h1 id="content">
Introduction to Testing
    </h1>
<blockquote><p><strong>Requirement</strong>: This guide expects that you have gone through the <a href="installation.html">introductory guides</a> and got a Phoenix application <a href="up_and_running.html">up and running</a>.</p></blockquote><p>Testing has become integral to the software development process, and the ability to easily write meaningful tests is an indispensable feature for any modern web framework. Phoenix takes this seriously, providing support files to make all the major components of the framework easy to test. It also generates test modules with real-world examples alongside any generated modules to help get us going.</p><p>Elixir ships with a built-in testing framework called <a href="https://hexdocs.pm/ex_unit">ExUnit</a>. ExUnit strives to be clear and explicit, keeping magic to a minimum. Phoenix uses ExUnit for all of its testing, and we will use it here as well.</p><h2 id="running-tests" class="section-heading">
  <a href="#running-tests" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Running tests</span>
</h2>
<p>When Phoenix generates a web application for us, it also includes tests. To run them, simply type <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html"><code class="inline">mix test</code></a>:</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test
</span><span class="">....
</span><span class="">
</span><span class="">Finished in 0.09 seconds
</span><span class="">5 tests, 0 failures
</span><span class="">
</span><span class="">Randomized with seed 652656
</span></code></pre><p>We already have five tests!</p><p>In fact, we already have a directory structure completely set up for testing, including a test helper and support files.</p><pre><code class="makeup console" translate="no"><span class="">test
</span><span class="">├── hello_web
</span><span class="">│   └── controllers
</span><span class="">│       ├── error_html_test.exs
</span><span class="">│       ├── error_json_test.exs
</span><span class="">│       └── page_controller_test.exs
</span><span class="">├── support
</span><span class="">│   ├── conn_case.ex
</span><span class="">│   └── data_case.ex
</span><span class="">└── test_helper.exs
</span></code></pre><p>The test cases we get for free include those from <code class="inline">test/hello_web/controllers/</code>. They are testing our controllers and views. If you haven't read the guides for controllers and views, now is a good time.</p><h2 id="understanding-test-modules" class="section-heading">
  <a href="#understanding-test-modules" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Understanding test modules</span>
</h2>
<p>We are going to use the next sections to get acquainted with Phoenix testing structure. We will start with the three test files generated by Phoenix.</p><p>The first test file we'll look at is <code class="inline">test/hello_web/controllers/page_controller_test.exs</code>.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.PageControllerTest</span><span class="w"> </span><span class="k" data-group-id="5229314953-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb.ConnCase</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;GET /&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5229314953-2">%{</span><span class="ss">conn</span><span class="p">:</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="5229314953-2">}</span><span class="w"> </span><span class="k" data-group-id="5229314953-3">do</span><span class="w">
    </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p" data-group-id="5229314953-4">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="sx">~p&quot;/&quot;</span><span class="p" data-group-id="5229314953-4">)</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="n">html_response</span><span class="p" data-group-id="5229314953-5">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p" data-group-id="5229314953-5">)</span><span class="w"> </span><span class="o">=~</span><span class="w"> </span><span class="s">&quot;Peace of mind from prototype to production&quot;</span><span class="w">
  </span><span class="k" data-group-id="5229314953-3">end</span><span class="w">
</span><span class="k" data-group-id="5229314953-1">end</span></code></pre><p>There are a couple of interesting things happening here.</p><p>Our test files simply define modules. At the top of each module, you will find a line such as:</p><pre><code class="makeup elixir" translate="no"><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb.ConnCase</span></code></pre><p>If you were to write an Elixir library, outside of Phoenix, instead of <code class="inline">use HelloWeb.ConnCase</code> you would write <code class="inline">use ExUnit.Case</code>. However, Phoenix already ships with a bunch of functionality for testing controllers and <code class="inline">HelloWeb.ConnCase</code> builds on top of <a href="https://hexdocs.pm/ex_unit/ExUnit.Case.html"><code class="inline">ExUnit.Case</code></a> to bring these functionalities in. We will explore the <code class="inline">HelloWeb.ConnCase</code> module soon.</p><p>Then we define each test using the <code class="inline">test/3</code> macro. The <code class="inline">test/3</code> macro receives three arguments: the test name, the testing context that we are pattern matching on, and the contents of the test. In this test, we access the root page of our application by a &quot;GET&quot; HTTP request on the path &quot;/&quot; with the <code class="inline">get/2</code> macro. Then we <strong>assert</strong> that the rendered page contains the string &quot;Peace of mind from prototype to production&quot;.</p><p>When writing tests in Elixir, we use assertions to check that something is true. In our case, <code class="inline">assert html_response(conn, 200) =~ &quot;Peace of mind from prototype to production&quot;</code> is doing a couple things:</p><ul><li>It asserts that <code class="inline">conn</code> has rendered a response</li><li>It asserts that the response has the 200 status code (which means OK in HTTP parlance)</li><li>It asserts that the type of the response is HTML</li><li>It asserts that the result of <code class="inline">html_response(conn, 200)</code>, which is an HTML response, has the string &quot;Peace of mind from prototype to production&quot; in it</li></ul><p>However, from where does the <code class="inline">conn</code> we use on <code class="inline">get</code> and <code class="inline">html_response</code> come from? To answer this question, let's take a look at <code class="inline">HelloWeb.ConnCase</code>.</p><h2 id="the-conncase" class="section-heading">
  <a href="#the-conncase" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">The ConnCase</span>
</h2>
<p>If you open up <code class="inline">test/support/conn_case.ex</code>, you will find this (with comments removed):</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.ConnCase</span><span class="w"> </span><span class="k" data-group-id="6679342819-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExUnit.CaseTemplate</span><span class="w">

  </span><span class="n">using</span><span class="w"> </span><span class="k" data-group-id="6679342819-2">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="6679342819-3">do</span><span class="w">
      </span><span class="c1"># The default endpoint for testing</span><span class="w">
      </span><span class="na">@endpoint</span><span class="w"> </span><span class="nc">HelloWeb.Endpoint</span><span class="w">

      </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:verified_routes</span><span class="w">

      </span><span class="c1"># Import conveniences for testing with connections</span><span class="w">
      </span><span class="kn">import</span><span class="w"> </span><span class="nc">Plug.Conn</span><span class="w">
      </span><span class="kn">import</span><span class="w"> </span><span class="nc">Phoenix.ConnTest</span><span class="w">
      </span><span class="kn">import</span><span class="w"> </span><span class="nc">HelloWeb.ConnCase</span><span class="w">
    </span><span class="k" data-group-id="6679342819-3">end</span><span class="w">
  </span><span class="k" data-group-id="6679342819-2">end</span><span class="w">
  
  </span><span class="n">setup</span><span class="w"> </span><span class="n">tags</span><span class="w"> </span><span class="k" data-group-id="6679342819-4">do</span><span class="w">
    </span><span class="nc">Hello.DataCase</span><span class="o">.</span><span class="n">setup_sandbox</span><span class="p" data-group-id="6679342819-5">(</span><span class="n">tags</span><span class="p" data-group-id="6679342819-5">)</span><span class="w">
    </span><span class="p" data-group-id="6679342819-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">conn</span><span class="p">:</span><span class="w"> </span><span class="nc">Phoenix.ConnTest</span><span class="o">.</span><span class="n">build_conn</span><span class="p" data-group-id="6679342819-7">(</span><span class="p" data-group-id="6679342819-7">)</span><span class="p" data-group-id="6679342819-6">}</span><span class="w">
  </span><span class="k" data-group-id="6679342819-4">end</span><span class="w">
</span><span class="k" data-group-id="6679342819-1">end</span></code></pre><p>There is a lot to unpack here.</p><p>The second line says this is a case template. This is a ExUnit feature that allows developers to replace the built-in <code class="inline">use ExUnit.Case</code> by their own case. This line is pretty much what allows us to write <code class="inline">use HelloWeb.ConnCase</code> at the top of our controller tests.</p><p>Now that we have made this module a case template, we can define callbacks that are invoked on certain occasions. The <code class="inline">using</code> callback defines code to be injected on every module that calls <code class="inline">use HelloWeb.ConnCase</code>. In this case, it starts by setting the <code class="inline">@endpoint</code> module attribute with the name of our endpoint.</p><p>Next, it wires up <code class="inline">:verified_routes</code> to allow us to use <code class="inline">~p</code> based paths in our test just like we do in the rest of our application to easily generate paths and URLs in our tests.</p><p>Finally, we import <a href="https://hexdocs.pm/plug/Plug.Conn.html"><code class="inline">Plug.Conn</code></a>, so all of the connection helpers available in controllers are also available in tests, and then imports <a href="https://hexdocs.pm/phoenix/Phoenix.ConnTest.html"><code class="inline">Phoenix.ConnTest</code></a>. You can consult these modules to learn all functionality available.</p><p>Then our case template defines a <code class="inline">setup</code> block. The <code class="inline">setup</code> block will be called before test. Most of the setup block is on setting up the SQL Sandbox, which we will talk about later. In the last line of the <code class="inline">setup</code> block, we will find this:</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="8147916175-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">conn</span><span class="p">:</span><span class="w"> </span><span class="nc">Phoenix.ConnTest</span><span class="o">.</span><span class="n">build_conn</span><span class="p" data-group-id="8147916175-2">(</span><span class="p" data-group-id="8147916175-2">)</span><span class="p" data-group-id="8147916175-1">}</span></code></pre><p>The last line of <code class="inline">setup</code> can return test metadata that will be available in each test. The metadata we are passing forward here is a newly built <a href="https://hexdocs.pm/plug/1.15.3/Plug.Conn.html"><code class="inline">Plug.Conn</code></a>. In our test, we extract the connection out of this metadata at the very beginning of our test:</p><pre><code class="makeup elixir" translate="no"><span class="n">test</span><span class="w"> </span><span class="s">&quot;GET /&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1913432671-1">%{</span><span class="ss">conn</span><span class="p">:</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="1913432671-1">}</span><span class="w"> </span><span class="k" data-group-id="1913432671-2">do</span></code></pre><p>And that's where the connection comes from! At first, the testing structure does come with a bit of indirection, but this indirection pays off as our test suite grows, since it allows us to cut down the amount of boilerplate.</p><h2 id="view-tests" class="section-heading">
  <a href="#view-tests" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">View tests</span>
</h2>
<p>The other test files in our application are responsible for testing our views.</p><p>The error view test case, <code class="inline">test/hello_web/controllers/error_html_test.exs</code>, illustrates a few interesting things of its own.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.ErrorHTMLTest</span><span class="w"> </span><span class="k" data-group-id="8113752921-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb.ConnCase</span><span class="p">,</span><span class="w"> </span><span class="ss">async</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">

  </span><span class="c1"># Bring render_to_string/4 for testing custom views</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Phoenix.Template</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;renders 404.html&quot;</span><span class="w"> </span><span class="k" data-group-id="8113752921-2">do</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="n">render_to_string</span><span class="p" data-group-id="8113752921-3">(</span><span class="nc">HelloWeb.ErrorHTML</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8113752921-4">[</span><span class="p" data-group-id="8113752921-4">]</span><span class="p" data-group-id="8113752921-3">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Not Found&quot;</span><span class="w">
  </span><span class="k" data-group-id="8113752921-2">end</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;renders 500.html&quot;</span><span class="w"> </span><span class="k" data-group-id="8113752921-5">do</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="n">render_to_string</span><span class="p" data-group-id="8113752921-6">(</span><span class="nc">HelloWeb.ErrorHTML</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;500&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8113752921-7">[</span><span class="p" data-group-id="8113752921-7">]</span><span class="p" data-group-id="8113752921-6">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Internal Server Error&quot;</span><span class="w">
  </span><span class="k" data-group-id="8113752921-5">end</span><span class="w">
</span><span class="k" data-group-id="8113752921-1">end</span></code></pre><p><code class="inline">HelloWeb.ErrorHTMLTest</code> sets <code class="inline">async: true</code> which means that this test case will be run in parallel with other test cases. While individual tests within the case still run serially, this can greatly increase overall test speeds.</p><p>It also imports <a href="https://hexdocs.pm/phoenix_template/1.0.4/Phoenix.Template.html"><code class="inline">Phoenix.Template</code></a> in order to use the <code class="inline">render_to_string/4</code> function. With that, all the assertions can be simple string equality tests.</p><h2 id="running-tests-per-directory-file" class="section-heading">
  <a href="#running-tests-per-directory-file" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Running tests per directory/file</span>
</h2>
<p>Now that we have an idea what our tests are doing, let's look at different ways to run them.</p><p>As we saw near the beginning of this guide, we can run our entire suite of tests with <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html"><code class="inline">mix test</code></a>.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test
</span><span class="">....
</span><span class="">
</span><span class="">Finished in 0.2 seconds
</span><span class="">5 tests, 0 failures
</span><span class="">
</span><span class="">Randomized with seed 540755
</span></code></pre><p>If we would like to run all the tests in a given directory, <code class="inline">test/hello_web/controllers</code> for instance, we can pass the path to that directory to <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html"><code class="inline">mix test</code></a>.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test test/hello_web/controllers/
</span><span class="">.
</span><span class="">
</span><span class="">Finished in 0.2 seconds
</span><span class="">5 tests, 0 failures
</span><span class="">
</span><span class="">Randomized with seed 652376
</span></code></pre><p>In order to run all the tests in a specific file, we can pass the path to that file into <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html"><code class="inline">mix test</code></a>.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test test/hello_web/controllers/error_html_test.exs
</span><span class="">...
</span><span class="">
</span><span class="">Finished in 0.2 seconds
</span><span class="">2 tests, 0 failures
</span><span class="">
</span><span class="">Randomized with seed 220535
</span></code></pre><p>And we can run a single test in a file by appending a colon and a line number to the filename.</p><p>Let's say we only wanted to run the test for the way <code class="inline">HelloWeb.ErrorHTML</code> renders <code class="inline">500.html</code>. The test begins on line 11 of the file, so this is how we would do it.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test test/hello_web/controllers/error_html_test.exs:11
</span><span class="">Including tags: [line: &quot;11&quot;]
</span><span class="">Excluding tags: [:test]
</span><span class="">
</span><span class="">.
</span><span class="">
</span><span class="">Finished in 0.1 seconds
</span><span class="">2 tests, 0 failures, 1 excluded
</span><span class="">
</span><span class="">Randomized with seed 288117
</span></code></pre><p>We chose to run this specifying the first line of the test, but actually, any line of that test will do. These line numbers would all work - <code class="inline">:11</code>, <code class="inline">:12</code>, or <code class="inline">:13</code>.</p><h2 id="running-tests-using-tags" class="section-heading">
  <a href="#running-tests-using-tags" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Running tests using tags</span>
</h2>
<p>ExUnit allows us to tag our tests individually or for the whole module. We can then choose to run only the tests with a specific tag, or we can exclude tests with that tag and run everything else.</p><p>Let's experiment with how this works.</p><p>First, we'll add a <code class="inline">@moduletag</code> to <code class="inline">test/hello_web/controllers/error_html_test.exs</code>.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.ErrorHTMLTest</span><span class="w"> </span><span class="k" data-group-id="4728265693-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb.ConnCase</span><span class="p">,</span><span class="w"> </span><span class="ss">async</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">

  </span><span class="na">@moduletag</span><span class="w"> </span><span class="ss">:error_view_case</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="4728265693-1">end</span></code></pre><p>If we use only an atom for our module tag, ExUnit assumes that it has a value of <code class="inline">true</code>. We could also specify a different value if we wanted.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.ErrorHTMLTest</span><span class="w"> </span><span class="k" data-group-id="8884903409-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb.ConnCase</span><span class="p">,</span><span class="w"> </span><span class="ss">async</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">

  </span><span class="na">@moduletag</span><span class="w"> </span><span class="ss">error_view_case</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;some_interesting_value&quot;</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="8884903409-1">end</span></code></pre><p>For now, let's leave it as a simple atom <code class="inline">@moduletag :error_view_case</code>.</p><p>We can run only the tests from the error view case by passing <code class="inline">--only error_view_case</code> into <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html"><code class="inline">mix test</code></a>.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test --only error_view_case
</span><span class="">Including tags: [:error_view_case]
</span><span class="">Excluding tags: [:test]
</span><span class="">
</span><span class="">...
</span><span class="">
</span><span class="">Finished in 0.1 seconds
</span><span class="">5 tests, 0 failures, 3 excluded
</span><span class="">
</span><span class="">Randomized with seed 125659
</span></code></pre><blockquote><p>Note: ExUnit tells us exactly which tags it is including and excluding for each test run. If we look back to the previous section on running tests, we'll see that line numbers specified for individual tests are actually treated as tags.</p></blockquote><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test test/hello_web/controllers/error_html_test.exs:11
</span><span class="">Including tags: [line: &quot;11&quot;]
</span><span class="">Excluding tags: [:test]
</span><span class="">
</span><span class="">.
</span><span class="">
</span><span class="">Finished in 0.2 seconds
</span><span class="">2 tests, 0 failures, 1 excluded
</span><span class="">
</span><span class="">Randomized with seed 364723
</span></code></pre><p>Specifying a value of <code class="inline">true</code> for <code class="inline">error_view_case</code> yields the same results.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test --only error_view_case:true
</span><span class="">Including tags: [error_view_case: &quot;true&quot;]
</span><span class="">Excluding tags: [:test]
</span><span class="">
</span><span class="">...
</span><span class="">
</span><span class="">Finished in 0.1 seconds
</span><span class="">5 tests, 0 failures, 3 excluded
</span><span class="">
</span><span class="">Randomized with seed 833356
</span></code></pre><p>Specifying <code class="inline">false</code> as the value for <code class="inline">error_view_case</code>, however, will not run any tests because no tags in our system match <code class="inline">error_view_case: false</code>.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test --only error_view_case:false
</span><span class="">Including tags: [error_view_case: &quot;false&quot;]
</span><span class="">Excluding tags: [:test]
</span><span class="">
</span><span class="">
</span><span class="">
</span><span class="">Finished in 0.1 seconds
</span><span class="">5 tests, 0 failures, 5 excluded
</span><span class="">
</span><span class="">Randomized with seed 622422
</span><span class="">The --only option was given to &quot;mix test&quot; but no test executed
</span></code></pre><p>We can use the <code class="inline">--exclude</code> flag in a similar way. This will run all of the tests except those in the error view case.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test --exclude error_view_case
</span><span class="">Excluding tags: [:error_view_case]
</span><span class="">
</span><span class="">.
</span><span class="">
</span><span class="">Finished in 0.2 seconds
</span><span class="">5 tests, 0 failures, 2 excluded
</span><span class="">
</span><span class="">Randomized with seed 682868
</span></code></pre><p>Specifying values for a tag works the same way for <code class="inline">--exclude</code> as it does for <code class="inline">--only</code>.</p><p>We can tag individual tests as well as full test cases. Let's tag a few tests in the error view case to see how this works.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.ErrorHTMLTest</span><span class="w"> </span><span class="k" data-group-id="2141874461-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb.ConnCase</span><span class="p">,</span><span class="w"> </span><span class="ss">async</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">

  </span><span class="na">@moduletag</span><span class="w"> </span><span class="ss">:error_view_case</span><span class="w">

  </span><span class="c1"># Bring render/4 and render_to_string/4 for testing custom views</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Phoenix.Template</span><span class="w">

  </span><span class="na">@tag</span><span class="w"> </span><span class="ss">individual_test</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yup&quot;</span><span class="w">
  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;renders 404.html&quot;</span><span class="w"> </span><span class="k" data-group-id="2141874461-2">do</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="n">render_to_string</span><span class="p" data-group-id="2141874461-3">(</span><span class="nc">HelloWeb.ErrorView</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;404&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2141874461-4">[</span><span class="p" data-group-id="2141874461-4">]</span><span class="p" data-group-id="2141874461-3">)</span><span class="w"> </span><span class="o">==</span><span class="w">
           </span><span class="s">&quot;Not Found&quot;</span><span class="w">
  </span><span class="k" data-group-id="2141874461-2">end</span><span class="w">

  </span><span class="na">@tag</span><span class="w"> </span><span class="ss">individual_test</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nope&quot;</span><span class="w">
  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;renders 500.html&quot;</span><span class="w"> </span><span class="k" data-group-id="2141874461-5">do</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="n">render_to_string</span><span class="p" data-group-id="2141874461-6">(</span><span class="nc">HelloWeb.ErrorView</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;500&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2141874461-7">[</span><span class="p" data-group-id="2141874461-7">]</span><span class="p" data-group-id="2141874461-6">)</span><span class="w"> </span><span class="o">==</span><span class="w">
           </span><span class="s">&quot;Internal Server Error&quot;</span><span class="w">
  </span><span class="k" data-group-id="2141874461-5">end</span><span class="w">
</span><span class="k" data-group-id="2141874461-1">end</span></code></pre><p>If we would like to run only tests tagged as <code class="inline">individual_test</code>, regardless of their value, this will work.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test --only individual_test
</span><span class="">Including tags: [:individual_test]
</span><span class="">Excluding tags: [:test]
</span><span class="">
</span><span class="">..
</span><span class="">
</span><span class="">Finished in 0.1 seconds
</span><span class="">5 tests, 0 failures, 3 excluded
</span><span class="">
</span><span class="">Randomized with seed 813729
</span></code></pre><p>We can also specify a value and run only tests with that.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test --only individual_test:yup
</span><span class="">Including tags: [individual_test: &quot;yup&quot;]
</span><span class="">Excluding tags: [:test]
</span><span class="">
</span><span class="">.
</span><span class="">
</span><span class="">Finished in 0.1 seconds
</span><span class="">5 tests, 0 failures, 4 excluded
</span><span class="">
</span><span class="">Randomized with seed 770938
</span></code></pre><p>Similarly, we can run all tests except for those tagged with a given value.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test --exclude individual_test:nope
</span><span class="">Excluding tags: [individual_test: &quot;nope&quot;]
</span><span class="">
</span><span class="">...
</span><span class="">
</span><span class="">Finished in 0.2 seconds
</span><span class="">5 tests, 0 failures, 1 excluded
</span><span class="">
</span><span class="">Randomized with seed 539324
</span></code></pre><p>We can be more specific and exclude all the tests from the error view case except the one tagged with <code class="inline">individual_test</code> that has the value &quot;yup&quot;.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test --exclude error_view_case --include individual_test:yup
</span><span class="">Including tags: [individual_test: &quot;yup&quot;]
</span><span class="">Excluding tags: [:error_view_case]
</span><span class="">
</span><span class="">..
</span><span class="">
</span><span class="">Finished in 0.2 seconds
</span><span class="">5 tests, 0 failures, 1 excluded
</span><span class="">
</span><span class="">Randomized with seed 61472
</span></code></pre><p>Finally, we can configure ExUnit to exclude tags by default. The default ExUnit configuration is done in the <code class="inline">test/test_helper.exs</code> file:</p><pre><code class="makeup elixir" translate="no"><span class="nc">ExUnit</span><span class="o">.</span><span class="n">start</span><span class="p" data-group-id="8565710809-1">(</span><span class="ss">exclude</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8565710809-2">[</span><span class="ss">error_view_case</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="8565710809-2">]</span><span class="p" data-group-id="8565710809-1">)</span><span class="w">

</span><span class="nc">Ecto.Adapters.SQL.Sandbox</span><span class="o">.</span><span class="n">mode</span><span class="p" data-group-id="8565710809-3">(</span><span class="nc">Hello.Repo</span><span class="p">,</span><span class="w"> </span><span class="ss">:manual</span><span class="p" data-group-id="8565710809-3">)</span></code></pre><p>Now when we run <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html"><code class="inline">mix test</code></a>, it only runs the specs from our <code class="inline">page_controller_test.exs</code> and <code class="inline">error_json_test.exs</code>.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test
</span><span class="">Excluding tags: [error_view_case: true]
</span><span class="">
</span><span class="">.
</span><span class="">
</span><span class="">Finished in 0.2 seconds
</span><span class="">5 tests, 0 failures, 2 excluded
</span><span class="">
</span><span class="">Randomized with seed 186055
</span></code></pre><p>We can override this behavior with the <code class="inline">--include</code> flag, telling <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html"><code class="inline">mix test</code></a> to include tests tagged with <code class="inline">error_view_case</code>.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test --include error_view_case
</span><span class="">Including tags: [:error_view_case]
</span><span class="">Excluding tags: [error_view_case: true]
</span><span class="">
</span><span class="">....
</span><span class="">
</span><span class="">Finished in 0.2 seconds
</span><span class="">5 tests, 0 failures
</span><span class="">
</span><span class="">Randomized with seed 748424
</span></code></pre><p>This technique can be very useful to control very long running tests, which you may only want to run in CI or in specific scenarios.</p><h2 id="randomization" class="section-heading">
  <a href="#randomization" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Randomization</span>
</h2>
<p>Running tests in random order is a good way to ensure that our tests are truly isolated. If we notice that we get sporadic failures for a given test, it may be because a previous test changes the state of the system in ways that aren't cleaned up afterward, thereby affecting the tests which follow. Those failures might only present themselves if the tests are run in a specific order.</p><p>ExUnit will randomize the order tests run in by default, using an integer to seed the randomization. If we notice that a specific random seed triggers our intermittent failure, we can re-run the tests with that same seed to reliably recreate that test sequence in order to help us figure out what the problem is.</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test --seed 401472
</span><span class="">....
</span><span class="">
</span><span class="">Finished in 0.2 seconds
</span><span class="">5 tests, 0 failures
</span><span class="">
</span><span class="">Randomized with seed 401472
</span></code></pre><h2 id="concurrency-and-partitioning" class="section-heading">
  <a href="#concurrency-and-partitioning" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Concurrency and partitioning</span>
</h2>
<p>As we have seen, ExUnit allows developers to run tests concurrently. This allows developers to use all of the power in their machine to run their test suites as fast as possible. Couple this with Phoenix performance, most test suites compile and run in a fraction of the time compared to other frameworks.</p><p>While developers usually have powerful machines available to them during development, this may not always be the case in your Continuous Integration servers. For this reason, ExUnit also supports out of the box test partitioning in test environments. If you open up your <code class="inline">config/test.exs</code>, you will find the database name set to:</p><pre><code class="makeup elixir" translate="no"><span class="ss">database</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;hello_test</span><span class="si" data-group-id="6571520528-1">#{</span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="6571520528-2">(</span><span class="s">&quot;MIX_TEST_PARTITION&quot;</span><span class="p" data-group-id="6571520528-2">)</span><span class="si" data-group-id="6571520528-1">}</span><span class="s">&quot;</span><span class="p">,</span></code></pre><p>By default, the <code class="inline">MIX_TEST_PARTITION</code> environment variable has no value, and therefore it has no effect. But in your CI server, you can, for example, split your test suite across machines by using four distinct commands:</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">MIX_TEST_PARTITION=1 mix test --partitions 4
</span><span class="gp unselectable">$ </span><span class="">MIX_TEST_PARTITION=2 mix test --partitions 4
</span><span class="gp unselectable">$ </span><span class="">MIX_TEST_PARTITION=3 mix test --partitions 4
</span><span class="gp unselectable">$ </span><span class="">MIX_TEST_PARTITION=4 mix test --partitions 4
</span></code></pre><p>That's all you need to do and ExUnit and Phoenix will take care of all rest, including setting up the database for each distinct partition with a distinct name.</p><h2 id="going-further" class="section-heading">
  <a href="#going-further" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Going further</span>
</h2>
<p>While ExUnit is a simple test framework, it provides a really flexible and robust test runner through the <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html"><code class="inline">mix test</code></a> command. We recommend you to run <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html"><code class="inline">mix help test</code></a> or <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html">read the docs online</a></p><p>We've seen what Phoenix gives us with a newly generated app. Furthermore, whenever you generate a new resource, Phoenix will generate all appropriate tests for that resource too. For example, you can create a complete scaffold with schema, context, controllers, and views by running the following command at the root of your application:</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix phx.gen.html Blog Post posts title body:text
</span><span class="">* creating lib/hello_web/controllers/post_controller.ex
</span><span class="">* creating lib/hello_web/controllers/post_html/edit.html.heex
</span><span class="">* creating lib/hello_web/controllers/post_html/index.html.heex
</span><span class="">* creating lib/hello_web/controllers/post_html/new.html.heex
</span><span class="">* creating lib/hello_web/controllers/post_html/show.html.heex
</span><span class="">* creating lib/hello_web/controllers/post_html/post_form.html.heex
</span><span class="">* creating lib/hello_web/controllers/post_html.ex
</span><span class="">* creating test/hello_web/controllers/post_controller_test.exs
</span><span class="">* creating lib/hello/blog/post.ex
</span><span class="">* creating priv/repo/migrations/20211001233016_create_posts.exs
</span><span class="">* creating lib/hello/blog.ex
</span><span class="">* injecting lib/hello/blog.ex
</span><span class="">* creating test/hello/blog_test.exs
</span><span class="">* injecting test/hello/blog_test.exs
</span><span class="">* creating test/support/fixtures/blog_fixtures.ex
</span><span class="">* injecting test/support/fixtures/blog_fixtures.ex
</span><span class="">
</span><span class="">Add the resource to your browser scope in lib/demo_web/router.ex:
</span><span class="">
</span><span class="">    resources &quot;/posts&quot;, PostController
</span><span class="">
</span><span class="">
</span><span class="">Remember to update your repository by running migrations:
</span><span class="">
</span><span class="">    $ mix ecto.migrate
</span><span class="">
</span></code></pre><p>Now let's follow the directions and add the new resources route to our <code class="inline">lib/hello_web/router.ex</code> file and run the migrations.</p><p>When we run <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html"><code class="inline">mix test</code></a> again, we see that we now have twenty-one tests!</p><pre><code class="makeup console" translate="no"><span class="gp unselectable">$ </span><span class="">mix test
</span><span class="">................
</span><span class="">
</span><span class="">Finished in 0.1 seconds
</span><span class="">21 tests, 0 failures
</span><span class="">
</span><span class="">Randomized with seed 537537
</span></code></pre><p>At this point, we are at a great place to transition to the rest of the testing guides, in which we'll examine these tests in much more detail, and add some of our own.</p>

  </body>
</html>
