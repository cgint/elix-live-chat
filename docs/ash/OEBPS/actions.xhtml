<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
      xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>Actions - ash v3.5.33</title>
    <meta name="generator" content="ExDoc v0.38.2" />
    <link type="text/css" rel="stylesheet" href="dist/epub-elixir-FNUUKFP7.css" />
    <script src="dist/epub-4WIP524F.js"></script>

  </head>
  <body class="content-inner">

    <h1 id="content">Actions</h1>
<p>In Ash, actions are the primary way to interact with your resources. There are five types of actions:</p><ul><li><a href="read-actions.xhtml">Read</a></li><li><a href="create-actions.xhtml">Create</a></li><li><a href="update-actions.xhtml">Update</a></li><li><a href="destroy-actions.xhtml">Destroy</a></li><li><a href="generic-actions.xhtml">Generic</a></li></ul><p>All actions can be run in a transaction. Create, update and destroy actions are run in a transaction by <em>default</em>, whereas read and generic actions require opting in with <code class="inline">transaction? true</code> in the action definition. Each action has its own set of options, ways of calling it, and ways of customizing it. See the relevant guide for specifics on each action type. This topic focuses on idiomatic ways to use actions, and concepts that cross all action types.</p><h2 id="primary-actions">Primary Actions</h2><p>Primary actions are a way to inform the framework which actions should be used in certain &quot;automated&quot; circumstances, or in cases where an action has not been specified. If a primary action is attempted to be used but does not exist, you will get an error about it at runtime.</p><p>The place you typically need primary actions is when <a href="relationships.xhtml#managing-relationships">Managing Relationships</a>. When using the <code class="inline">defaults</code> option to add default actions, they are marked as primary.</p><p>A simple example where a primary action would be used:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># No action is specified, so we look for a primary read.</span><span class="w">
</span><span class="nc">Ash</span><span class="o">.</span><span class="n">get!</span><span class="p" data-group-id="6422079102-1">(</span><span class="nc">Resource</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8ba0ab56-c6e3-4ab0-9c9c-df70e9945281&quot;</span><span class="p" data-group-id="6422079102-1">)</span></code></pre><p>To mark an action as primary, add the option, i.e</p><pre><code class="makeup elixir" translate="no"><span class="n">read</span><span class="w"> </span><span class="ss">:action_name</span><span class="w"> </span><span class="k" data-group-id="7990043015-1">do</span><span class="w">
  </span><span class="n">primary?</span><span class="w"> </span><span class="no">true</span><span class="w">
</span><span class="k" data-group-id="7990043015-1">end</span></code></pre><h2 id="accepting-inputs">Accepting Inputs</h2><p><a href="create-actions.xhtml">Create</a> and <a href="update-actions.xhtml">Update</a> actions can accept attributes as input. There are two primary ways that you annotate this.</p><h3 id="using-accept-in-specific-actions">Using <code class="inline">accept</code> in specific actions</h3><p>Each action can define what it accepts, for example:</p><pre><code class="makeup elixir" translate="no"><span class="n">create</span><span class="w"> </span><span class="ss">:create</span><span class="w"> </span><span class="k" data-group-id="2287196612-1">do</span><span class="w">
  </span><span class="n">accept</span><span class="w"> </span><span class="p" data-group-id="2287196612-2">[</span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:description</span><span class="p" data-group-id="2287196612-2">]</span><span class="w">
</span><span class="k" data-group-id="2287196612-1">end</span></code></pre><p>You could then pass in <code class="inline">%{name: &quot;a name&quot;, description: &quot;a description&quot;}</code> to this action.</p><h3 id="using-default_accept-for-all-actions">Using <code class="inline">default_accept</code> for all actions</h3><p>The resource can have a <code class="inline">default_accept</code>, declared in its <code class="inline">actions</code> block, which will be used as the accept list for <code class="inline">create</code> and <code class="inline">update</code> actions, if they don't define one.</p><pre><code class="makeup elixir" translate="no"><span class="n">actions</span><span class="w"> </span><span class="k" data-group-id="7697310894-1">do</span><span class="w">
  </span><span class="n">default_accept</span><span class="w"> </span><span class="p" data-group-id="7697310894-2">[</span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:description</span><span class="p" data-group-id="7697310894-2">]</span><span class="w">

  </span><span class="n">create</span><span class="w"> </span><span class="ss">:create</span><span class="w">
  </span><span class="n">update</span><span class="w"> </span><span class="ss">:update</span><span class="w">

  </span><span class="n">update</span><span class="w"> </span><span class="ss">:special_update</span><span class="w"> </span><span class="k" data-group-id="7697310894-3">do</span><span class="w">
    </span><span class="n">accept</span><span class="w"> </span><span class="p" data-group-id="7697310894-4">[</span><span class="ss">:something_else</span><span class="p" data-group-id="7697310894-4">]</span><span class="w">
  </span><span class="k" data-group-id="7697310894-3">end</span><span class="w">
</span><span class="k" data-group-id="7697310894-1">end</span></code></pre><p>In the example above, you can provide <code class="inline">%{name: &quot;a name&quot;, description: &quot;a description&quot;}</code> to both the <code class="inline">:create</code> and <code class="inline">:update</code> actions, but only <code class="inline">%{something_else: &quot;some_value&quot;}</code> to <code class="inline">:special_update</code>.</p><h4>Using module attributes for action specific accept lists</h4><p>You can also use module attributes to define the accept list.  This is useful if you have a lot of attributes and different variations for different actions.</p><pre><code class="makeup elixir" translate="no"><span class="na">@accepts_special_update</span><span class="w"> </span><span class="p" data-group-id="3808338058-1">[</span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:description</span><span class="p">,</span><span class="w"> </span><span class="ss">:foo</span><span class="p">,</span><span class="w"> </span><span class="ss">:bar</span><span class="p">,</span><span class="w"> </span><span class="ss">:baz</span><span class="p" data-group-id="3808338058-1">]</span><span class="w">

</span><span class="na">@accepts_super_special_update</span><span class="w"> </span><span class="na">@accepts_special_update</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="3808338058-2">[</span><span class="ss">:something_else</span><span class="p">,</span><span class="w"> </span><span class="ss">:another_thing</span><span class="p" data-group-id="3808338058-2">]</span><span class="w">

</span><span class="n">actions</span><span class="w"> </span><span class="k" data-group-id="3808338058-3">do</span><span class="w">
  </span><span class="n">default_accept</span><span class="w"> </span><span class="p" data-group-id="3808338058-4">[</span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:description</span><span class="p" data-group-id="3808338058-4">]</span><span class="w">

  </span><span class="n">create</span><span class="w"> </span><span class="ss">:create</span><span class="w">
  </span><span class="n">update</span><span class="w"> </span><span class="ss">:update</span><span class="w">

  </span><span class="n">update</span><span class="w"> </span><span class="ss">:special_update</span><span class="w"> </span><span class="k" data-group-id="3808338058-5">do</span><span class="w">
    </span><span class="n">accept</span><span class="w"> </span><span class="na">@accepts_special_update</span><span class="w">
  </span><span class="k" data-group-id="3808338058-5">end</span><span class="w">
</span><span class="k" data-group-id="3808338058-3">end</span></code></pre><p>This is extremely simple example</p><h2 id="context">Context</h2><p>There are two kinds of contexts in Ash:</p><ol><li>the context given to a changeset/action call, stored in <code class="inline">changeset.context</code>,</li><li>the context given to a callback function like <a href="Ash.Resource.Change.xhtml#c:change/3"><code class="inline">Ash.Resource.Change.change/3</code></a>, which contains
the above context in it's <code class="inline">source_context</code> key, as well as additional information specific to the callback,
and/or commonly needed keys for callbacks (actor, tenant, etc.).</li></ol><p>Actions accept a free-form map of context, which can be used for whatever you like. Whenever context is set, it is <em>deep merged</em>. I.e if you do <code class="inline">changeset |&gt; Ash.Changeset.set_context(%{a: %{b: 1}}) |&gt; Ash.Changeset.set_context(%{a: %{c: 2}})</code>, the resulting context will be <code class="inline">%{a: %{b: 1, c: 2}}</code>. Structs are not merged.</p><p>There are some special keys in context to note:</p><h3 id="private"><code class="inline">:private</code></h3><p>The <code class="inline">:private</code> key is reserved for use by <a href="Ash.xhtml"><code class="inline">Ash</code></a> itself. You shouldn't read from or write to it.</p><h3 id="shared"><code class="inline">:shared</code></h3><p>The <code class="inline">:shared</code> key will be passed to all nested actions built by Ash, and should be passed by you to any actions you call within changes/preparations etc. Whenever <code class="inline">:shared</code> context
is set, it is also written to the outer context. For example <code class="inline">set_context(%{shared: %{locale: &quot;en&quot;}})</code> is equivalent to <code class="inline">set_context(%{shared: %{locale: &quot;en&quot;}, locale: &quot;en&quot;})</code></p><p>This will generally happen automatically if you use one of the two abstractions provided by Ash for threading options through to nested action calls.</p><section role="note" class="admonition warning"><h3 id="careful-with-shared" class="admonition-title warning">Careful with shared</h3><p>Shared context is passed to all nested actions, so don't pass massive values around, and also don't set context</p></section><h2 id="query_for"><code class="inline">:query_for</code></h2><p>This is set on queries when they are being run for a &quot;special&quot; purpose. The values this can take are:</p><ul><li>none, if a read action is being run, then no value is set for this context</li><li><code class="inline">:bulk_update</code>, if the query is being built to power a bulk update action</li><li><code class="inline">:bulk_destroy</code>, if the query is being built to power a bulk destroy action</li><li><code class="inline">:load</code>, if the query is being built to power an <code class="inline">Ash.load</code> call</li></ul><p>You can use this to adjust the behavior of your query preparations as needed.</p><h2 id="bulk_create-bulk_update-bulk_destroy"><code class="inline">:bulk_create</code>, <code class="inline">:bulk_update</code>, <code class="inline">:bulk_destroy</code></h2><p>This is set on changesets when they are being run in bulk. The value will be a map with the following keys (more may be added in the future):</p><p><code class="inline">:index</code> -&gt; The index of the changeset in the bulk operation.</p><h4><a href="Ash.Scope.ToOpts.xhtml"><code class="inline">Ash.Scope.ToOpts</code></a></h4><p><a href="Ash.Scope.ToOpts.xhtml"><code class="inline">Ash.Scope.ToOpts</code></a> is newer and is the recommended way to do this. In action callbacks in Ash, you will be provided with a context, which can be passed down as a <code class="inline">scope</code> option when running nested actions or building nested changesets/queries. For example:</p><pre><code class="makeup elixir" translate="no"><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="p" data-group-id="6909178659-1">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p" data-group-id="6909178659-1">)</span><span class="w"> </span><span class="k" data-group-id="6909178659-2">do</span><span class="w">
  </span><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">after_action</span><span class="p" data-group-id="6909178659-3">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="6909178659-4">fn</span><span class="w"> </span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="c1"># automatically passes the `shared` context to the nested action</span><span class="w">
    </span><span class="nc">MyApp.MyDomain</span><span class="o">.</span><span class="n">create_something_else</span><span class="p" data-group-id="6909178659-5">(</span><span class="n">...</span><span class="p">,</span><span class="w"> </span><span class="ss">scope</span><span class="p">:</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="ss">other</span><span class="p">:</span><span class="w"> </span><span class="ss">:options</span><span class="p" data-group-id="6909178659-5">)</span><span class="w">
  </span><span class="k" data-group-id="6909178659-4">end</span><span class="p" data-group-id="6909178659-3">)</span><span class="w">
</span><span class="k" data-group-id="6909178659-2">end</span></code></pre><p>To get the opts for a given scope, you can use <code class="inline">Ash.Scope.to_opts(scope)</code>, but this is typically not
necessary.</p><h4><a href="Ash.Context.xhtml#to_opts/2"><code class="inline">Ash.Context.to_opts/2</code></a></h4><p><a href="Ash.Context.xhtml#to_opts/2"><code class="inline">Ash.Context.to_opts/2</code></a> is a helper function that converts a context map into a list of options that can be passed to nested actions. It automatically passes the <code class="inline">shared</code> context to the nested action as well.</p><pre><code class="makeup elixir" translate="no"><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="p" data-group-id="5240185037-1">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p" data-group-id="5240185037-1">)</span><span class="w"> </span><span class="k" data-group-id="5240185037-2">do</span><span class="w">
  </span><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">after_action</span><span class="p" data-group-id="5240185037-3">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="5240185037-4">fn</span><span class="w"> </span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="c1"># automatically passes the `shared` context to the nested action</span><span class="w">
    </span><span class="nc">MyApp.MyDomain</span><span class="o">.</span><span class="n">create_something_else</span><span class="p" data-group-id="5240185037-5">(</span><span class="n">...</span><span class="p">,</span><span class="w"> </span><span class="nc">Ash.Context</span><span class="o">.</span><span class="n">to_opts</span><span class="p" data-group-id="5240185037-6">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="ss">other</span><span class="p">:</span><span class="w"> </span><span class="ss">:options</span><span class="p" data-group-id="5240185037-6">)</span><span class="p" data-group-id="5240185037-5">)</span><span class="w">
  </span><span class="k" data-group-id="5240185037-4">end</span><span class="p" data-group-id="5240185037-3">)</span><span class="w">
</span><span class="k" data-group-id="5240185037-2">end</span></code></pre><h2 id="idiomatic-actions">Idiomatic Actions</h2><h3 id="name-your-actions">Name Your Actions</h3><p>The intent behind Ash is <em>not</em> to have you building simple CRUD style applications. In a typical set up you may have a resource with four basic actions, there is even a shorthand to accomplish this:</p><pre><code class="makeup elixir" translate="no"><span class="n">actions</span><span class="w"> </span><span class="k" data-group-id="2551574738-1">do</span><span class="w">
  </span><span class="n">defaults</span><span class="w"> </span><span class="p" data-group-id="2551574738-2">[</span><span class="ss">:read</span><span class="p">,</span><span class="w"> </span><span class="ss">:destroy</span><span class="p">,</span><span class="w"> </span><span class="ss">create</span><span class="p">:</span><span class="w"> </span><span class="ss">:*</span><span class="p">,</span><span class="w"> </span><span class="ss">update</span><span class="p">:</span><span class="w"> </span><span class="ss">:*</span><span class="p" data-group-id="2551574738-2">]</span><span class="w">
</span><span class="k" data-group-id="2551574738-1">end</span></code></pre><p>But that is just a simple way to get started, or to create resources that really don't do anything beyond those four operations. You can have <em>as many actions as you want</em>. The best designed Ash applications will have numerous actions, named after the intent behind how they are used. They won't have all reads going through a single read action, and the same goes for the other action types. The richer the actions on the resource, the better interface you can have. With that said, many resources may only have those four basic actions, especially those that are &quot;managed&quot; through some parent resource. See the guide on <a href="relationships.xhtml#managing-relationships">Managing Relationships</a> for more.</p><h3 id="put-everything-inside-the-action">Put everything inside the action</h3><p>Ash provides utilities to modify queries and changesets <em>outside</em> of the actions on the resources. This is a very important tool in our tool belt, <em>but</em> it is very easy to abuse. The intent is that as much behavior as possible is put into the action. Here is the &quot;wrong way&quot; to do it. There is a lot going on here, so don't hesitate to check out other relevant guides if you see something you don't understand.</p><pre><code class="makeup elixir" translate="no"><span class="kd">def</span><span class="w"> </span><span class="nf">top_tickets</span><span class="p" data-group-id="6161075633-1">(</span><span class="n">user_id</span><span class="p" data-group-id="6161075633-1">)</span><span class="w"> </span><span class="k" data-group-id="6161075633-2">do</span><span class="w">
  </span><span class="nc">Ticket</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">for_read</span><span class="p" data-group-id="6161075633-3">(</span><span class="ss">:read</span><span class="p" data-group-id="6161075633-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="6161075633-4">(</span><span class="n">priority</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p" data-group-id="6161075633-5">[</span><span class="ss">:medium</span><span class="p">,</span><span class="w"> </span><span class="ss">:high</span><span class="p" data-group-id="6161075633-5">]</span><span class="p" data-group-id="6161075633-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="6161075633-6">(</span><span class="n">representative_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">user_id</span><span class="p" data-group-id="6161075633-6">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="6161075633-7">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:open</span><span class="p" data-group-id="6161075633-7">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">sort</span><span class="p" data-group-id="6161075633-8">(</span><span class="ss">opened_at</span><span class="p">:</span><span class="w"> </span><span class="ss">:desc</span><span class="p" data-group-id="6161075633-8">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">limit</span><span class="p" data-group-id="6161075633-9">(</span><span class="mi">10</span><span class="p" data-group-id="6161075633-9">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Helpdesk.Support</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="6161075633-10">(</span><span class="p" data-group-id="6161075633-10">)</span><span class="w">
</span><span class="k" data-group-id="6161075633-2">end</span><span class="w">

</span><span class="c1"># in the resource</span><span class="w">

</span><span class="n">actions</span><span class="w"> </span><span class="k" data-group-id="6161075633-11">do</span><span class="w">
  </span><span class="n">defaults</span><span class="w"> </span><span class="p" data-group-id="6161075633-12">[</span><span class="ss">:read</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="6161075633-12">]</span><span class="w">
</span><span class="k" data-group-id="6161075633-11">end</span></code></pre><p>And here is the &quot;right way&quot;, where the rules about getting the top tickets have been moved into the resource as a nicely named action, and included in the <code class="inline">code_interface</code> of that resource. The reality of the situation is that <code class="inline">top_tickets/1</code> is meant to be obsoleted by your Ash resource! Here is how it <em>should</em> be done.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># in the resource</span><span class="w">

</span><span class="n">code_interface</span><span class="w"> </span><span class="k" data-group-id="4152174644-1">do</span><span class="w">
  </span><span class="n">define</span><span class="w"> </span><span class="ss">:top</span><span class="p">,</span><span class="w"> </span><span class="ss">args</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4152174644-2">[</span><span class="ss">:user_id</span><span class="p" data-group-id="4152174644-2">]</span><span class="w">
</span><span class="k" data-group-id="4152174644-1">end</span><span class="w">

</span><span class="n">actions</span><span class="w"> </span><span class="k" data-group-id="4152174644-3">do</span><span class="w">
  </span><span class="n">read</span><span class="w"> </span><span class="ss">:top</span><span class="w"> </span><span class="k" data-group-id="4152174644-4">do</span><span class="w">
    </span><span class="n">argument</span><span class="w"> </span><span class="ss">:user_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:uuid</span><span class="w"> </span><span class="k" data-group-id="4152174644-5">do</span><span class="w">
      </span><span class="n">allow_nil?</span><span class="w"> </span><span class="no">false</span><span class="w">
    </span><span class="k" data-group-id="4152174644-5">end</span><span class="w">

    </span><span class="n">prepare</span><span class="w"> </span><span class="n">build</span><span class="p" data-group-id="4152174644-6">(</span><span class="ss">limit</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="ss">sort</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4152174644-7">[</span><span class="ss">opened_at</span><span class="p">:</span><span class="w"> </span><span class="ss">:desc</span><span class="p" data-group-id="4152174644-7">]</span><span class="p" data-group-id="4152174644-6">)</span><span class="w">

    </span><span class="n">filter</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="4152174644-8">(</span><span class="n">priority</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p" data-group-id="4152174644-9">[</span><span class="ss">:medium</span><span class="p">,</span><span class="w"> </span><span class="ss">:high</span><span class="p" data-group-id="4152174644-9">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">representative_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">arg</span><span class="p" data-group-id="4152174644-10">(</span><span class="ss">:user_id</span><span class="p" data-group-id="4152174644-10">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:open</span><span class="p" data-group-id="4152174644-8">)</span><span class="w">
  </span><span class="k" data-group-id="4152174644-4">end</span><span class="w">
</span><span class="k" data-group-id="4152174644-3">end</span></code></pre><p>Now, whatever code I had that would have called <code class="inline">top_tickets/1</code> can now call <code class="inline">Helpdesk.Support.Ticket.top(user.id)</code>. By doing it this way, you get the primary benefit of getting a nice simple interface to call into, but you <em>also</em> have a way to modify how the action is invoked in any way necessary, by going back to the old way of building the query manually. For example, if I also only want to see top tickets that were opened in the last 10 minutes:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Ticket</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">for_read</span><span class="p" data-group-id="4497986102-1">(</span><span class="ss">:top</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4497986102-2">%{</span><span class="ss">user_id</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="4497986102-2">}</span><span class="p" data-group-id="4497986102-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="4497986102-3">(</span><span class="n">opened_at</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p" data-group-id="4497986102-4">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="ss">:minute</span><span class="p" data-group-id="4497986102-4">)</span><span class="p" data-group-id="4497986102-3">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Helpdesk.Support</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="4497986102-5">(</span><span class="p" data-group-id="4497986102-5">)</span></code></pre><p>That is the best of both worlds! These same lessons transfer to changeset based actions as well.</p><h2 id="private-inputs">Private Inputs</h2><p>The concept of a &quot;private input&quot; can be somewhat paradoxical, but it can be used by actions that require something provided by the &quot;system&quot;,
as well as something provided by the caller. For example, you may want an <code class="inline">ip_address</code> input that can't be set by the user. For this,
you have two options.</p><h3 id="private-options">Private Options</h3><pre><code class="makeup elixir" translate="no"><span class="n">create</span><span class="w"> </span><span class="ss">:create</span><span class="w"> </span><span class="k" data-group-id="5092187050-1">do</span><span class="w">
  </span><span class="n">argument</span><span class="w"> </span><span class="ss">:ip_address</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="p">,</span><span class="w"> </span><span class="ss">allow_nil?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w"> </span><span class="ss">public?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">

  </span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="5092187050-1">end</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">for_create</span><span class="p" data-group-id="6163753579-1">(</span><span class="nc">Resource</span><span class="p">,</span><span class="w"> </span><span class="ss">:create</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6163753579-2">%{</span><span class="p" data-group-id="6163753579-2">}</span><span class="p">,</span><span class="w"> </span><span class="ss">private_arguments</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6163753579-3">%{</span><span class="ss">ip_address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&lt;ip_address&gt;&quot;</span><span class="p" data-group-id="6163753579-3">}</span><span class="p" data-group-id="6163753579-1">)</span></code></pre><h3 id="context-1">Context</h3><p>You can also provide things to the action via <code class="inline">context</code>. Context is a map that is a free form map provided to the action.
Context is occasionally used by callers to provide additional information that the action may or may not use.</p><p>Context is <em>deep merged</em> with any existing context, and also contains a <code class="inline">private</code> key that is reserved for use by Ash internals.
You should not remove or manipulate the <code class="inline">private</code> context key in any way.</p><pre><code class="makeup elixir" translate="no"><span class="n">create</span><span class="w"> </span><span class="ss">:create</span><span class="w"> </span><span class="k" data-group-id="2204601367-1">do</span><span class="w">
  </span><span class="n">...</span><span class="w">
  </span><span class="n">change</span><span class="w"> </span><span class="k" data-group-id="2204601367-2">fn</span><span class="w"> </span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="n">changeset</span><span class="o">.</span><span class="n">context</span><span class="w"> </span><span class="c1"># %{ip_address: &quot;&lt;ip_address&gt;&quot;}</span><span class="w">
  </span><span class="k" data-group-id="2204601367-2">end</span><span class="w">
</span><span class="k" data-group-id="2204601367-1">end</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">for_create</span><span class="p" data-group-id="5542268582-1">(</span><span class="nc">Resource</span><span class="p">,</span><span class="w"> </span><span class="ss">:create</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5542268582-2">%{</span><span class="p" data-group-id="5542268582-2">}</span><span class="p">,</span><span class="w"> </span><span class="ss">context</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5542268582-3">%{</span><span class="ss">ip_address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&lt;ip_address&gt;&quot;</span><span class="p" data-group-id="5542268582-3">}</span><span class="p" data-group-id="5542268582-1">)</span></code></pre><h2 id="action-lifecycle">Action Lifecycle</h2><p>This section provides a comprehensive overview of the Ash resource action lifecycle, detailing when each phase executes in relation to database transactions.</p><h3 id="overview">Overview</h3><p>Ash resource actions follow a well-defined lifecycle that ensures proper data validation, transformation, and persistence. The lifecycle is divided into three main phases:</p><ul><li><strong>Pre-Transaction Phase</strong> - Operations before database transaction</li><li><strong>Transaction Phase</strong> - Operations within database transaction  </li><li><strong>Post-Transaction Phase</strong> - Operations after database transaction</li></ul><h4>Important Note:</h4><ul><li><strong>Around Action Behavior</strong>: <code class="inline">around_action</code> hooks do not complete their &quot;end&quot; phase if the action fails</li></ul><h3 id="complete-lifecycle-flow">Complete Lifecycle Flow</h3><pre><code class="mermaid">graph TD
    subgraph &quot;Pre-Transaction Phase&quot;
        START[&quot;Action Invocation&lt;br/&gt;(Ash.create, Ash.read, Ash.run_action, etc.)&quot;] --&gt; PREP[&quot;Changeset/Query/ActionInput Creation&quot;]
        PREP --&gt; AROUND_START[&quot;around_transaction (start)&quot;]
        AROUND_START --&gt; BEFORE_TRANS[&quot;before_transaction&quot;]
    end
    
    subgraph &quot;Transaction Phase&quot;
        TRANS_START[&quot;ðŸ”’ Transaction Begins&quot;] --&gt; ACTION_TYPE{&quot;Action Type?&quot;}
        
        %% Create/Update/Destroy path
        ACTION_TYPE --&gt;|&quot;Create/Update/Destroy&quot;| CUD_ACTION_PREP[&quot;Action Preparations/Validations/Changes&lt;br/&gt;(In order of definition)&quot;]
        CUD_ACTION_PREP --&gt; CUD_GLOBAL_PREP[&quot;Global Preparations/Validations/Changes&lt;br/&gt;(Resource-level, in order of definition)&quot;]
        CUD_GLOBAL_PREP --&gt; CUD_AROUND_ACTION_START[&quot;around_action (start)&quot;]
        CUD_AROUND_ACTION_START --&gt; CUD_BEFORE_ACTION[&quot;before_action&quot;]
        CUD_BEFORE_ACTION --&gt; DATA_LAYER[&quot;ðŸ’¾ Data Layer Operation&lt;br/&gt;(Database interaction)&quot;]
        DATA_LAYER --&gt; CUD_SUCCESS{&quot;Success?&quot;}
        CUD_SUCCESS --&gt;|Yes| CUD_AFTER_ACTION[&quot;after_action&lt;br/&gt;(Success only)&quot;]
        CUD_SUCCESS --&gt;|No| CUD_ERROR_HANDLE[&quot;Error Handling&quot;]
        CUD_AFTER_ACTION --&gt; CUD_AROUND_ACTION_END[&quot;around_action (end)&lt;br/&gt;âœ… Only on success&quot;]
        CUD_ERROR_HANDLE --&gt; TRANS_ROLLBACK[&quot;ðŸ”“ Transaction Rollback&quot;]
        CUD_AROUND_ACTION_END --&gt; TRANS_COMMIT[&quot;ðŸ”“ Transaction Commit&quot;]
        
        %% Read/Generic path
        ACTION_TYPE --&gt;|&quot;Read/Generic&quot;| RG_GLOBAL_PREP[&quot;Global Preparations/Validations&lt;br/&gt;(Resource-level, in order of definition)&quot;]
        RG_GLOBAL_PREP --&gt; RG_ACTION_PREP[&quot;Action Preparations/Validations&lt;br/&gt;(In order of definition)&quot;]
        RG_ACTION_PREP --&gt; RG_BEFORE_ACTION[before_action]
        RG_BEFORE_ACTION --&gt; RG_OPERATION{&quot;Operation Type?&quot;}
        RG_OPERATION --&gt;|&quot;Read&quot;| READ_DATA_LAYER[&quot;ðŸ’¾ Data Layer Operation&lt;br/&gt;(Database query)&quot;]
        RG_OPERATION --&gt;|&quot;Generic&quot;| GENERIC_LOGIC[&quot;ðŸ”§ Custom Action Logic&lt;br/&gt;(User-defined function)&quot;]
        READ_DATA_LAYER --&gt; RG_SUCCESS{&quot;Success?&quot;}
        GENERIC_LOGIC --&gt; RG_SUCCESS
        RG_SUCCESS --&gt;|Yes| RG_AFTER_ACTION[&quot;after_action&lt;br/&gt;(Success only)&quot;]
        RG_AFTER_ACTION --&gt;|Yes| TRANS_COMMIT
        RG_SUCCESS --&gt;|No| RG_ERROR_HANDLE[&quot;Error Handling&quot;]
        RG_ERROR_HANDLE --&gt; TRANS_ROLLBACK
    end
    
    subgraph &quot;Post-Transaction Phase&quot;
        AFTER_TRANS[&quot;after_transaction&lt;br/&gt;(Always runs - success/error)&quot;] --&gt; AROUND_END[&quot;around_transaction (end)&quot;]
        AROUND_END --&gt; NOTIFICATIONS[&quot;Notifications&lt;br/&gt;(If enabled)&quot;]
        NOTIFICATIONS --&gt; RESULT[&quot;Return Result&quot;]
    end
    
    %% Flow connections
    BEFORE_TRANS --&gt; TRANS_START
    TRANS_COMMIT --&gt; AFTER_TRANS
    TRANS_ROLLBACK --&gt; AFTER_TRANS</code></pre><h3 id="detailed-phase-breakdown">Detailed Phase Breakdown</h3><h4>Pre-Transaction Phase (Outside Database Transaction)</h4><h5>1. Action Invocation</h5><ul><li><strong>Entry point</strong>: <a href="Ash.xhtml#create/2"><code class="inline">Ash.create/2</code></a>, <a href="Ash.xhtml#update/2"><code class="inline">Ash.update/2</code></a>, <a href="Ash.xhtml#read/2"><code class="inline">Ash.read/2</code></a>, <a href="Ash.xhtml#destroy/2"><code class="inline">Ash.destroy/2</code></a></li><li>Initial setup and parameter validation</li></ul><h5>2. Changeset/Query Creation</h5><ul><li>Creates appropriate changeset or query structure</li><li>Applies initial transformations and validations</li></ul><h5>3. around_transaction (Start)</h5><ul><li><strong>When</strong>: Before transaction begins</li><li><strong>Purpose</strong>: Wrap entire transaction with setup/cleanup logic</li><li><strong>Use Cases</strong>:<ul><li>External service setup</li><li>Resource allocation</li><li>Logging/monitoring setup</li></ul></li><li><strong>Transaction Context</strong>: Outside transaction</li></ul><h5>4. before_transaction</h5><ul><li><strong>When</strong>: Just before transaction starts</li><li><strong>Purpose</strong>: Operations that must happen before database transaction</li><li><strong>Use Cases</strong>:<ul><li>External API calls</li><li>File system operations</li><li>Cache warming</li><li>Non-transactional preparations</li></ul></li><li><strong>Transaction Context</strong>: Outside transaction</li></ul><h4>Transaction Phase (Inside Database Transaction)</h4><h5>5. Transaction Begins ðŸ”’</h5><ul><li>Database transaction is initiated</li><li>All subsequent operations until commit/rollback are atomic</li></ul><h5>6. Global Preparations/Validations/Changes (Queries &amp; Generic Actions)</h5><ul><li><strong>When</strong>: First operations inside transaction (for queries and generic actions)</li><li><strong>Purpose</strong>: Execute resource-level preparations, validations, and changes</li><li><strong>Order</strong>: Run in the order they are defined at the resource level (not grouped by type)</li><li><strong>Operations</strong>:<ul><li>Resource-level preparations</li><li>Resource-level validations</li><li>Resource-level changes</li><li>Global business logic</li></ul></li><li><strong>Transaction Context</strong>: Inside transaction</li><li><strong>Note</strong>: For create/update/destroy actions, these run after action-level operations. In Ash 4.0, global preparations will run after action preparations for all action types.</li></ul><h5>7. Action Preparations/Validations/Changes</h5><ul><li><strong>When</strong>: After global operations (for queries and generic actions) or first operations (for create/update/destroy)</li><li><strong>Purpose</strong>: Execute action-specific preparations, validations, and changes</li><li><strong>Order</strong>: Run in the order they are defined in the action (not grouped by type)</li><li><strong>Operations</strong>:<ul><li>Action-level preparations (query modifications, filters, sorts)</li><li>Action-level validations (business rules, constraints)</li><li>Action-level changes (data transformations, attribute modifications)</li></ul></li><li><strong>Transaction Context</strong>: Inside transaction</li></ul><h5>8. around_action (Start)</h5><ul><li><strong>When</strong>: Just before data layer operation</li><li><strong>Purpose</strong>: Wrap the actual database operation</li><li><strong>Use Cases</strong>:<ul><li>Performance monitoring</li><li>Debugging and development tools</li><li>Advanced error handling</li><li>Action timing</li></ul></li><li><strong>Transaction Context</strong>: Inside transaction</li><li><strong>Note</strong>: Must call the callback function</li></ul><h5>9. before_action</h5><ul><li><strong>When</strong>: Immediately before data layer operation</li><li><strong>Purpose</strong>: Final modifications before database interaction</li><li><strong>Use Cases</strong>:<ul><li>Last-minute data modifications</li><li>Transactional side effects</li><li>Audit logging</li><li>Final validations</li></ul></li><li><strong>Transaction Context</strong>: Inside transaction</li></ul><h5>10. Data Layer Operation ðŸ’¾</h5><ul><li><strong>When</strong>: Core of the transaction</li><li><strong>Purpose</strong>: Actual database interaction</li><li><strong>Operations</strong>:<ul><li>INSERT, UPDATE, DELETE, SELECT operations</li><li>Constraint enforcement</li><li>Database-level validations</li><li>Index updates</li></ul></li><li><strong>Transaction Context</strong>: Inside transaction</li></ul><h5>11. Success/Error Decision Point</h5><ul><li>Determines if the operation succeeded or failed</li><li>Affects which subsequent hooks are called</li></ul><h5>12. after_action (Success Path Only)</h5><ul><li><strong>When</strong>: After successful data layer operation</li><li><strong>Purpose</strong>: Post-success operations within transaction</li><li><strong>Use Cases</strong>:<ul><li>Success-only side effects</li><li>Transactional cleanup</li><li>Related record updates</li><li>Success logging</li></ul></li><li><strong>Transaction Context</strong>: Inside transaction</li><li><strong>Note</strong>: Only runs on successful operations</li></ul><h5>13. Error Handling (Error Path)</h5><ul><li><strong>When</strong>: After failed data layer operation</li><li><strong>Purpose</strong>: Handle errors within transaction context</li><li><strong>Operations</strong>:<ul><li>Error processing</li><li>Rollback preparation</li><li>Error logging</li></ul></li><li><strong>Transaction Context</strong>: Inside transaction</li></ul><h5>14. around_action (End)</h5><ul><li><strong>When</strong>: After successful action completion only</li><li><strong>Purpose</strong>: Cleanup and finalization within transaction</li><li><strong>Use Cases</strong>:<ul><li>Resource cleanup</li><li>Final transaction operations</li><li>Monitoring completion</li></ul></li><li><strong>Transaction Context</strong>: Inside transaction</li><li><strong>Note</strong>: This phase does NOT execute if the action fails</li></ul><h5>15. Transaction Commits/Rollbacks ðŸ”“</h5><ul><li><strong>Success</strong>: Transaction commits, changes are persisted</li><li><strong>Error</strong>: Transaction rolls back, changes are discarded</li><li>End of transactional context</li></ul><h4>Post-Transaction Phase (Outside Database Transaction)</h4><h5>16. after_transaction</h5><ul><li><strong>When</strong>: After transaction completion (success or error)</li><li><strong>Purpose</strong>: Operations that should happen regardless of outcome</li><li><strong>Use Cases</strong>:<ul><li>External service notifications</li><li>Cache invalidation</li><li>Cleanup operations</li><li>Logging (success and error cases)</li><li>Retry mechanisms - can change error results to success</li></ul></li><li><strong>Transaction Context</strong>: Outside transaction</li><li><strong>Special Capability</strong>: Can transform the final result (e.g., retry failed operations)</li><li><strong>Note</strong>: Always runs, regardless of success/failure</li></ul><h5>17. around_transaction (End)</h5><ul><li><strong>When</strong>: Final cleanup phase</li><li><strong>Purpose</strong>: Complete the transaction wrapper</li><li><strong>Use Cases</strong>:<ul><li>Resource deallocation</li><li>Final cleanup</li><li>Monitoring completion</li></ul></li><li><strong>Transaction Context</strong>: Outside transaction</li></ul><h5>18. Notifications</h5><ul><li><strong>When</strong>: After all hooks complete</li><li><strong>Purpose</strong>: Broadcast events and notifications</li><li><strong>Operations</strong>:<ul><li>PubSub notifications</li><li>Event broadcasting</li><li>External system integrations</li><li>Webhook calls</li></ul></li><li><strong>Transaction Context</strong>: Outside transaction</li></ul><h5>19. Return Result</h5><ul><li><strong>Success</strong>: Returns data with metadata</li><li><strong>Error</strong>: Returns error details and context</li></ul><h3 id="hook-execution-order">Hook Execution Order</h3><p>The hooks execute in the following order (as of Ash 3.0+):</p><h4>For Create/Update/Destroy Actions:</h4><ol><li><code class="inline">around_transaction</code> (start)</li><li><code class="inline">before_transaction</code></li><li>Transaction begins</li><li>Action preparations/validations/changes (in order of definition)</li><li>Global preparations/validations/changes (in order of definition)</li><li><code class="inline">around_action</code> (start)</li><li><code class="inline">before_action</code></li><li>Data layer operation</li><li><code class="inline">after_action</code> (success only) OR Error handling</li><li><code class="inline">around_action</code> (end) - Only on success</li><li>Transaction commits/rollbacks</li><li><code class="inline">after_transaction</code></li><li><code class="inline">around_transaction</code> (end)</li></ol><h4>For Read/Query Actions:</h4><ol><li><code class="inline">around_transaction</code> (start)</li><li><code class="inline">before_transaction</code></li><li>Transaction begins (if applicable)</li><li>Global preparations/validations/changes (in order of definition)</li><li>Action preparations/validations/changes (in order of definition)</li><li><code class="inline">around_action</code> (start)</li><li><code class="inline">before_action</code></li><li>Data layer operation</li><li><code class="inline">after_action</code> (success only) OR Error handling</li><li><code class="inline">around_action</code> (end) - Only on success</li><li>Transaction commits/rollbacks (if applicable)</li><li><code class="inline">after_transaction</code> (always runs - success/error)</li><li><code class="inline">around_transaction</code> (end)</li></ol><h4>For Generic Actions:</h4><ol><li><code class="inline">around_transaction</code> (start)</li><li><code class="inline">before_transaction</code></li><li>Transaction begins (if <code class="inline">transaction? true</code>)</li><li>Global preparations/validations (in order of definition)</li><li>Action preparations/validations (in order of definition)</li><li><code class="inline">around_action</code> (start)</li><li><code class="inline">before_action</code></li><li>Custom action logic execution</li><li><code class="inline">after_action</code> (success only) OR Error handling</li><li><code class="inline">around_action</code> (end) - Only on success</li><li>Transaction commits/rollbacks (if applicable)</li><li><code class="inline">after_transaction</code> (always runs)</li><li><code class="inline">around_transaction</code> (end)</li></ol><h3 id="key-points">Key Points</h3><h4>Transaction Boundaries</h4><ul><li><strong>Outside Transaction</strong>: <code class="inline">around_transaction</code>, <code class="inline">before_transaction</code>, <code class="inline">after_transaction</code></li><li><strong>Inside Transaction</strong>: Action preparations/validations/changes, Global preparations/validations/changes, <code class="inline">around_action</code>, <code class="inline">before_action</code>, <code class="inline">after_action</code></li></ul><h4>Error Handling</h4><ul><li><code class="inline">after_action</code> only runs on successful operations</li><li><code class="inline">around_action</code> (end) only runs on successful operations</li><li><code class="inline">after_transaction</code> always runs (success and error)</li><li><code class="inline">after_transaction</code> can change the final result - can transform errors into successes (useful for retries)</li><li>Transaction rollback occurs automatically on errors</li></ul><h4>Execution Order Details</h4><ul><li><strong>Preparations/Validations/Changes</strong>: Run in the order they are defined, NOT grouped by type</li><li><strong>Create/Update/Destroy</strong>: Action-level preparations/validations/changes run first, then global (resource-level) preparations/validations/changes</li><li><strong>Read/Query/Generic</strong>: Global (resource-level) preparations/validations/changes run first, then action-level preparations/validations/changes</li><li><strong>Ash 4.0 Change</strong>: In Ash 4.0, global preparations will run after action preparations for all action types</li><li><strong>Hook Order Changes (Ash 3.0+)</strong>: Before/after action hooks now run in the order they are added (not reverse order)</li><li><strong>Restriction</strong>: <code class="inline">after_transaction</code> hooks cannot be added from within other lifecycle hooks</li></ul><h4>Performance Considerations</h4><ul><li>Operations inside the transaction should be fast and focused</li><li>Long-running operations should be in <code class="inline">before_transaction</code> or <code class="inline">after_transaction</code></li><li>Database connections are held during the entire transaction phase</li></ul><h3 id="action-type-differences">Action Type Differences</h3><h4>Create/Update/Destroy Actions</h4><ul><li>Run in transactions by default, unless no hooks of any kind are added to the changeset.</li><li>Have complete error handling and rollback capabilities</li></ul><h4>Read/Query Actions</h4><ul><li>Do not run in transactions by default</li><li>Focus on data retrieval and filtering</li></ul><h4>Generic Actions</h4><ul><li>Support validations, preparations, and all hook types</li><li>Can run in transactions by setting <code class="inline">transaction? true</code> in the action definition</li><li>Focus on custom business logic and operations</li></ul><h3 id="best-practices">Best Practices</h3><ul><li>Use <code class="inline">before_transaction</code> for external API calls</li><li>Use <code class="inline">before_action</code> for final data modifications</li><li>Use <code class="inline">after_action</code> for transactional side effects</li><li>Use <code class="inline">after_transaction</code> for external notifications</li><li>Use <code class="inline">after_transaction</code> for retry mechanisms and result transformation</li><li>Keep transaction phase operations fast and focused</li><li>Handle errors appropriately at each phase</li><li>Remember that <code class="inline">around_action</code> cleanup won't run on failures</li></ul><h3 id="example-implementation">Example Implementation</h3><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.User</span><span class="w"> </span><span class="k" data-group-id="3601273474-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="w">

  </span><span class="n">actions</span><span class="w"> </span><span class="k" data-group-id="3601273474-2">do</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="ss">:create</span><span class="w"> </span><span class="k" data-group-id="3601273474-3">do</span><span class="w">
      </span><span class="n">accept</span><span class="w"> </span><span class="p" data-group-id="3601273474-4">[</span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:email</span><span class="p" data-group-id="3601273474-4">]</span><span class="w">
      </span><span class="n">argument</span><span class="w"> </span><span class="ss">:retries</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="p">,</span><span class="w"> </span><span class="ss">default</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">allow_nil?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
      
      </span><span class="n">change</span><span class="w"> </span><span class="n">before_transaction</span><span class="p" data-group-id="3601273474-5">(</span><span class="k" data-group-id="3601273474-6">fn</span><span class="w"> </span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="c">_context</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="c1"># External API call before transaction</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="nc">ExternalService</span><span class="o">.</span><span class="n">validate_email</span><span class="p" data-group-id="3601273474-7">(</span><span class="n">changeset</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">email</span><span class="p" data-group-id="3601273474-7">)</span><span class="w"> </span><span class="k" data-group-id="3601273474-8">do</span><span class="w">
          </span><span class="ss">:ok</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">changeset</span><span class="w">
          </span><span class="p" data-group-id="3601273474-9">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="3601273474-9">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">add_error</span><span class="p" data-group-id="3601273474-10">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="3601273474-10">)</span><span class="w">
        </span><span class="k" data-group-id="3601273474-8">end</span><span class="w">
      </span><span class="k" data-group-id="3601273474-6">end</span><span class="p" data-group-id="3601273474-5">)</span><span class="w">
      
      </span><span class="n">change</span><span class="w"> </span><span class="n">before_action</span><span class="p" data-group-id="3601273474-11">(</span><span class="k" data-group-id="3601273474-12">fn</span><span class="w"> </span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="c">_context</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="c1"># Final modifications before database</span><span class="w">
        </span><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">change_attribute</span><span class="p" data-group-id="3601273474-13">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="ss">:created_at</span><span class="p">,</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p" data-group-id="3601273474-14">(</span><span class="p" data-group-id="3601273474-14">)</span><span class="p" data-group-id="3601273474-13">)</span><span class="w">
      </span><span class="k" data-group-id="3601273474-12">end</span><span class="p" data-group-id="3601273474-11">)</span><span class="w">
      
      </span><span class="n">change</span><span class="w"> </span><span class="n">after_action</span><span class="p" data-group-id="3601273474-15">(</span><span class="k" data-group-id="3601273474-16">fn</span><span class="w"> </span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="c">_context</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="c1"># Success-only operations within transaction</span><span class="w">
        </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="3601273474-17">(</span><span class="s">&quot;User created: </span><span class="si" data-group-id="3601273474-18">#{</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="si" data-group-id="3601273474-18">}</span><span class="s">&quot;</span><span class="p" data-group-id="3601273474-17">)</span><span class="w">
        </span><span class="p" data-group-id="3601273474-19">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="3601273474-19">}</span><span class="w">
      </span><span class="k" data-group-id="3601273474-16">end</span><span class="p" data-group-id="3601273474-15">)</span><span class="w">
      
      </span><span class="n">change</span><span class="w"> </span><span class="k" data-group-id="3601273474-20">fn</span><span class="w"> </span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="c1"># Retry mechanism using after_transaction</span><span class="w">
        </span><span class="k">if</span><span class="w"> </span><span class="n">changeset</span><span class="o">.</span><span class="n">arguments</span><span class="p" data-group-id="3601273474-21">[</span><span class="ss">:retries</span><span class="p" data-group-id="3601273474-21">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k" data-group-id="3601273474-22">do</span><span class="w">
          </span><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">after_transaction</span><span class="p" data-group-id="3601273474-23">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="3601273474-24">fn</span><span class="w"> 
            </span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3601273474-25">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="3601273474-25">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
              </span><span class="c1"># Success case - send notification and return result</span><span class="w">
              </span><span class="nc">NotificationService</span><span class="o">.</span><span class="n">send_welcome_email</span><span class="p" data-group-id="3601273474-26">(</span><span class="n">result</span><span class="p" data-group-id="3601273474-26">)</span><span class="w">
              </span><span class="p" data-group-id="3601273474-27">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="3601273474-27">}</span><span class="w">
            </span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3601273474-28">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="c">_error</span><span class="p" data-group-id="3601273474-28">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
              </span><span class="c1"># Error case - retry with decremented counter</span><span class="w">
              </span><span class="bp">__MODULE__</span><span class="w">
              </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">for_create</span><span class="p" data-group-id="3601273474-29">(</span><span class="w">
                </span><span class="n">changeset</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> 
                </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="3601273474-30">(</span><span class="n">changeset</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="ss">:retries</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">retries</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="3601273474-30">)</span><span class="p">,</span><span class="w"> 
                </span><span class="ss">scope</span><span class="p">:</span><span class="w"> </span><span class="n">context</span><span class="w">
              </span><span class="p" data-group-id="3601273474-29">)</span><span class="w">
              </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">create</span><span class="p" data-group-id="3601273474-31">(</span><span class="p" data-group-id="3601273474-31">)</span><span class="w">
          </span><span class="k" data-group-id="3601273474-24">end</span><span class="p" data-group-id="3601273474-23">)</span><span class="w">
        </span><span class="k" data-group-id="3601273474-22">else</span><span class="w">
          </span><span class="c1"># No retries left - add final after_transaction for cleanup</span><span class="w">
          </span><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">after_transaction</span><span class="p" data-group-id="3601273474-32">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="3601273474-33">fn</span><span class="w"> </span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k" data-group-id="3601273474-34">do</span><span class="w">
              </span><span class="p" data-group-id="3601273474-35">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="3601273474-35">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> 
                </span><span class="nc">NotificationService</span><span class="o">.</span><span class="n">send_welcome_email</span><span class="p" data-group-id="3601273474-36">(</span><span class="n">user</span><span class="p" data-group-id="3601273474-36">)</span><span class="w">
                </span><span class="n">result</span><span class="w">
              </span><span class="n">error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> 
                </span><span class="nc">Logger</span><span class="o">.</span><span class="n">error</span><span class="p" data-group-id="3601273474-37">(</span><span class="s">&quot;User creation failed after all retries&quot;</span><span class="p" data-group-id="3601273474-37">)</span><span class="w">
                </span><span class="n">error</span><span class="w">
            </span><span class="k" data-group-id="3601273474-34">end</span><span class="w">
          </span><span class="k" data-group-id="3601273474-33">end</span><span class="p" data-group-id="3601273474-32">)</span><span class="w">
        </span><span class="k" data-group-id="3601273474-22">end</span><span class="w">
      </span><span class="k" data-group-id="3601273474-20">end</span><span class="w">
    </span><span class="k" data-group-id="3601273474-3">end</span><span class="w">
  </span><span class="k" data-group-id="3601273474-2">end</span><span class="w">
</span><span class="k" data-group-id="3601273474-1">end</span></code></pre><h4>Key Points from Example:</h4><ul><li><strong>Retry Logic</strong>: The <code class="inline">after_transaction</code> hook can transform a failed result into a new attempt</li><li><strong>Result Transformation</strong>: Failed operations can become successful ones through retries</li><li><strong>Context Preservation</strong>: The retry maintains the original context and decrements the retry counter</li><li><strong>Conditional Behavior</strong>: Different <code class="inline">after_transaction</code> hooks based on retry availability</li><li><strong>Final Cleanup</strong>: Even after retries are exhausted, cleanup operations still occur</li></ul><p>This lifecycle ensures data consistency, proper error handling, and allows for complex business logic while maintaining transactional integrity.</p>

  </body>
</html>
