<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
      xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>Test Resources - ash v3.5.33</title>
    <meta name="generator" content="ExDoc v0.38.2" />
    <link type="text/css" rel="stylesheet" href="dist/epub-elixir-FNUUKFP7.css" />
    <script src="dist/epub-4WIP524F.js"></script>

  </head>
  <body class="content-inner">

    <h1 id="content">Test Resources</h1>
<pre><code class="makeup elixir" translate="no"><span class="nc">Application</span><span class="o">.</span><span class="n">put_env</span><span class="p" data-group-id="8477044428-1">(</span><span class="ss">:stream_data</span><span class="p">,</span><span class="w"> </span><span class="ss">:max_runs</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="8477044428-1">)</span><span class="w">
</span><span class="nc">Mix</span><span class="o">.</span><span class="n">install</span><span class="p" data-group-id="8477044428-2">(</span><span class="p" data-group-id="8477044428-3">[</span><span class="p" data-group-id="8477044428-4">{</span><span class="ss">:ash</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 3.0&quot;</span><span class="p" data-group-id="8477044428-4">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8477044428-5">{</span><span class="ss">:simple_sat</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.1&quot;</span><span class="p" data-group-id="8477044428-5">}</span><span class="p" data-group-id="8477044428-3">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">consolidate_protocols</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
</span><span class="p" data-group-id="8477044428-2">)</span><span class="w">

</span><span class="nc">Logger</span><span class="o">.</span><span class="n">configure</span><span class="p" data-group-id="8477044428-6">(</span><span class="ss">level</span><span class="p">:</span><span class="w"> </span><span class="ss">:warning</span><span class="p" data-group-id="8477044428-6">)</span><span class="w">
</span><span class="nc">ExUnit</span><span class="o">.</span><span class="n">start</span><span class="p" data-group-id="8477044428-7">(</span><span class="p" data-group-id="8477044428-7">)</span></code></pre><h2 id="introduction">Introduction</h2><p>We recommend testing your resources <em>thoroughly</em>. Often, folks think that testing an <a href="Ash.Resource.xhtml"><code class="inline">Ash.Resource</code></a> is &quot;testing the framework&quot;, and in some very simple cases this may be true, like a simple create that just accepts a few attributes.</p><p>However, testing has two primary roles:</p><ol><li>Confirming our understanding of the way that our application behaves <em>now</em></li><li>Ensuring that our application does not change in unintended ways <em>later</em></li></ol><p>To this end, we highly recommend writing tests even for your simple actions. A single test that confirms that, with simple inputs, the action returns what you expect, can be very powerful.</p><p>Additionally, Ash offers unique ways of testing individual components of our resources, similar to a unit test.</p><p>While you don't necessarily need to follow all steps below, we show the various ways you may want to go about testing your resources.</p><h2 id="testing-resources">Testing Resources</h2><ul><li>Add tests for action inputs using property testing</li><li>Add tests for calling action invocation using property testing</li><li>Add explicit tests for action inputs/invocation.</li><li>Add tests for our calculations</li><li>Test policies &quot;in isolation&quot; using <code class="inline">Ash.can?</code> (or <code class="inline">Domain.can_*</code>, provided by code interfaces)</li></ul><h2 id="examples">Examples</h2><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">User</span><span class="w"> </span><span class="k" data-group-id="0170269814-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="nc">Domain</span><span class="p">,</span><span class="w">
    </span><span class="ss">data_layer</span><span class="p">:</span><span class="w"> </span><span class="nc">Ash.DataLayer.Ets</span><span class="w">

  </span><span class="n">actions</span><span class="w"> </span><span class="k" data-group-id="0170269814-2">do</span><span class="w">
    </span><span class="n">defaults</span><span class="w"> </span><span class="p" data-group-id="0170269814-3">[</span><span class="ss">:read</span><span class="p">,</span><span class="w"> </span><span class="ss">create</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0170269814-4">[</span><span class="ss">:admin?</span><span class="p" data-group-id="0170269814-4">]</span><span class="p" data-group-id="0170269814-3">]</span><span class="w">
  </span><span class="k" data-group-id="0170269814-2">end</span><span class="w">

  </span><span class="n">attributes</span><span class="w"> </span><span class="k" data-group-id="0170269814-5">do</span><span class="w">
    </span><span class="n">uuid_primary_key</span><span class="w"> </span><span class="ss">:id</span><span class="w">
    </span><span class="n">attribute</span><span class="w"> </span><span class="ss">:admin?</span><span class="p">,</span><span class="w"> </span><span class="ss">:boolean</span><span class="w"> </span><span class="k" data-group-id="0170269814-6">do</span><span class="w">
      </span><span class="n">allow_nil?</span><span class="w"> </span><span class="no">false</span><span class="w">
      </span><span class="n">default</span><span class="w"> </span><span class="no">false</span><span class="w">
    </span><span class="k" data-group-id="0170269814-6">end</span><span class="w">
  </span><span class="k" data-group-id="0170269814-5">end</span><span class="w">
</span><span class="k" data-group-id="0170269814-1">end</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Tweet</span><span class="w"> </span><span class="k" data-group-id="0170269814-7">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="nc">Domain</span><span class="p">,</span><span class="w">
    </span><span class="ss">data_layer</span><span class="p">:</span><span class="w"> </span><span class="nc">Ash.DataLayer.Ets</span><span class="p">,</span><span class="w">
    </span><span class="ss">authorizers</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0170269814-8">[</span><span class="nc">Ash.Policy.Authorizer</span><span class="p" data-group-id="0170269814-8">]</span><span class="w">

  </span><span class="n">attributes</span><span class="w"> </span><span class="k" data-group-id="0170269814-9">do</span><span class="w">
    </span><span class="n">uuid_primary_key</span><span class="w"> </span><span class="ss">:id</span><span class="w">
    </span><span class="n">attribute</span><span class="w"> </span><span class="ss">:text</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w"> </span><span class="k" data-group-id="0170269814-10">do</span><span class="w">
      </span><span class="n">allow_nil?</span><span class="w"> </span><span class="no">false</span><span class="w">
      </span><span class="n">constraints</span><span class="w"> </span><span class="ss">max_length</span><span class="p">:</span><span class="w"> </span><span class="mi">144</span><span class="w">
      </span><span class="n">public?</span><span class="w"> </span><span class="no">true</span><span class="w">
    </span><span class="k" data-group-id="0170269814-10">end</span><span class="w">

    </span><span class="n">attribute</span><span class="w"> </span><span class="ss">:hidden?</span><span class="p">,</span><span class="w"> </span><span class="ss">:boolean</span><span class="w"> </span><span class="k" data-group-id="0170269814-11">do</span><span class="w">
      </span><span class="n">allow_nil?</span><span class="w"> </span><span class="no">false</span><span class="w">
      </span><span class="n">default</span><span class="w"> </span><span class="no">false</span><span class="w">
      </span><span class="n">public?</span><span class="w"> </span><span class="no">true</span><span class="w">
    </span><span class="k" data-group-id="0170269814-11">end</span><span class="w">
  </span><span class="k" data-group-id="0170269814-9">end</span><span class="w">

  </span><span class="n">calculations</span><span class="w"> </span><span class="k" data-group-id="0170269814-12">do</span><span class="w">
    </span><span class="n">calculate</span><span class="w"> </span><span class="ss">:tweet_length</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="0170269814-13">(</span><span class="n">string_length</span><span class="p" data-group-id="0170269814-14">(</span><span class="n">text</span><span class="p" data-group-id="0170269814-14">)</span><span class="p" data-group-id="0170269814-13">)</span><span class="w">
  </span><span class="k" data-group-id="0170269814-12">end</span><span class="w">

  </span><span class="n">relationships</span><span class="w"> </span><span class="k" data-group-id="0170269814-15">do</span><span class="w">
    </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:user</span><span class="p">,</span><span class="w"> </span><span class="nc">User</span><span class="p">,</span><span class="w"> </span><span class="ss">allow_nil?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
  </span><span class="k" data-group-id="0170269814-15">end</span><span class="w">

  </span><span class="n">actions</span><span class="w"> </span><span class="k" data-group-id="0170269814-16">do</span><span class="w">
    </span><span class="n">defaults</span><span class="w"> </span><span class="p" data-group-id="0170269814-17">[</span><span class="ss">:read</span><span class="p">,</span><span class="w"> </span><span class="ss">update</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0170269814-18">[</span><span class="ss">:text</span><span class="p" data-group-id="0170269814-18">]</span><span class="p" data-group-id="0170269814-17">]</span><span class="w">

    </span><span class="n">create</span><span class="w"> </span><span class="ss">:create</span><span class="w"> </span><span class="k" data-group-id="0170269814-19">do</span><span class="w">
      </span><span class="n">primary?</span><span class="w"> </span><span class="no">true</span><span class="w">
      </span><span class="n">accept</span><span class="w"> </span><span class="p" data-group-id="0170269814-20">[</span><span class="ss">:text</span><span class="p" data-group-id="0170269814-20">]</span><span class="w">
      </span><span class="n">change</span><span class="w"> </span><span class="n">relate_actor</span><span class="p" data-group-id="0170269814-21">(</span><span class="ss">:user</span><span class="p" data-group-id="0170269814-21">)</span><span class="w">
    </span><span class="k" data-group-id="0170269814-19">end</span><span class="w">
  </span><span class="k" data-group-id="0170269814-16">end</span><span class="w">

  </span><span class="n">policies</span><span class="w"> </span><span class="k" data-group-id="0170269814-22">do</span><span class="w">
    </span><span class="n">policy</span><span class="w"> </span><span class="n">action_type</span><span class="p" data-group-id="0170269814-23">(</span><span class="ss">:read</span><span class="p" data-group-id="0170269814-23">)</span><span class="w"> </span><span class="k" data-group-id="0170269814-24">do</span><span class="w">
      </span><span class="n">description</span><span class="w"> </span><span class="s">&quot;If a tweet is hidden, only the author can read it. Otherwise, anyone can.&quot;</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">relates_to_actor_via</span><span class="p" data-group-id="0170269814-25">(</span><span class="ss">:user</span><span class="p" data-group-id="0170269814-25">)</span><span class="w">
      </span><span class="n">forbid_if</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="0170269814-26">(</span><span class="n">hidden?</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="0170269814-26">)</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="0170269814-27">(</span><span class="p" data-group-id="0170269814-27">)</span><span class="w">
    </span><span class="k" data-group-id="0170269814-24">end</span><span class="w">

    </span><span class="n">policy</span><span class="w"> </span><span class="n">action_type</span><span class="p" data-group-id="0170269814-28">(</span><span class="ss">:create</span><span class="p" data-group-id="0170269814-28">)</span><span class="w"> </span><span class="k" data-group-id="0170269814-29">do</span><span class="w">
      </span><span class="n">description</span><span class="w"> </span><span class="s">&quot;Anyone can create a tweet&quot;</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="0170269814-30">(</span><span class="p" data-group-id="0170269814-30">)</span><span class="w">
    </span><span class="k" data-group-id="0170269814-29">end</span><span class="w">

    </span><span class="n">policy</span><span class="w"> </span><span class="n">action_type</span><span class="p" data-group-id="0170269814-31">(</span><span class="ss">:update</span><span class="p" data-group-id="0170269814-31">)</span><span class="w"> </span><span class="k" data-group-id="0170269814-32">do</span><span class="w">
      </span><span class="n">description</span><span class="w"> </span><span class="s">&quot;Only an admin or the user who tweeted can edit their tweet&quot;</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">actor_attribute_equals</span><span class="p" data-group-id="0170269814-33">(</span><span class="ss">:admin?</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="0170269814-33">)</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">relates_to_actor_via</span><span class="p" data-group-id="0170269814-34">(</span><span class="ss">:user</span><span class="p" data-group-id="0170269814-34">)</span><span class="w">
    </span><span class="k" data-group-id="0170269814-32">end</span><span class="w">
  </span><span class="k" data-group-id="0170269814-22">end</span><span class="w">
</span><span class="k" data-group-id="0170269814-7">end</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Domain</span><span class="w"> </span><span class="k" data-group-id="0170269814-35">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Domain</span><span class="p">,</span><span class="w">
    </span><span class="ss">validate_config_inclusion?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">

  </span><span class="n">resources</span><span class="w"> </span><span class="k" data-group-id="0170269814-36">do</span><span class="w">
    </span><span class="n">resource</span><span class="w"> </span><span class="nc">Tweet</span><span class="w"> </span><span class="k" data-group-id="0170269814-37">do</span><span class="w">
      </span><span class="n">define</span><span class="w"> </span><span class="ss">:create_tweet</span><span class="p">,</span><span class="w"> </span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="ss">:create</span><span class="p">,</span><span class="w"> </span><span class="ss">args</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0170269814-38">[</span><span class="ss">:text</span><span class="p" data-group-id="0170269814-38">]</span><span class="w">
      </span><span class="n">define</span><span class="w"> </span><span class="ss">:update_tweet</span><span class="p">,</span><span class="w"> </span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="ss">:update</span><span class="p">,</span><span class="w"> </span><span class="ss">args</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0170269814-39">[</span><span class="ss">:text</span><span class="p" data-group-id="0170269814-39">]</span><span class="w">
      </span><span class="n">define</span><span class="w"> </span><span class="ss">:list_tweets</span><span class="p">,</span><span class="w"> </span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="ss">:read</span><span class="w">
    </span><span class="k" data-group-id="0170269814-37">end</span><span class="w">

    </span><span class="n">resource</span><span class="w"> </span><span class="nc">User</span><span class="w"> </span><span class="k" data-group-id="0170269814-40">do</span><span class="w">
      </span><span class="n">define</span><span class="w"> </span><span class="ss">:create_user</span><span class="p">,</span><span class="w"> </span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="ss">:create</span><span class="w">
    </span><span class="k" data-group-id="0170269814-40">end</span><span class="w">
  </span><span class="k" data-group-id="0170269814-36">end</span><span class="w">
</span><span class="k" data-group-id="0170269814-35">end</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="7183991791-1">{</span><span class="ss">:module</span><span class="p">,</span><span class="w"> </span><span class="nc">Domain</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7183991791-2">&lt;&lt;</span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">110</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="7183991791-2">&gt;&gt;</span><span class="p">,</span><span class="w">
 </span><span class="p" data-group-id="7183991791-3">[</span><span class="w">
   </span><span class="nc">Ash.Domain.Dsl.Resources.Resource</span><span class="p">,</span><span class="w">
   </span><span class="nc">Ash.Domain.Dsl.Resources.Options</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="7183991791-4">%{</span><span class="ss">opts</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7183991791-5">[</span><span class="p" data-group-id="7183991791-5">]</span><span class="p">,</span><span class="w"> </span><span class="ss">entities</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7183991791-6">[</span><span class="p" data-group-id="7183991791-7">%</span><span class="nc" data-group-id="7183991791-7">Ash.Domain.Dsl.ResourceReference</span><span class="p" data-group-id="7183991791-7">{</span><span class="n">...</span><span class="p" data-group-id="7183991791-7">}</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="7183991791-6">]</span><span class="p" data-group-id="7183991791-4">}</span><span class="w">
 </span><span class="p" data-group-id="7183991791-3">]</span><span class="p" data-group-id="7183991791-1">}</span></code></pre><h2 id="create-a-generator">Create a generator</h2><p>See <a href="Ash.Generator.xhtml"><code class="inline">Ash.Generator</code></a> documentation for more examples and docs.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Generator</span><span class="w"> </span><span class="k" data-group-id="2616859801-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Generator</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">user</span><span class="p" data-group-id="2616859801-2">(</span><span class="n">opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="2616859801-3">[</span><span class="p" data-group-id="2616859801-3">]</span><span class="p" data-group-id="2616859801-2">)</span><span class="w"> </span><span class="k" data-group-id="2616859801-4">do</span><span class="w">
    </span><span class="n">changeset_generator</span><span class="p" data-group-id="2616859801-5">(</span><span class="w">
      </span><span class="nc">User</span><span class="p">,</span><span class="w">
      </span><span class="ss">:create</span><span class="p">,</span><span class="w">
      </span><span class="ss">overrides</span><span class="p">:</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w">
      </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="2616859801-6">[</span><span class="ss">:actor</span><span class="p" data-group-id="2616859801-6">]</span><span class="w">
    </span><span class="p" data-group-id="2616859801-5">)</span><span class="w"> 
  </span><span class="k" data-group-id="2616859801-4">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">tweet</span><span class="p" data-group-id="2616859801-7">(</span><span class="n">opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="2616859801-8">[</span><span class="p" data-group-id="2616859801-8">]</span><span class="p" data-group-id="2616859801-7">)</span><span class="w"> </span><span class="k" data-group-id="2616859801-9">do</span><span class="w">
    </span><span class="n">changeset_generator</span><span class="p" data-group-id="2616859801-10">(</span><span class="w">
      </span><span class="nc">Tweet</span><span class="p">,</span><span class="w">
      </span><span class="ss">:create</span><span class="p">,</span><span class="w">
      </span><span class="ss">overrides</span><span class="p">:</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w">
      </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="2616859801-11">[</span><span class="ss">:actor</span><span class="p" data-group-id="2616859801-11">]</span><span class="w">
    </span><span class="p" data-group-id="2616859801-10">)</span><span class="w"> 
  </span><span class="k" data-group-id="2616859801-9">end</span><span class="w">
</span><span class="k" data-group-id="2616859801-1">end</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="5721752088-1">{</span><span class="ss">:module</span><span class="p">,</span><span class="w"> </span><span class="nc">Generator</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5721752088-2">&lt;&lt;</span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="5721752088-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5721752088-3">{</span><span class="ss">:tweet</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="5721752088-3">}</span><span class="p" data-group-id="5721752088-1">}</span></code></pre><h2 id="write-some-tests">Write some tests</h2><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ActionInvocationTest</span><span class="w"> </span><span class="k" data-group-id="7664667785-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExUnit.Case</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">ExUnitProperties</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Generator</span><span class="w">

  </span><span class="n">describe</span><span class="w"> </span><span class="s">&quot;valid inputs&quot;</span><span class="w"> </span><span class="k" data-group-id="7664667785-2">do</span><span class="w">
    </span><span class="c1"># now if our action inputs are invalid when we think they should be valid, we will find out here</span><span class="w">
    </span><span class="n">property</span><span class="w"> </span><span class="s">&quot;accepts all valid input&quot;</span><span class="w"> </span><span class="k" data-group-id="7664667785-3">do</span><span class="w">
      </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate</span><span class="p" data-group-id="7664667785-4">(</span><span class="n">user</span><span class="p" data-group-id="7664667785-5">(</span><span class="p" data-group-id="7664667785-5">)</span><span class="p" data-group-id="7664667785-4">)</span><span class="w">

      </span><span class="n">check</span><span class="w"> </span><span class="n">all</span><span class="p" data-group-id="7664667785-6">(</span><span class="n">input</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Ash.Generator</span><span class="o">.</span><span class="n">action_input</span><span class="p" data-group-id="7664667785-7">(</span><span class="nc">Tweet</span><span class="p">,</span><span class="w"> </span><span class="ss">:create</span><span class="p" data-group-id="7664667785-7">)</span><span class="p" data-group-id="7664667785-6">)</span><span class="w"> </span><span class="k" data-group-id="7664667785-8">do</span><span class="w">
        </span><span class="p" data-group-id="7664667785-9">{</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="n">other_inputs</span><span class="p" data-group-id="7664667785-9">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">pop!</span><span class="p" data-group-id="7664667785-10">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="ss">:text</span><span class="p" data-group-id="7664667785-10">)</span><span class="w">

        </span><span class="n">assert</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">changeset_to_create_tweet</span><span class="p" data-group-id="7664667785-11">(</span><span class="w">
                 </span><span class="n">text</span><span class="p">,</span><span class="w">
                 </span><span class="n">other_inputs</span><span class="p">,</span><span class="w">
                 </span><span class="ss">authorize?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w">
                 </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="w">
               </span><span class="p" data-group-id="7664667785-11">)</span><span class="o">.</span><span class="n">valid?</span><span class="w">
      </span><span class="k" data-group-id="7664667785-8">end</span><span class="w">
    </span><span class="k" data-group-id="7664667785-3">end</span><span class="w">

    </span><span class="c1"># same as the above, but actually call the action. This tests the underlying action implementation</span><span class="w">
    </span><span class="c1"># not just initial validation</span><span class="w">
    </span><span class="n">property</span><span class="w"> </span><span class="s">&quot;succeeds on all valid input&quot;</span><span class="w"> </span><span class="k" data-group-id="7664667785-12">do</span><span class="w">
      </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate</span><span class="p" data-group-id="7664667785-13">(</span><span class="n">user</span><span class="p" data-group-id="7664667785-14">(</span><span class="p" data-group-id="7664667785-14">)</span><span class="p" data-group-id="7664667785-13">)</span><span class="w">

      </span><span class="n">check</span><span class="w"> </span><span class="n">all</span><span class="p" data-group-id="7664667785-15">(</span><span class="n">input</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Ash.Generator</span><span class="o">.</span><span class="n">action_input</span><span class="p" data-group-id="7664667785-16">(</span><span class="nc">Tweet</span><span class="p">,</span><span class="w"> </span><span class="ss">:create</span><span class="p" data-group-id="7664667785-16">)</span><span class="p" data-group-id="7664667785-15">)</span><span class="w"> </span><span class="k" data-group-id="7664667785-17">do</span><span class="w">
        </span><span class="p" data-group-id="7664667785-18">{</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="n">other_inputs</span><span class="p" data-group-id="7664667785-18">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">pop!</span><span class="p" data-group-id="7664667785-19">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="ss">:text</span><span class="p" data-group-id="7664667785-19">)</span><span class="w">
        </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_tweet!</span><span class="p" data-group-id="7664667785-20">(</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="n">other_inputs</span><span class="p">,</span><span class="w"> </span><span class="ss">authorize?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="7664667785-20">)</span><span class="w">
      </span><span class="k" data-group-id="7664667785-17">end</span><span class="w">
    </span><span class="k" data-group-id="7664667785-12">end</span><span class="w">

    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;can tweet some specific text, in addition to any other valid inputs&quot;</span><span class="w"> </span><span class="k" data-group-id="7664667785-21">do</span><span class="w">
      </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate</span><span class="p" data-group-id="7664667785-22">(</span><span class="n">user</span><span class="p" data-group-id="7664667785-23">(</span><span class="p" data-group-id="7664667785-23">)</span><span class="p" data-group-id="7664667785-22">)</span><span class="w">

      </span><span class="n">check</span><span class="w"> </span><span class="n">all</span><span class="p" data-group-id="7664667785-24">(</span><span class="w">
              </span><span class="n">input</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Ash.Generator</span><span class="o">.</span><span class="n">action_input</span><span class="p" data-group-id="7664667785-25">(</span><span class="nc">Tweet</span><span class="p">,</span><span class="w"> </span><span class="ss">:create</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7664667785-26">%{</span><span class="ss">text</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;some specific text&quot;</span><span class="p" data-group-id="7664667785-26">}</span><span class="p" data-group-id="7664667785-25">)</span><span class="w">
            </span><span class="p" data-group-id="7664667785-24">)</span><span class="w"> </span><span class="k" data-group-id="7664667785-27">do</span><span class="w">
        </span><span class="p" data-group-id="7664667785-28">{</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="n">other_inputs</span><span class="p" data-group-id="7664667785-28">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">pop!</span><span class="p" data-group-id="7664667785-29">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="ss">:text</span><span class="p" data-group-id="7664667785-29">)</span><span class="w">
        </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_tweet!</span><span class="p" data-group-id="7664667785-30">(</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="n">other_inputs</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="7664667785-30">)</span><span class="w">
      </span><span class="k" data-group-id="7664667785-27">end</span><span class="w">
    </span><span class="k" data-group-id="7664667785-21">end</span><span class="w">
  </span><span class="k" data-group-id="7664667785-2">end</span><span class="w">

  </span><span class="n">describe</span><span class="w"> </span><span class="s">&quot;authorization&quot;</span><span class="w"> </span><span class="k" data-group-id="7664667785-31">do</span><span class="w">
    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;allows a user to update their own tweet&quot;</span><span class="w"> </span><span class="k" data-group-id="7664667785-32">do</span><span class="w">
      </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate</span><span class="p" data-group-id="7664667785-33">(</span><span class="n">user</span><span class="p" data-group-id="7664667785-34">(</span><span class="p" data-group-id="7664667785-34">)</span><span class="p" data-group-id="7664667785-33">)</span><span class="w">
      </span><span class="n">tweet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate</span><span class="p" data-group-id="7664667785-35">(</span><span class="n">tweet</span><span class="p" data-group-id="7664667785-36">(</span><span class="ss">text</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Hello world!&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="7664667785-36">)</span><span class="p" data-group-id="7664667785-35">)</span><span class="w">

      </span><span class="n">assert</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">can_update_tweet?</span><span class="p" data-group-id="7664667785-37">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">tweet</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Goodbye world!&quot;</span><span class="p" data-group-id="7664667785-37">)</span><span class="w">
    </span><span class="k" data-group-id="7664667785-32">end</span><span class="w">

    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;does not allow a user to update someone elses tweet&quot;</span><span class="w"> </span><span class="k" data-group-id="7664667785-38">do</span><span class="w">
      </span><span class="p" data-group-id="7664667785-39">[</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">user2</span><span class="p" data-group-id="7664667785-39">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate_many</span><span class="p" data-group-id="7664667785-40">(</span><span class="n">user</span><span class="p" data-group-id="7664667785-41">(</span><span class="p" data-group-id="7664667785-41">)</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="7664667785-40">)</span><span class="w">
      </span><span class="n">tweet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_tweet!</span><span class="p" data-group-id="7664667785-42">(</span><span class="s">&quot;Hello world!&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="7664667785-42">)</span><span class="w">

      </span><span class="n">refute</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">can_update_tweet?</span><span class="p" data-group-id="7664667785-43">(</span><span class="n">user2</span><span class="p">,</span><span class="w"> </span><span class="n">tweet</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Goodbye world!&quot;</span><span class="p" data-group-id="7664667785-43">)</span><span class="w">
    </span><span class="k" data-group-id="7664667785-38">end</span><span class="w">

    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;allows an admin user to update someone elses tweet&quot;</span><span class="w"> </span><span class="k" data-group-id="7664667785-44">do</span><span class="w">
      </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate</span><span class="p" data-group-id="7664667785-45">(</span><span class="n">user</span><span class="p" data-group-id="7664667785-46">(</span><span class="p" data-group-id="7664667785-46">)</span><span class="p" data-group-id="7664667785-45">)</span><span class="w">
      </span><span class="n">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate</span><span class="p" data-group-id="7664667785-47">(</span><span class="n">user</span><span class="p" data-group-id="7664667785-48">(</span><span class="ss">admin?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="7664667785-48">)</span><span class="p" data-group-id="7664667785-47">)</span><span class="w">
      </span><span class="n">tweet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate</span><span class="p" data-group-id="7664667785-49">(</span><span class="n">tweet</span><span class="p" data-group-id="7664667785-50">(</span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="7664667785-50">)</span><span class="p" data-group-id="7664667785-49">)</span><span class="w">

      </span><span class="n">assert</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">can_update_tweet?</span><span class="p" data-group-id="7664667785-51">(</span><span class="n">admin</span><span class="p">,</span><span class="w"> </span><span class="n">tweet</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Goodbye world!&quot;</span><span class="p" data-group-id="7664667785-51">)</span><span class="w">
    </span><span class="k" data-group-id="7664667785-44">end</span><span class="w">
  </span><span class="k" data-group-id="7664667785-31">end</span><span class="w">

  </span><span class="n">describe</span><span class="w"> </span><span class="s">&quot;calculations&quot;</span><span class="w"> </span><span class="k" data-group-id="7664667785-52">do</span><span class="w">
    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;text length calculation computes the length of the text&quot;</span><span class="w"> </span><span class="k" data-group-id="7664667785-53">do</span><span class="w">
      </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate</span><span class="p" data-group-id="7664667785-54">(</span><span class="n">user</span><span class="p" data-group-id="7664667785-55">(</span><span class="p" data-group-id="7664667785-55">)</span><span class="p" data-group-id="7664667785-54">)</span><span class="w">
      </span><span class="n">tweet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate</span><span class="p" data-group-id="7664667785-56">(</span><span class="n">tweet</span><span class="p" data-group-id="7664667785-57">(</span><span class="ss">text</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Hello world!&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="7664667785-57">)</span><span class="p" data-group-id="7664667785-56">)</span><span class="w">
      </span><span class="n">assert</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">calculate!</span><span class="p" data-group-id="7664667785-58">(</span><span class="n">tweet</span><span class="p">,</span><span class="w"> </span><span class="ss">:tweet_length</span><span class="p" data-group-id="7664667785-58">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">12</span><span class="w">
    </span><span class="k" data-group-id="7664667785-53">end</span><span class="w">
  </span><span class="k" data-group-id="7664667785-52">end</span><span class="w">
</span><span class="k" data-group-id="7664667785-1">end</span><span class="w">

</span><span class="nc">ExUnit</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="7664667785-59">(</span><span class="p" data-group-id="7664667785-59">)</span></code></pre><pre><code class="makeup output" translate="no"><span class="nc">Running</span><span class="w"> </span><span class="nc">ExUnit</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="ss">seed</span><span class="p">:</span><span class="w"> </span><span class="mi">462155</span><span class="p">,</span><span class="w"> </span><span class="ss">max_cases</span><span class="p">:</span><span class="w"> </span><span class="mi">28</span><span class="w">

</span><span class="n">...</span><span class="n">...</span><span class="o">.</span><span class="w">
</span><span class="nc">Finished</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.08</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="p" data-group-id="0212320610-1">(</span><span class="mf">0.00</span><span class="n">s</span><span class="w"> </span><span class="n">async</span><span class="p">,</span><span class="w"> </span><span class="mf">0.08</span><span class="n">s</span><span class="w"> </span><span class="n">sync</span><span class="p" data-group-id="0212320610-1">)</span><span class="w">
</span><span class="mi">2</span><span class="w"> </span><span class="n">properties</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">tests</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">failures</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="3620221838-1">%{</span><span class="ss">total</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="ss">failures</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">excluded</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">skipped</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="3620221838-1">}</span></code></pre>

  </body>
</html>
