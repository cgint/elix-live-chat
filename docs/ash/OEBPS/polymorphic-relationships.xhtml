<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
      xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>Define Polymorphic Relationships - ash v3.5.33</title>
    <meta name="generator" content="ExDoc v0.38.2" />
    <link type="text/css" rel="stylesheet" href="dist/epub-elixir-FNUUKFP7.css" />
    <script src="dist/epub-4WIP524F.js"></script>

  </head>
  <body class="content-inner">

    <h1 id="content">Define Polymorphic Relationships</h1>
<pre><code class="makeup elixir" translate="no"><span class="nc">Mix</span><span class="o">.</span><span class="n">install</span><span class="p" data-group-id="8601720354-1">(</span><span class="p" data-group-id="8601720354-2">[</span><span class="p" data-group-id="8601720354-3">{</span><span class="ss">:ash</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 3.0&quot;</span><span class="p" data-group-id="8601720354-3">}</span><span class="p" data-group-id="8601720354-2">]</span><span class="p">,</span><span class="w"> </span><span class="ss">consolidate_protocols</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="8601720354-1">)</span></code></pre><pre><code class="makeup output" translate="no"><span class="ss">:ok</span></code></pre><h2 id="introduction">Introduction</h2><p>Something that comes up in more complex domains is the idea of &quot;polymorphic relationships&quot;. For this example, we will use the concept of a <code class="inline">BankAccount</code>, which can be either a <code class="inline">SavingsAccount</code> or a <code class="inline">CheckingAccount</code>. All accounts have an <code class="inline">account_number</code> and <code class="inline">transactions</code>, but checkings &amp; savings accounts might have their own specific information. For example, a <code class="inline">SavingsAccount</code> has an <code class="inline">interest_rate</code>, and a <code class="inline">CheckingAccount</code> has many <code class="inline">debit_card</code>s.</p><p>Ash does not support polymorphic relationships defined <em>as relationships</em>, but you can accomplish similar functionality via <a href="calculations.xhtml">calculations</a> with the type <a href="Ash.Type.Union.xhtml"><code class="inline">Ash.Type.Union</code></a>.</p><p>For this tutorial, we will have a dedicated resource called <code class="inline">BankAccount</code>. I suggest taking that approach, as many things down the road will be simplified. With that said, you don't necessarily need to do that when there is no commonalities between the types. Instead of setting up the polymorphism on the <code class="inline">BankAccount</code> resource, you would define relationships to <code class="inline">SavingsAccount</code> and <code class="inline">CheckingAccount</code> directly.</p><p>This tutorial is not attempting to illustrate good design of accounting systems. We make many concessions for the sake of the simplicity of our example.</p><h2 id="defining-our-resources">Defining our Resources</h2><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">BankAccount</span><span class="w"> </span><span class="k" data-group-id="9554603503-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="nc">Finance</span><span class="p">,</span><span class="w">
    </span><span class="ss">data_layer</span><span class="p">:</span><span class="w"> </span><span class="nc">Ash.DataLayer.Ets</span><span class="w">

  </span><span class="n">actions</span><span class="w"> </span><span class="k" data-group-id="9554603503-2">do</span><span class="w">
    </span><span class="n">defaults</span><span class="w"> </span><span class="p" data-group-id="9554603503-3">[</span><span class="ss">:read</span><span class="p">,</span><span class="w"> </span><span class="ss">:destroy</span><span class="p">,</span><span class="w"> </span><span class="ss">create</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9554603503-4">[</span><span class="ss">:account_number</span><span class="p">,</span><span class="w"> </span><span class="ss">:type</span><span class="p" data-group-id="9554603503-4">]</span><span class="p" data-group-id="9554603503-3">]</span><span class="w">
  </span><span class="k" data-group-id="9554603503-2">end</span><span class="w">

  </span><span class="n">attributes</span><span class="w"> </span><span class="k" data-group-id="9554603503-5">do</span><span class="w">
    </span><span class="n">uuid_primary_key</span><span class="w"> </span><span class="ss">:id</span><span class="w">

    </span><span class="n">attribute</span><span class="w"> </span><span class="ss">:account_number</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="p">,</span><span class="w"> </span><span class="ss">allow_nil?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
    </span><span class="n">attribute</span><span class="w"> </span><span class="ss">:type</span><span class="p">,</span><span class="w"> </span><span class="ss">:atom</span><span class="p">,</span><span class="w"> </span><span class="ss">constraints</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9554603503-6">[</span><span class="ss">one_of</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9554603503-7">[</span><span class="ss">:checking</span><span class="p">,</span><span class="w"> </span><span class="ss">:savings</span><span class="p" data-group-id="9554603503-7">]</span><span class="p" data-group-id="9554603503-6">]</span><span class="w">
  </span><span class="k" data-group-id="9554603503-5">end</span><span class="w">

  </span><span class="c1"># calculations do</span><span class="w">
  </span><span class="c1">#   calculate :implementation, AccountImplementation, GetAccountImplementation do</span><span class="w">
  </span><span class="c1">#    allow_nil? false</span><span class="w">
  </span><span class="c1">#  end</span><span class="w">
  </span><span class="c1"># end</span><span class="w">

  </span><span class="n">relationships</span><span class="w"> </span><span class="k" data-group-id="9554603503-8">do</span><span class="w">
    </span><span class="n">has_one</span><span class="w"> </span><span class="ss">:checking_account</span><span class="p">,</span><span class="w"> </span><span class="nc">CheckingAccount</span><span class="w">
    </span><span class="n">has_one</span><span class="w"> </span><span class="ss">:savings_account</span><span class="p">,</span><span class="w"> </span><span class="nc">SavingsAccount</span><span class="w">
  </span><span class="k" data-group-id="9554603503-8">end</span><span class="w">
</span><span class="k" data-group-id="9554603503-1">end</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">CheckingAccount</span><span class="w"> </span><span class="k" data-group-id="9554603503-9">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="nc">Finance</span><span class="p">,</span><span class="w">
    </span><span class="ss">data_layer</span><span class="p">:</span><span class="w"> </span><span class="nc">Ash.DataLayer.Ets</span><span class="w">

  </span><span class="n">actions</span><span class="w"> </span><span class="k" data-group-id="9554603503-10">do</span><span class="w">
    </span><span class="n">defaults</span><span class="w"> </span><span class="p" data-group-id="9554603503-11">[</span><span class="ss">:read</span><span class="p">,</span><span class="w"> </span><span class="ss">:destroy</span><span class="p">,</span><span class="w"> </span><span class="ss">create</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9554603503-12">[</span><span class="ss">:bank_account_id</span><span class="p" data-group-id="9554603503-12">]</span><span class="p" data-group-id="9554603503-11">]</span><span class="w">
  </span><span class="k" data-group-id="9554603503-10">end</span><span class="w">

  </span><span class="n">attributes</span><span class="w"> </span><span class="k" data-group-id="9554603503-13">do</span><span class="w">
    </span><span class="n">uuid_primary_key</span><span class="w"> </span><span class="ss">:id</span><span class="w">
  </span><span class="k" data-group-id="9554603503-13">end</span><span class="w">

  </span><span class="n">identities</span><span class="w"> </span><span class="k" data-group-id="9554603503-14">do</span><span class="w">
    </span><span class="n">identity</span><span class="w"> </span><span class="ss">:unique_bank_account</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9554603503-15">[</span><span class="ss">:bank_account_id</span><span class="p" data-group-id="9554603503-15">]</span><span class="p">,</span><span class="w"> </span><span class="ss">pre_check?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="k" data-group-id="9554603503-14">end</span><span class="w">

  </span><span class="n">relationships</span><span class="w"> </span><span class="k" data-group-id="9554603503-16">do</span><span class="w">
    </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:bank_account</span><span class="p">,</span><span class="w"> </span><span class="nc">BankAccount</span><span class="w"> </span><span class="k" data-group-id="9554603503-17">do</span><span class="w">
      </span><span class="n">allow_nil?</span><span class="w"> </span><span class="no">false</span><span class="w">
    </span><span class="k" data-group-id="9554603503-17">end</span><span class="w">
  </span><span class="k" data-group-id="9554603503-16">end</span><span class="w">
</span><span class="k" data-group-id="9554603503-9">end</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">SavingsAccount</span><span class="w"> </span><span class="k" data-group-id="9554603503-18">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="nc">Finance</span><span class="p">,</span><span class="w">
    </span><span class="ss">data_layer</span><span class="p">:</span><span class="w"> </span><span class="nc">Ash.DataLayer.Ets</span><span class="w">

  </span><span class="n">actions</span><span class="w"> </span><span class="k" data-group-id="9554603503-19">do</span><span class="w">
    </span><span class="n">defaults</span><span class="w"> </span><span class="p" data-group-id="9554603503-20">[</span><span class="ss">:read</span><span class="p">,</span><span class="w"> </span><span class="ss">:destroy</span><span class="p">,</span><span class="w"> </span><span class="ss">create</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9554603503-21">[</span><span class="ss">:bank_account_id</span><span class="p" data-group-id="9554603503-21">]</span><span class="p" data-group-id="9554603503-20">]</span><span class="w">
  </span><span class="k" data-group-id="9554603503-19">end</span><span class="w">


  </span><span class="n">attributes</span><span class="w"> </span><span class="k" data-group-id="9554603503-22">do</span><span class="w">
    </span><span class="n">uuid_primary_key</span><span class="w"> </span><span class="ss">:id</span><span class="w">
  </span><span class="k" data-group-id="9554603503-22">end</span><span class="w">

  </span><span class="n">identities</span><span class="w"> </span><span class="k" data-group-id="9554603503-23">do</span><span class="w">
    </span><span class="n">identity</span><span class="w"> </span><span class="ss">:unique_bank_account</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9554603503-24">[</span><span class="ss">:bank_account_id</span><span class="p" data-group-id="9554603503-24">]</span><span class="p">,</span><span class="w"> </span><span class="ss">pre_check?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="k" data-group-id="9554603503-23">end</span><span class="w">

  </span><span class="n">relationships</span><span class="w"> </span><span class="k" data-group-id="9554603503-25">do</span><span class="w">
    </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:bank_account</span><span class="p">,</span><span class="w"> </span><span class="nc">BankAccount</span><span class="w"> </span><span class="k" data-group-id="9554603503-26">do</span><span class="w">
      </span><span class="n">allow_nil?</span><span class="w"> </span><span class="no">false</span><span class="w">
    </span><span class="k" data-group-id="9554603503-26">end</span><span class="w">
  </span><span class="k" data-group-id="9554603503-25">end</span><span class="w">
</span><span class="k" data-group-id="9554603503-18">end</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Finance</span><span class="w"> </span><span class="k" data-group-id="9554603503-27">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Domain</span><span class="p">,</span><span class="w">
    </span><span class="ss">validate_config_inclusion?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">

  </span><span class="n">resources</span><span class="w"> </span><span class="k" data-group-id="9554603503-28">do</span><span class="w">
    </span><span class="n">resource</span><span class="w"> </span><span class="nc">BankAccount</span><span class="w">
    </span><span class="n">resource</span><span class="w"> </span><span class="nc">SavingsAccount</span><span class="w">
    </span><span class="n">resource</span><span class="w"> </span><span class="nc">CheckingAccount</span><span class="w">
  </span><span class="k" data-group-id="9554603503-28">end</span><span class="w">
</span><span class="k" data-group-id="9554603503-27">end</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="4643453470-1">{</span><span class="ss">:module</span><span class="p">,</span><span class="w"> </span><span class="nc">Finance</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4643453470-2">&lt;&lt;</span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="4643453470-2">&gt;&gt;</span><span class="p">,</span><span class="w">
 </span><span class="p" data-group-id="4643453470-3">[</span><span class="w">
   </span><span class="nc">Ash.Domain.Dsl.Resources.Resource</span><span class="p">,</span><span class="w">
   </span><span class="nc">Ash.Domain.Dsl.Resources.Options</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="4643453470-4">%{</span><span class="ss">opts</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4643453470-5">[</span><span class="p" data-group-id="4643453470-5">]</span><span class="p">,</span><span class="w"> </span><span class="ss">entities</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4643453470-6">[</span><span class="p" data-group-id="4643453470-7">%</span><span class="nc" data-group-id="4643453470-7">Ash.Domain.Dsl.ResourceReference</span><span class="p" data-group-id="4643453470-7">{</span><span class="n">...</span><span class="p" data-group-id="4643453470-7">}</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="4643453470-6">]</span><span class="p" data-group-id="4643453470-4">}</span><span class="w">
 </span><span class="p" data-group-id="4643453470-3">]</span><span class="p" data-group-id="4643453470-1">}</span></code></pre><p>We haven't implemented the polymorphic part yet, but lets create a few of the above resources to show how they relate. Below we create a <code class="inline">BankAccount</code> for checkings, and a <code class="inline">BankAccount</code> for savings, and connect them to their &quot;specific&quot; types, i.e <code class="inline">CheckingAccount</code> and <code class="inline">SavingsAccount</code>.</p><p>We load the data, you can see that one <code class="inline">BankAccount</code> has a <code class="inline">:checking_account</code> but no <code class="inline">:savings_account</code>. For the other, the opposite is the case.</p><pre><code class="makeup elixir" translate="no"><span class="n">bank_account1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">create!</span><span class="p" data-group-id="7583851302-1">(</span><span class="nc">BankAccount</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7583851302-2">%{</span><span class="ss">account_number</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:checking</span><span class="p" data-group-id="7583851302-2">}</span><span class="p" data-group-id="7583851302-1">)</span><span class="w">
</span><span class="n">bank_account2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">create!</span><span class="p" data-group-id="7583851302-3">(</span><span class="nc">BankAccount</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7583851302-4">%{</span><span class="ss">account_number</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:savings</span><span class="p" data-group-id="7583851302-4">}</span><span class="p" data-group-id="7583851302-3">)</span><span class="w">
</span><span class="n">checking_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">create!</span><span class="p" data-group-id="7583851302-5">(</span><span class="nc">CheckingAccount</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7583851302-6">%{</span><span class="ss">bank_account_id</span><span class="p">:</span><span class="w"> </span><span class="n">bank_account1</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="7583851302-6">}</span><span class="p" data-group-id="7583851302-5">)</span><span class="w">
</span><span class="n">savings_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">create!</span><span class="p" data-group-id="7583851302-7">(</span><span class="nc">SavingsAccount</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7583851302-8">%{</span><span class="ss">bank_account_id</span><span class="p">:</span><span class="w"> </span><span class="n">bank_account2</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="7583851302-8">}</span><span class="p" data-group-id="7583851302-7">)</span><span class="w">

</span><span class="p" data-group-id="7583851302-9">[</span><span class="n">bank_account1</span><span class="p">,</span><span class="w"> </span><span class="n">bank_account2</span><span class="p" data-group-id="7583851302-9">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">load!</span><span class="p" data-group-id="7583851302-10">(</span><span class="p" data-group-id="7583851302-11">[</span><span class="ss">:checking_account</span><span class="p">,</span><span class="w"> </span><span class="ss">:savings_account</span><span class="p" data-group-id="7583851302-11">]</span><span class="p" data-group-id="7583851302-10">)</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="5737494697-1">[</span><span class="w">
  </span><span class="p" data-group-id="5737494697-2">#</span><span class="nc" data-group-id="5737494697-2">BankAccount</span><span class="p" data-group-id="5737494697-2">&lt;</span><span class="w">
    </span><span class="ss">implementation</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-3">#</span><span class="nc" data-group-id="5737494697-3">Ash.NotLoaded</span><span class="p" data-group-id="5737494697-3">&lt;</span><span class="ss">:calculation</span><span class="p">,</span><span class="w"> </span><span class="ss">field</span><span class="p">:</span><span class="w"> </span><span class="ss">:implementation</span><span class="p" data-group-id="5737494697-3">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">savings_account</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
    </span><span class="ss">checking_account</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-4">#</span><span class="nc" data-group-id="5737494697-4">CheckingAccount</span><span class="p" data-group-id="5737494697-4">&lt;</span><span class="w">
      </span><span class="ss">bank_account</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-5">#</span><span class="nc" data-group-id="5737494697-5">Ash.NotLoaded</span><span class="p" data-group-id="5737494697-5">&lt;</span><span class="ss">:relationship</span><span class="p">,</span><span class="w"> </span><span class="ss">field</span><span class="p">:</span><span class="w"> </span><span class="ss">:bank_account</span><span class="p" data-group-id="5737494697-5">&gt;</span><span class="p">,</span><span class="w">
      </span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-6">#</span><span class="nc" data-group-id="5737494697-6">Ecto.Schema.Metadata</span><span class="p" data-group-id="5737494697-6">&lt;</span><span class="ss">:loaded</span><span class="p" data-group-id="5737494697-6">&gt;</span><span class="p">,</span><span class="w">
      </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60f585f6-f352-410e-8c09-09ae49448851&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">bank_account_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;21d27a6c-49b8-4984-a1b7-f2ef030626af&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">aggregates</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-7">%{</span><span class="p" data-group-id="5737494697-7">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">calculations</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-8">%{</span><span class="p" data-group-id="5737494697-8">}</span><span class="p">,</span><span class="w">
      </span><span class="n">...</span><span class="w">
    </span><span class="p" data-group-id="5737494697-4">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-9">#</span><span class="nc" data-group-id="5737494697-9">Ecto.Schema.Metadata</span><span class="p" data-group-id="5737494697-9">&lt;</span><span class="ss">:loaded</span><span class="p" data-group-id="5737494697-9">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;21d27a6c-49b8-4984-a1b7-f2ef030626af&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">account_number</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:checking</span><span class="p">,</span><span class="w">
    </span><span class="ss">aggregates</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-10">%{</span><span class="p" data-group-id="5737494697-10">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">calculations</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-11">%{</span><span class="p" data-group-id="5737494697-11">}</span><span class="p">,</span><span class="w">
    </span><span class="n">...</span><span class="w">
  </span><span class="p" data-group-id="5737494697-2">&gt;</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="5737494697-12">#</span><span class="nc" data-group-id="5737494697-12">BankAccount</span><span class="p" data-group-id="5737494697-12">&lt;</span><span class="w">
    </span><span class="ss">implementation</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-13">#</span><span class="nc" data-group-id="5737494697-13">Ash.NotLoaded</span><span class="p" data-group-id="5737494697-13">&lt;</span><span class="ss">:calculation</span><span class="p">,</span><span class="w"> </span><span class="ss">field</span><span class="p">:</span><span class="w"> </span><span class="ss">:implementation</span><span class="p" data-group-id="5737494697-13">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">savings_account</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-14">#</span><span class="nc" data-group-id="5737494697-14">SavingsAccount</span><span class="p" data-group-id="5737494697-14">&lt;</span><span class="w">
      </span><span class="ss">bank_account</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-15">#</span><span class="nc" data-group-id="5737494697-15">Ash.NotLoaded</span><span class="p" data-group-id="5737494697-15">&lt;</span><span class="ss">:relationship</span><span class="p">,</span><span class="w"> </span><span class="ss">field</span><span class="p">:</span><span class="w"> </span><span class="ss">:bank_account</span><span class="p" data-group-id="5737494697-15">&gt;</span><span class="p">,</span><span class="w">
      </span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-16">#</span><span class="nc" data-group-id="5737494697-16">Ecto.Schema.Metadata</span><span class="p" data-group-id="5737494697-16">&lt;</span><span class="ss">:loaded</span><span class="p" data-group-id="5737494697-16">&gt;</span><span class="p">,</span><span class="w">
      </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;d2bcc1cc-d709-418d-a9ff-0d21fd7d667b&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">bank_account_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4d8dc988-3e09-4efb-a643-d822013abfba&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">aggregates</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-17">%{</span><span class="p" data-group-id="5737494697-17">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">calculations</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-18">%{</span><span class="p" data-group-id="5737494697-18">}</span><span class="p">,</span><span class="w">
      </span><span class="n">...</span><span class="w">
    </span><span class="p" data-group-id="5737494697-14">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">checking_account</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
    </span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-19">#</span><span class="nc" data-group-id="5737494697-19">Ecto.Schema.Metadata</span><span class="p" data-group-id="5737494697-19">&lt;</span><span class="ss">:loaded</span><span class="p" data-group-id="5737494697-19">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4d8dc988-3e09-4efb-a643-d822013abfba&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">account_number</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:savings</span><span class="p">,</span><span class="w">
    </span><span class="ss">aggregates</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-20">%{</span><span class="p" data-group-id="5737494697-20">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">calculations</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5737494697-21">%{</span><span class="p" data-group-id="5737494697-21">}</span><span class="p">,</span><span class="w">
    </span><span class="n">...</span><span class="w">
  </span><span class="p" data-group-id="5737494697-12">&gt;</span><span class="w">
</span><span class="p" data-group-id="5737494697-1">]</span></code></pre><h2 id="defining-our-union-type">Defining our union type</h2><p>Below we define an <a href="Ash.Type.NewType.xhtml"><code class="inline">Ash.Type.NewType</code></a>. This allows defining a new type that is the combination of an existing type and custom constraints.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">AccountImplementation</span><span class="w"> </span><span class="k" data-group-id="5879724586-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Type.NewType</span><span class="p">,</span><span class="w"> </span><span class="ss">subtype_of</span><span class="p">:</span><span class="w"> </span><span class="ss">:union</span><span class="p">,</span><span class="w"> </span><span class="ss">constraints</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5879724586-2">[</span><span class="w">
    </span><span class="ss">types</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5879724586-3">[</span><span class="w">
      </span><span class="ss">checking</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5879724586-4">[</span><span class="w">
        </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:struct</span><span class="p">,</span><span class="w">
        </span><span class="ss">constraints</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5879724586-5">[</span><span class="ss">instance_of</span><span class="p">:</span><span class="w"> </span><span class="nc">CheckingAccount</span><span class="p" data-group-id="5879724586-5">]</span><span class="w">
      </span><span class="p" data-group-id="5879724586-4">]</span><span class="p">,</span><span class="w">
      </span><span class="ss">savings</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5879724586-6">[</span><span class="w">
        </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:struct</span><span class="p">,</span><span class="w">
        </span><span class="ss">constraints</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5879724586-7">[</span><span class="ss">instance_of</span><span class="p">:</span><span class="w"> </span><span class="nc">SavingsAccount</span><span class="p" data-group-id="5879724586-7">]</span><span class="w">
      </span><span class="p" data-group-id="5879724586-6">]</span><span class="w">
    </span><span class="p" data-group-id="5879724586-3">]</span><span class="w">
  </span><span class="p" data-group-id="5879724586-2">]</span><span class="w">
</span><span class="k" data-group-id="5879724586-1">end</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="2572486832-1">{</span><span class="ss">:module</span><span class="p">,</span><span class="w"> </span><span class="nc">AccountImplementation</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2572486832-2">&lt;&lt;</span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="2572486832-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p" data-group-id="2572486832-1">}</span></code></pre><h2 id="defining-the-calculation">Defining the calculation</h2><p>Next, we'll define a calculation resolves to the specific type of any given account.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">GetAccountImplementation</span><span class="w"> </span><span class="k" data-group-id="4434858170-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource.Calculation</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">load</span><span class="p" data-group-id="4434858170-2">(</span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="4434858170-2">)</span><span class="w"> </span><span class="k" data-group-id="4434858170-3">do</span><span class="w">
    </span><span class="p" data-group-id="4434858170-4">[</span><span class="ss">:checking_account</span><span class="p">,</span><span class="w"> </span><span class="ss">:savings_account</span><span class="p" data-group-id="4434858170-4">]</span><span class="w">
  </span><span class="k" data-group-id="4434858170-3">end</span><span class="w">

  </span><span class="c1"># This ensures that all attributes are selected by default</span><span class="w">
  </span><span class="c1"># on the related loads we depend on.</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">strict_loads?</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p" data-group-id="4434858170-5">(</span><span class="n">records</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="4434858170-5">)</span><span class="w"> </span><span class="k" data-group-id="4434858170-6">do</span><span class="w">
    </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="4434858170-7">(</span><span class="n">records</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="4434858170-8">fn</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="k">cond</span><span class="w"> </span><span class="k" data-group-id="4434858170-9">do</span><span class="w">
        </span><span class="n">record</span><span class="o">.</span><span class="n">checking_account</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
          </span><span class="p" data-group-id="4434858170-10">%</span><span class="nc" data-group-id="4434858170-10">Ash.Union</span><span class="p" data-group-id="4434858170-10">{</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:checking_account</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="n">record</span><span class="o">.</span><span class="n">checking_account</span><span class="p" data-group-id="4434858170-10">}</span><span class="w">

        </span><span class="n">record</span><span class="o">.</span><span class="n">savings_account</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
          </span><span class="p" data-group-id="4434858170-11">%</span><span class="nc" data-group-id="4434858170-11">Ash.Union</span><span class="p" data-group-id="4434858170-11">{</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:savings_account</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="n">record</span><span class="o">.</span><span class="n">savings_account</span><span class="p" data-group-id="4434858170-11">}</span><span class="w">

        </span><span class="no">true</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
          </span><span class="no">nil</span><span class="w">
      </span><span class="k" data-group-id="4434858170-9">end</span><span class="w">
    </span><span class="k" data-group-id="4434858170-8">end</span><span class="p" data-group-id="4434858170-7">)</span><span class="w">
  </span><span class="k" data-group-id="4434858170-6">end</span><span class="w">
</span><span class="k" data-group-id="4434858170-1">end</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="2386508185-1">{</span><span class="ss">:module</span><span class="p">,</span><span class="w"> </span><span class="nc">GetAccountImplementation</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2386508185-2">&lt;&lt;</span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="2386508185-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2386508185-3">{</span><span class="ss">:calculate</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="2386508185-3">}</span><span class="p" data-group-id="2386508185-1">}</span></code></pre><h2 id="adding-the-calculation-to-our-resource">Adding the calculation to our resource</h2><p>Finally, we'll add the calculation to our <code class="inline">BankAccount</code> resource!</p><p>For those following along with the LiveBook, go back up and uncomment the commented out calculation.</p><p>Now we can load <code class="inline">:implementation</code> and see that, for one account, it resolves to a <code class="inline">CheckingAccount</code> and for the other it resolves to a <code class="inline">SavingsAccount</code>.</p><pre><code class="makeup elixir" translate="no"><span class="n">bank_account1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">create!</span><span class="p" data-group-id="8937403373-1">(</span><span class="nc">BankAccount</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8937403373-2">%{</span><span class="ss">account_number</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:checking</span><span class="p" data-group-id="8937403373-2">}</span><span class="p" data-group-id="8937403373-1">)</span><span class="w">
</span><span class="n">bank_account2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">create!</span><span class="p" data-group-id="8937403373-3">(</span><span class="nc">BankAccount</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8937403373-4">%{</span><span class="ss">account_number</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:savings</span><span class="p" data-group-id="8937403373-4">}</span><span class="p" data-group-id="8937403373-3">)</span><span class="w">
</span><span class="n">checking_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">create!</span><span class="p" data-group-id="8937403373-5">(</span><span class="nc">CheckingAccount</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8937403373-6">%{</span><span class="ss">bank_account_id</span><span class="p">:</span><span class="w"> </span><span class="n">bank_account1</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="8937403373-6">}</span><span class="p" data-group-id="8937403373-5">)</span><span class="w">
</span><span class="n">savings_account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">create!</span><span class="p" data-group-id="8937403373-7">(</span><span class="nc">SavingsAccount</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8937403373-8">%{</span><span class="ss">bank_account_id</span><span class="p">:</span><span class="w"> </span><span class="n">bank_account2</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="8937403373-8">}</span><span class="p" data-group-id="8937403373-7">)</span><span class="w">

</span><span class="p" data-group-id="8937403373-9">[</span><span class="n">bank_account1</span><span class="p">,</span><span class="w"> </span><span class="n">bank_account2</span><span class="p" data-group-id="8937403373-9">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">load!</span><span class="p" data-group-id="8937403373-10">(</span><span class="p" data-group-id="8937403373-11">[</span><span class="ss">:implementation</span><span class="p" data-group-id="8937403373-11">]</span><span class="p" data-group-id="8937403373-10">)</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="1039341907-1">[</span><span class="w">
  </span><span class="p" data-group-id="1039341907-2">#</span><span class="nc" data-group-id="1039341907-2">BankAccount</span><span class="p" data-group-id="1039341907-2">&lt;</span><span class="w">
    </span><span class="ss">implementation</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-3">#</span><span class="nc" data-group-id="1039341907-3">CheckingAccount</span><span class="p" data-group-id="1039341907-3">&lt;</span><span class="w">
      </span><span class="ss">bank_account</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-4">#</span><span class="nc" data-group-id="1039341907-4">Ash.NotLoaded</span><span class="p" data-group-id="1039341907-4">&lt;</span><span class="ss">:relationship</span><span class="p">,</span><span class="w"> </span><span class="ss">field</span><span class="p">:</span><span class="w"> </span><span class="ss">:bank_account</span><span class="p" data-group-id="1039341907-4">&gt;</span><span class="p">,</span><span class="w">
      </span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-5">#</span><span class="nc" data-group-id="1039341907-5">Ecto.Schema.Metadata</span><span class="p" data-group-id="1039341907-5">&lt;</span><span class="ss">:loaded</span><span class="p" data-group-id="1039341907-5">&gt;</span><span class="p">,</span><span class="w">
      </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1d1a7b6c-dd08-4b8c-9769-2c1155a41a40&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">bank_account_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ce370381-303e-49dc-9950-a05b5052e7f8&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">aggregates</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-6">%{</span><span class="p" data-group-id="1039341907-6">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">calculations</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-7">%{</span><span class="p" data-group-id="1039341907-7">}</span><span class="p">,</span><span class="w">
      </span><span class="n">...</span><span class="w">
    </span><span class="p" data-group-id="1039341907-3">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">savings_account</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-8">#</span><span class="nc" data-group-id="1039341907-8">Ash.NotLoaded</span><span class="p" data-group-id="1039341907-8">&lt;</span><span class="ss">:relationship</span><span class="p">,</span><span class="w"> </span><span class="ss">field</span><span class="p">:</span><span class="w"> </span><span class="ss">:savings_account</span><span class="p" data-group-id="1039341907-8">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">checking_account</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-9">#</span><span class="nc" data-group-id="1039341907-9">Ash.NotLoaded</span><span class="p" data-group-id="1039341907-9">&lt;</span><span class="ss">:relationship</span><span class="p">,</span><span class="w"> </span><span class="ss">field</span><span class="p">:</span><span class="w"> </span><span class="ss">:checking_account</span><span class="p" data-group-id="1039341907-9">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-10">#</span><span class="nc" data-group-id="1039341907-10">Ecto.Schema.Metadata</span><span class="p" data-group-id="1039341907-10">&lt;</span><span class="ss">:loaded</span><span class="p" data-group-id="1039341907-10">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ce370381-303e-49dc-9950-a05b5052e7f8&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">account_number</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:checking</span><span class="p">,</span><span class="w">
    </span><span class="ss">aggregates</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-11">%{</span><span class="p" data-group-id="1039341907-11">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">calculations</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-12">%{</span><span class="p" data-group-id="1039341907-12">}</span><span class="p">,</span><span class="w">
    </span><span class="n">...</span><span class="w">
  </span><span class="p" data-group-id="1039341907-2">&gt;</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="1039341907-13">#</span><span class="nc" data-group-id="1039341907-13">BankAccount</span><span class="p" data-group-id="1039341907-13">&lt;</span><span class="w">
    </span><span class="ss">implementation</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-14">#</span><span class="nc" data-group-id="1039341907-14">SavingsAccount</span><span class="p" data-group-id="1039341907-14">&lt;</span><span class="w">
      </span><span class="ss">bank_account</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-15">#</span><span class="nc" data-group-id="1039341907-15">Ash.NotLoaded</span><span class="p" data-group-id="1039341907-15">&lt;</span><span class="ss">:relationship</span><span class="p">,</span><span class="w"> </span><span class="ss">field</span><span class="p">:</span><span class="w"> </span><span class="ss">:bank_account</span><span class="p" data-group-id="1039341907-15">&gt;</span><span class="p">,</span><span class="w">
      </span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-16">#</span><span class="nc" data-group-id="1039341907-16">Ecto.Schema.Metadata</span><span class="p" data-group-id="1039341907-16">&lt;</span><span class="ss">:loaded</span><span class="p" data-group-id="1039341907-16">&gt;</span><span class="p">,</span><span class="w">
      </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;e537116d-c5b8-414a-a350-fa9b2afe0a4e&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">bank_account_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;c4739158-2a1f-4de8-bccb-ee1d1ee9e602&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">aggregates</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-17">%{</span><span class="p" data-group-id="1039341907-17">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">calculations</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-18">%{</span><span class="p" data-group-id="1039341907-18">}</span><span class="p">,</span><span class="w">
      </span><span class="n">...</span><span class="w">
    </span><span class="p" data-group-id="1039341907-14">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">savings_account</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-19">#</span><span class="nc" data-group-id="1039341907-19">Ash.NotLoaded</span><span class="p" data-group-id="1039341907-19">&lt;</span><span class="ss">:relationship</span><span class="p">,</span><span class="w"> </span><span class="ss">field</span><span class="p">:</span><span class="w"> </span><span class="ss">:savings_account</span><span class="p" data-group-id="1039341907-19">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">checking_account</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-20">#</span><span class="nc" data-group-id="1039341907-20">Ash.NotLoaded</span><span class="p" data-group-id="1039341907-20">&lt;</span><span class="ss">:relationship</span><span class="p">,</span><span class="w"> </span><span class="ss">field</span><span class="p">:</span><span class="w"> </span><span class="ss">:checking_account</span><span class="p" data-group-id="1039341907-20">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-21">#</span><span class="nc" data-group-id="1039341907-21">Ecto.Schema.Metadata</span><span class="p" data-group-id="1039341907-21">&lt;</span><span class="ss">:loaded</span><span class="p" data-group-id="1039341907-21">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;c4739158-2a1f-4de8-bccb-ee1d1ee9e602&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">account_number</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:savings</span><span class="p">,</span><span class="w">
    </span><span class="ss">aggregates</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-22">%{</span><span class="p" data-group-id="1039341907-22">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">calculations</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1039341907-23">%{</span><span class="p" data-group-id="1039341907-23">}</span><span class="p">,</span><span class="w">
    </span><span class="n">...</span><span class="w">
  </span><span class="p" data-group-id="1039341907-13">&gt;</span><span class="w">
</span><span class="p" data-group-id="1039341907-1">]</span></code></pre><h2 id="taking-it-further">Taking it further</h2><p>One of the best things about using <a href="Ash.Type.Union.xhtml"><code class="inline">Ash.Type.Union</code></a> is how it is <em>integrated</em>. Every extension (provided by the Ash team) supports working with unions. For example:</p><ul><li><a href="https://hexdocs.pm/ash_phoenix/union-forms.html">Working with Unions in AshPhoenix.Form</a></li><li><a href="https://hexdocs.pm/ash_graphql/use-unions-with-graphql.html">AshGraphql &amp; AshJsonApi Unions</a></li></ul><p>You can also synthesize filterable fields with calculations. For example, if you wanted to allow filtering <code class="inline">BankAccount</code> by <code class="inline">:interest_rate</code>, and that field only existed on <code class="inline">SavingsAccount</code>, you might have a calculation like this on <code class="inline">BankAccount</code>:</p><!-- livebook:{"force_markdown":true} --><pre><code class="makeup elixir" translate="no"><span class="n">calculate</span><span class="w"> </span><span class="ss">:interest_rate</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="1415541137-1">(</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:savings</span><span class="w"> </span><span class="k" data-group-id="1415541137-2">do</span><span class="w">
    </span><span class="n">savings_account</span><span class="o">.</span><span class="n">interest_rate</span><span class="w">
  </span><span class="k" data-group-id="1415541137-2">else</span><span class="w">
    </span><span class="mi">0</span><span class="w">
  </span><span class="k" data-group-id="1415541137-2">end</span><span class="w">
</span><span class="p" data-group-id="1415541137-1">)</span></code></pre><p>This would allow usage like the following:</p><!-- livebook:{"force_markdown":true} --><pre><code class="makeup elixir" translate="no"><span class="nc">BankAccount</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="5006310911-1">(</span><span class="n">interest_rate</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.01</span><span class="p" data-group-id="5006310911-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="5006310911-2">(</span><span class="p" data-group-id="5006310911-2">)</span></code></pre>

  </body>
</html>
