<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
      xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>Authorize Access to Resources - ash v3.5.33</title>
    <meta name="generator" content="ExDoc v0.38.2" />
    <link type="text/css" rel="stylesheet" href="dist/epub-elixir-FNUUKFP7.css" />
    <script src="dist/epub-4WIP524F.js"></script>

  </head>
  <body class="content-inner">

    <h1 id="content">Authorize Access to Resources</h1>
<pre><code class="makeup elixir" translate="no"><span class="nc">Mix</span><span class="o">.</span><span class="n">install</span><span class="p" data-group-id="8908667303-1">(</span><span class="w">
  </span><span class="p" data-group-id="8908667303-2">[</span><span class="w">
    </span><span class="p" data-group-id="8908667303-3">{</span><span class="ss">:ash</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 3.0&quot;</span><span class="p" data-group-id="8908667303-3">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="8908667303-4">{</span><span class="ss">:simple_sat</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.1&quot;</span><span class="p" data-group-id="8908667303-4">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="8908667303-5">{</span><span class="ss">:kino</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.12&quot;</span><span class="p" data-group-id="8908667303-5">}</span><span class="w">
  </span><span class="p" data-group-id="8908667303-2">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">consolidate_protocols</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
</span><span class="p" data-group-id="8908667303-1">)</span><span class="w">

</span><span class="nc">Logger</span><span class="o">.</span><span class="n">configure</span><span class="p" data-group-id="8908667303-6">(</span><span class="ss">level</span><span class="p">:</span><span class="w"> </span><span class="ss">:warning</span><span class="p" data-group-id="8908667303-6">)</span><span class="w">
</span><span class="nc">Application</span><span class="o">.</span><span class="n">put_env</span><span class="p" data-group-id="8908667303-7">(</span><span class="ss">:ash</span><span class="p">,</span><span class="w"> </span><span class="ss">:policies</span><span class="p">,</span><span class="w"> </span><span class="ss">show_policy_breakdowns?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="8908667303-7">)</span></code></pre><h2 id="introduction">Introduction</h2><p>A key feature of Ash is the ability to build security directly into your resources. We do this with policies.</p><p>Because how you write policies is <em>extremely</em> situational, this how-to guide provides a list of &quot;considerations&quot; as opposed to &quot;instructions&quot;.</p><p>For more context, read the <a href="https://hexdocs.pm/ash/policies.html#policies">policies guide</a>.</p><h2 id="writing-policies">Writing Policies</h2><ol><li>Consider whether or not you want to adopt a specific style of authorization, like <a href="https://en.wikipedia.org/wiki/Access-control_list">ACL</a>, or <a href="https://en.wikipedia.org/wiki/Role-based_access_control">RBAC</a>. For standard RBAC, look into <a href="https://hexdocs.pm/ash_rbac/getting_started.html">AshRbac</a>, and you may not need to write any of your own policies at that point</li><li>Determine if there are any <code class="inline">bypass</code> policies to add (admin users, super users, etc.). Consider placing this on the domain, instead of the resource</li><li>Begin by making an inventory of each action on your resource, and under what conditions a given actor may be allowed to perform them. If all actions of a given type have the same criteria, we will typically use the <code class="inline">action_type(:type)</code> condition</li><li>Armed with this inventory, begin to write policies. Start simple, write a policy per action type, and add a description of what your policy accomplishes.</li><li>Find patterns, like cross-cutting checks that exist in all policies, that can be expressed as smaller, simpler policies</li><li>Determine if any field policies are required to prohibit access to attributes/calculations/aggregates</li><li>Finally, you can confirm your understanding of the authorization flow for a given resource by generating policy charts with <a href="Mix.Tasks.Ash.GeneratePolicyCharts.xhtml"><code class="inline">mix ash.generate_policy_charts</code></a> (field policies are not currently included in the generated charts)</li></ol><h2 id="example">Example</h2><!-- livebook:{"disable_formatting":true} --><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">User</span><span class="w"> </span><span class="k" data-group-id="5592989142-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="nc">Domain</span><span class="p">,</span><span class="w">
    </span><span class="ss">data_layer</span><span class="p">:</span><span class="w"> </span><span class="nc">Ash.DataLayer.Ets</span><span class="w">

  </span><span class="n">actions</span><span class="w"> </span><span class="k" data-group-id="5592989142-2">do</span><span class="w">
    </span><span class="n">defaults</span><span class="w"> </span><span class="p" data-group-id="5592989142-3">[</span><span class="ss">:read</span><span class="p">,</span><span class="w"> </span><span class="ss">create</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5592989142-4">[</span><span class="ss">:admin?</span><span class="p" data-group-id="5592989142-4">]</span><span class="p" data-group-id="5592989142-3">]</span><span class="w">
  </span><span class="k" data-group-id="5592989142-2">end</span><span class="w">

  </span><span class="n">attributes</span><span class="w"> </span><span class="k" data-group-id="5592989142-5">do</span><span class="w">
    </span><span class="n">uuid_primary_key</span><span class="w"> </span><span class="ss">:id</span><span class="w">
    </span><span class="n">attribute</span><span class="w"> </span><span class="ss">:admin?</span><span class="p">,</span><span class="w"> </span><span class="ss">:boolean</span><span class="w"> </span><span class="k" data-group-id="5592989142-6">do</span><span class="w">
      </span><span class="n">allow_nil?</span><span class="w"> </span><span class="no">false</span><span class="w">
      </span><span class="n">default</span><span class="w"> </span><span class="no">false</span><span class="w">
    </span><span class="k" data-group-id="5592989142-6">end</span><span class="w">
  </span><span class="k" data-group-id="5592989142-5">end</span><span class="w">
</span><span class="k" data-group-id="5592989142-1">end</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Tweet</span><span class="w"> </span><span class="k" data-group-id="5592989142-7">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="nc">Domain</span><span class="p">,</span><span class="w">
    </span><span class="ss">data_layer</span><span class="p">:</span><span class="w"> </span><span class="nc">Ash.DataLayer.Ets</span><span class="p">,</span><span class="w">
    </span><span class="ss">authorizers</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5592989142-8">[</span><span class="nc">Ash.Policy.Authorizer</span><span class="p" data-group-id="5592989142-8">]</span><span class="w">

  </span><span class="n">attributes</span><span class="w"> </span><span class="k" data-group-id="5592989142-9">do</span><span class="w">
    </span><span class="n">uuid_primary_key</span><span class="w"> </span><span class="ss">:id</span><span class="w">
    </span><span class="n">attribute</span><span class="w"> </span><span class="ss">:text</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w"> </span><span class="k" data-group-id="5592989142-10">do</span><span class="w">
      </span><span class="n">allow_nil?</span><span class="w"> </span><span class="no">false</span><span class="w">
      </span><span class="n">constraints</span><span class="w"> </span><span class="ss">max_length</span><span class="p">:</span><span class="w"> </span><span class="mi">144</span><span class="w">
      </span><span class="n">public?</span><span class="w"> </span><span class="no">true</span><span class="w">
    </span><span class="k" data-group-id="5592989142-10">end</span><span class="w">

    </span><span class="n">attribute</span><span class="w"> </span><span class="ss">:hidden?</span><span class="p">,</span><span class="w"> </span><span class="ss">:boolean</span><span class="w"> </span><span class="k" data-group-id="5592989142-11">do</span><span class="w">
      </span><span class="n">allow_nil?</span><span class="w"> </span><span class="no">false</span><span class="w">
      </span><span class="n">default</span><span class="w"> </span><span class="no">false</span><span class="w">
      </span><span class="n">public?</span><span class="w"> </span><span class="no">true</span><span class="w">
    </span><span class="k" data-group-id="5592989142-11">end</span><span class="w">

    </span><span class="n">attribute</span><span class="w"> </span><span class="ss">:private_note</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w"> </span><span class="k" data-group-id="5592989142-12">do</span><span class="w">
      </span><span class="n">sensitive?</span><span class="w"> </span><span class="no">true</span><span class="w">
      </span><span class="n">public?</span><span class="w"> </span><span class="no">true</span><span class="w">
    </span><span class="k" data-group-id="5592989142-12">end</span><span class="w">
  </span><span class="k" data-group-id="5592989142-9">end</span><span class="w">

  </span><span class="n">calculations</span><span class="w"> </span><span class="k" data-group-id="5592989142-13">do</span><span class="w">
    </span><span class="n">calculate</span><span class="w"> </span><span class="ss">:tweet_length</span><span class="p">,</span><span class="w"> </span><span class="ss">:integer</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="5592989142-14">(</span><span class="n">string_length</span><span class="p" data-group-id="5592989142-15">(</span><span class="n">text</span><span class="p" data-group-id="5592989142-15">)</span><span class="p" data-group-id="5592989142-14">)</span><span class="w"> </span><span class="k" data-group-id="5592989142-16">do</span><span class="w">
      </span><span class="n">public?</span><span class="w"> </span><span class="no">true</span><span class="w">
    </span><span class="k" data-group-id="5592989142-16">end</span><span class="w">
  </span><span class="k" data-group-id="5592989142-13">end</span><span class="w">

  </span><span class="n">relationships</span><span class="w"> </span><span class="k" data-group-id="5592989142-17">do</span><span class="w">
    </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:user</span><span class="p">,</span><span class="w"> </span><span class="nc">User</span><span class="p">,</span><span class="w"> </span><span class="ss">allow_nil?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
  </span><span class="k" data-group-id="5592989142-17">end</span><span class="w">

  </span><span class="n">actions</span><span class="w"> </span><span class="k" data-group-id="5592989142-18">do</span><span class="w">
    </span><span class="n">defaults</span><span class="w"> </span><span class="p" data-group-id="5592989142-19">[</span><span class="ss">:read</span><span class="p">,</span><span class="w"> </span><span class="ss">update</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5592989142-20">[</span><span class="ss">:text</span><span class="p">,</span><span class="w"> </span><span class="ss">:hidden?</span><span class="p">,</span><span class="w"> </span><span class="ss">:private_note</span><span class="p" data-group-id="5592989142-20">]</span><span class="p" data-group-id="5592989142-19">]</span><span class="w">

    </span><span class="n">create</span><span class="w"> </span><span class="ss">:create</span><span class="w"> </span><span class="k" data-group-id="5592989142-21">do</span><span class="w">
      </span><span class="n">primary?</span><span class="w"> </span><span class="no">true</span><span class="w">
      </span><span class="n">accept</span><span class="w"> </span><span class="p" data-group-id="5592989142-22">[</span><span class="ss">:text</span><span class="p">,</span><span class="w"> </span><span class="ss">:hidden?</span><span class="p">,</span><span class="w"> </span><span class="ss">:private_note</span><span class="p" data-group-id="5592989142-22">]</span><span class="w">
      </span><span class="n">change</span><span class="w"> </span><span class="n">relate_actor</span><span class="p" data-group-id="5592989142-23">(</span><span class="ss">:user</span><span class="p" data-group-id="5592989142-23">)</span><span class="w">
    </span><span class="k" data-group-id="5592989142-21">end</span><span class="w">
  </span><span class="k" data-group-id="5592989142-18">end</span><span class="w">

  </span><span class="n">policies</span><span class="w"> </span><span class="k" data-group-id="5592989142-24">do</span><span class="w">
    </span><span class="c1"># action_type-based policies</span><span class="w">
    </span><span class="n">policy</span><span class="w"> </span><span class="n">action_type</span><span class="p" data-group-id="5592989142-25">(</span><span class="ss">:read</span><span class="p" data-group-id="5592989142-25">)</span><span class="w"> </span><span class="k" data-group-id="5592989142-26">do</span><span class="w">
      </span><span class="c1"># each policy has a description</span><span class="w">
      </span><span class="n">description</span><span class="w"> </span><span class="s">&quot;If a tweet is hidden, only the author can read it. Otherwise, anyone can.&quot;</span><span class="w">
      </span><span class="c1"># first check this. If true, then this policy passes</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">relates_to_actor_via</span><span class="p" data-group-id="5592989142-27">(</span><span class="ss">:user</span><span class="p" data-group-id="5592989142-27">)</span><span class="w">
      </span><span class="c1"># then check this. If false, then this policy fails</span><span class="w">
      </span><span class="n">forbid_if</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="5592989142-28">(</span><span class="n">hidden?</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="5592989142-28">)</span><span class="w">
      </span><span class="c1"># otherwise, this policy passes</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="5592989142-29">(</span><span class="p" data-group-id="5592989142-29">)</span><span class="w">
    </span><span class="k" data-group-id="5592989142-26">end</span><span class="w">

    </span><span class="c1"># blanket allow-listing of creates</span><span class="w">
    </span><span class="n">policy</span><span class="w"> </span><span class="n">action_type</span><span class="p" data-group-id="5592989142-30">(</span><span class="ss">:create</span><span class="p" data-group-id="5592989142-30">)</span><span class="w"> </span><span class="k" data-group-id="5592989142-31">do</span><span class="w">
      </span><span class="n">description</span><span class="w"> </span><span class="s">&quot;Anyone can create a tweet&quot;</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="5592989142-32">(</span><span class="p" data-group-id="5592989142-32">)</span><span class="w">
    </span><span class="k" data-group-id="5592989142-31">end</span><span class="w">

    </span><span class="n">policy</span><span class="w"> </span><span class="n">action_type</span><span class="p" data-group-id="5592989142-33">(</span><span class="ss">:update</span><span class="p" data-group-id="5592989142-33">)</span><span class="w"> </span><span class="k" data-group-id="5592989142-34">do</span><span class="w">
      </span><span class="n">description</span><span class="w"> </span><span class="s">&quot;Only an admin or the user who tweeted can edit their tweet&quot;</span><span class="w">
      </span><span class="c1"># first check this. If true, then this policy passes</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">actor_attribute_equals</span><span class="p" data-group-id="5592989142-35">(</span><span class="ss">:admin?</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="5592989142-35">)</span><span class="w">
      </span><span class="c1"># then check this. If true, then this policy passes</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">relates_to_actor_via</span><span class="p" data-group-id="5592989142-36">(</span><span class="ss">:user</span><span class="p" data-group-id="5592989142-36">)</span><span class="w">
      </span><span class="c1"># otherwise, there is nothing left to check and no decision, so *this policy fails*</span><span class="w">
    </span><span class="k" data-group-id="5592989142-34">end</span><span class="w">
  </span><span class="k" data-group-id="5592989142-24">end</span><span class="w">


  </span><span class="n">field_policies</span><span class="w"> </span><span class="k" data-group-id="5592989142-37">do</span><span class="w">
    </span><span class="c1"># anyone can see these fields</span><span class="w">
    </span><span class="n">field_policy</span><span class="w"> </span><span class="p" data-group-id="5592989142-38">[</span><span class="ss">:text</span><span class="p">,</span><span class="w"> </span><span class="ss">:tweet_length</span><span class="p" data-group-id="5592989142-38">]</span><span class="w"> </span><span class="k" data-group-id="5592989142-39">do</span><span class="w">
      </span><span class="n">description</span><span class="w"> </span><span class="s">&quot;Public tweet fields are visible&quot;</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="5592989142-40">(</span><span class="p" data-group-id="5592989142-40">)</span><span class="w">
    </span><span class="k" data-group-id="5592989142-39">end</span><span class="w">

    </span><span class="n">field_policy</span><span class="w"> </span><span class="p" data-group-id="5592989142-41">[</span><span class="ss">:hidden?</span><span class="p">,</span><span class="w"> </span><span class="ss">:private_note</span><span class="p" data-group-id="5592989142-41">]</span><span class="w"> </span><span class="k" data-group-id="5592989142-42">do</span><span class="w">
      </span><span class="n">description</span><span class="w"> </span><span class="s">&quot;hidden? and private_note are only visible to the author&quot;</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">relates_to_actor_via</span><span class="p" data-group-id="5592989142-43">(</span><span class="ss">:user</span><span class="p" data-group-id="5592989142-43">)</span><span class="w">
    </span><span class="k" data-group-id="5592989142-42">end</span><span class="w">
  </span><span class="k" data-group-id="5592989142-37">end</span><span class="w">
</span><span class="k" data-group-id="5592989142-7">end</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Domain</span><span class="w"> </span><span class="k" data-group-id="5592989142-44">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Domain</span><span class="p">,</span><span class="w">
    </span><span class="ss">validate_config_inclusion?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">

  </span><span class="n">resources</span><span class="w"> </span><span class="k" data-group-id="5592989142-45">do</span><span class="w">
    </span><span class="n">resource</span><span class="w"> </span><span class="nc">Tweet</span><span class="w"> </span><span class="k" data-group-id="5592989142-46">do</span><span class="w">
      </span><span class="n">define</span><span class="w"> </span><span class="ss">:create_tweet</span><span class="p">,</span><span class="w"> </span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="ss">:create</span><span class="p">,</span><span class="w"> </span><span class="ss">args</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5592989142-47">[</span><span class="ss">:text</span><span class="p" data-group-id="5592989142-47">]</span><span class="w">
      </span><span class="n">define</span><span class="w"> </span><span class="ss">:update_tweet</span><span class="p">,</span><span class="w"> </span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="ss">:update</span><span class="p">,</span><span class="w"> </span><span class="ss">args</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5592989142-48">[</span><span class="ss">:text</span><span class="p" data-group-id="5592989142-48">]</span><span class="w">
      </span><span class="n">define</span><span class="w"> </span><span class="ss">:list_tweets</span><span class="p">,</span><span class="w"> </span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="ss">:read</span><span class="w">
      </span><span class="n">define</span><span class="w"> </span><span class="ss">:get_tweet</span><span class="p">,</span><span class="w"> </span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="ss">:read</span><span class="p">,</span><span class="w"> </span><span class="ss">get_by</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5592989142-49">[</span><span class="ss">:id</span><span class="p" data-group-id="5592989142-49">]</span><span class="w">
    </span><span class="k" data-group-id="5592989142-46">end</span><span class="w">

    </span><span class="n">resource</span><span class="w"> </span><span class="nc">User</span><span class="w"> </span><span class="k" data-group-id="5592989142-50">do</span><span class="w">
      </span><span class="n">define</span><span class="w"> </span><span class="ss">:create_user</span><span class="p">,</span><span class="w"> </span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="ss">:create</span><span class="w">
    </span><span class="k" data-group-id="5592989142-50">end</span><span class="w">
  </span><span class="k" data-group-id="5592989142-45">end</span><span class="w">
</span><span class="k" data-group-id="5592989142-44">end</span><span class="w">
</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="4392032199-1">{</span><span class="ss">:module</span><span class="p">,</span><span class="w"> </span><span class="nc">Domain</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4392032199-2">&lt;&lt;</span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">117</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="4392032199-2">&gt;&gt;</span><span class="p">,</span><span class="w">
 </span><span class="p" data-group-id="4392032199-3">[</span><span class="w">
   </span><span class="nc">Ash.Domain.Dsl.Resources.Resource</span><span class="p">,</span><span class="w">
   </span><span class="nc">Ash.Domain.Dsl.Resources.Options</span><span class="p">,</span><span class="w">
   </span><span class="nc">Ash.Domain.Dsl</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="4392032199-4">%{</span><span class="ss">opts</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4392032199-5">[</span><span class="p" data-group-id="4392032199-5">]</span><span class="p">,</span><span class="w"> </span><span class="ss">entities</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4392032199-6">[</span><span class="n">...</span><span class="p" data-group-id="4392032199-6">]</span><span class="p" data-group-id="4392032199-4">}</span><span class="p">,</span><span class="w">
   </span><span class="nc">Ash.Domain.Dsl</span><span class="p">,</span><span class="w">
   </span><span class="nc">Ash.Domain.Dsl.Resources.Options</span><span class="p">,</span><span class="w">
   </span><span class="n">...</span><span class="w">
 </span><span class="p" data-group-id="4392032199-3">]</span><span class="p" data-group-id="4392032199-1">}</span></code></pre><h2 id="interacting-with-resources-that-have-policies">Interacting with resources that have policies</h2><pre><code class="makeup elixir" translate="no"><span class="c1"># doing forbidden things produces an `Ash.Error.Forbidden`</span><span class="w">
</span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_user!</span><span class="p" data-group-id="1054401438-1">(</span><span class="p" data-group-id="1054401438-1">)</span><span class="w">
</span><span class="n">other_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_user!</span><span class="p" data-group-id="1054401438-2">(</span><span class="p" data-group-id="1054401438-2">)</span><span class="w">

</span><span class="n">tweet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_tweet!</span><span class="p" data-group-id="1054401438-3">(</span><span class="s">&quot;hello world!&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="1054401438-3">)</span><span class="w">
</span><span class="nc">Domain</span><span class="o">.</span><span class="n">update_tweet!</span><span class="p" data-group-id="1054401438-4">(</span><span class="n">tweet</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Goodbye world&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">other_user</span><span class="p" data-group-id="1054401438-4">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="c1"># Reading data applies policies as filters</span><span class="w">

</span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_user!</span><span class="p" data-group-id="5408786463-1">(</span><span class="p" data-group-id="5408786463-1">)</span><span class="w">
</span><span class="n">other_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_user!</span><span class="p" data-group-id="5408786463-2">(</span><span class="p" data-group-id="5408786463-2">)</span><span class="w">

</span><span class="n">my_hidden_tweet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_tweet!</span><span class="p" data-group-id="5408786463-3">(</span><span class="s">&quot;hello world!&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5408786463-4">%{</span><span class="ss">hidden?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="5408786463-4">}</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="5408786463-3">)</span><span class="w">

</span><span class="n">other_users_hidden_tweet</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_tweet!</span><span class="p" data-group-id="5408786463-5">(</span><span class="s">&quot;hello world!&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5408786463-6">%{</span><span class="ss">hidden?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="5408786463-6">}</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">other_user</span><span class="p" data-group-id="5408786463-5">)</span><span class="w">

</span><span class="n">my_tweet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_tweet!</span><span class="p" data-group-id="5408786463-7">(</span><span class="s">&quot;hello world!&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="5408786463-7">)</span><span class="w">
</span><span class="n">other_users_tweet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_tweet!</span><span class="p" data-group-id="5408786463-8">(</span><span class="s">&quot;hello world!&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">other_user</span><span class="p" data-group-id="5408786463-8">)</span><span class="w">

</span><span class="n">tweet_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">list_tweets!</span><span class="p" data-group-id="5408786463-9">(</span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="5408786463-9">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="5408786463-10">(</span><span class="o">&amp;</span><span class="w"> </span><span class="ni">&amp;1</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="5408786463-10">)</span><span class="w">

</span><span class="c1"># I see my own hidden tweets, and other users non-hidden tweets</span><span class="w">
</span><span class="no">true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my_hidden_tweet</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tweet_ids</span><span class="w">
</span><span class="no">true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">other_users_tweet</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tweet_ids</span><span class="w">

</span><span class="c1"># but not other users hidden tweets</span><span class="w">
</span><span class="no">false</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">other_users_hidden_tweet</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tweet_ids</span><span class="w">

</span><span class="ss">:ok</span></code></pre><pre><code class="makeup output" translate="no"><span class="ss">:ok</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="c1"># Field policies return hidden fields as `%Ash.ForbiddenField{}`</span><span class="w">

</span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_user!</span><span class="p" data-group-id="4159507842-1">(</span><span class="p" data-group-id="4159507842-1">)</span><span class="w">
</span><span class="n">other_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_user!</span><span class="p" data-group-id="4159507842-2">(</span><span class="p" data-group-id="4159507842-2">)</span><span class="w">

</span><span class="n">other_users_tweet</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Domain</span><span class="o">.</span><span class="n">create_tweet!</span><span class="p" data-group-id="4159507842-3">(</span><span class="s">&quot;hello world!&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4159507842-4">%{</span><span class="ss">private_note</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;you can&#39;t see this!&quot;</span><span class="p" data-group-id="4159507842-4">}</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">other_user</span><span class="p" data-group-id="4159507842-3">)</span><span class="w">

</span><span class="p" data-group-id="4159507842-5">%</span><span class="nc" data-group-id="4159507842-5">Ash.ForbiddenField</span><span class="p" data-group-id="4159507842-5">{</span><span class="p" data-group-id="4159507842-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Domain</span><span class="o">.</span><span class="n">get_tweet!</span><span class="p" data-group-id="4159507842-6">(</span><span class="n">other_users_tweet</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="4159507842-6">)</span><span class="o">.</span><span class="n">private_note</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="2896916051-1">#</span><span class="nc" data-group-id="2896916051-1">Ash.ForbiddenField</span><span class="p" data-group-id="2896916051-1">&lt;</span><span class="ss">field</span><span class="p">:</span><span class="w"> </span><span class="ss">:private_note</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:attribute</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="2896916051-1">&gt;</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="nc">Tweet</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Policy.Chart.Mermaid</span><span class="o">.</span><span class="n">chart</span><span class="p" data-group-id="3817395167-1">(</span><span class="p" data-group-id="3817395167-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino.Shorts</span><span class="o">.</span><span class="n">mermaid</span><span class="p" data-group-id="3817395167-2">(</span><span class="p" data-group-id="3817395167-2">)</span></code></pre><pre><code class="mermaid output">flowchart TB
subgraph at least one policy applies
direction TB
at_least_one_policy[&quot;action.type == :read
or action.type == :create
or action.type == :update&quot;]
end
at_least_one_policy--False--&gt;Forbidden
at_least_one_policy--True--&gt;0_conditions
subgraph Policy 1[If a tweet is hidden, only the author can read it. Otherwise, anyone can.]
direction TB
0_conditions{&quot;action.type == :read&quot;}
0_checks_0{&quot;record.user == actor&quot;}
0_checks_1{&quot;hidden? == true&quot;}
end
0_conditions--True--&gt;0_checks_0
0_conditions--False--&gt;1_conditions
0_checks_0--True--&gt;1_conditions
0_checks_0--False--&gt;0_checks_1
0_checks_1--True--&gt;Forbidden
0_checks_1--False--&gt;1_conditions
subgraph Policy 2[Anyone can create a tweet]
direction TB
1_conditions{&quot;action.type == :create&quot;}
end
subgraph Policy 3[Only an admin or the user who tweeted can edit their tweet]
direction TB
2_conditions{&quot;action.type == :update&quot;}
2_checks_0{&quot;actor.admin? == true&quot;}
2_checks_1{&quot;record.user == actor&quot;}
end
2_conditions--True--&gt;2_checks_0
2_conditions--False--&gt;Authorized
2_checks_0--True--&gt;Authorized
2_checks_0--False--&gt;2_checks_1
2_checks_1--True--&gt;Authorized
2_checks_1--False--&gt;Forbidden
subgraph results[Results]
Authorized([Authorized])
Forbidden([Forbidden])
end
1_conditions--Or--&gt;2_conditions</code></pre>

  </body>
</html>
