<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
      xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>Aggregates - ash v3.5.33</title>
    <meta name="generator" content="ExDoc v0.38.2" />
    <link type="text/css" rel="stylesheet" href="dist/epub-elixir-FNUUKFP7.css" />
    <script src="dist/epub-4WIP524F.js"></script>

  </head>
  <body class="content-inner">

    <h1 id="content">Aggregates</h1>
<p>Aggregates in Ash allow for retrieving summary information over groups of related data. A simple example might be to show the &quot;count of published posts for a user&quot;. Aggregates allow us quick and performant access to this data, in a way that supports being filtered/sorted on automatically. More aggregate types can be added, but you will be restricted to only the supported types. In cases where aggregates don't suffice, use <a href="calculations.xhtml">Calculations</a>, which are intended to be much more flexible.</p><h2 id="declaring-aggregates-on-a-resource">Declaring aggregates on a resource</h2><p>Aggregates are defined in an <code class="inline">aggregates</code> section. For all possible types, see below.
For a full reference, see <code class="inline">d:Ash.Resource.Dsl.aggregates</code>.</p><pre><code class="makeup elixir" translate="no"><span class="n">aggregates</span><span class="w"> </span><span class="k" data-group-id="4589064126-1">do</span><span class="w">
  </span><span class="n">count</span><span class="w"> </span><span class="ss">:count_of_posts</span><span class="p">,</span><span class="w"> </span><span class="ss">:posts</span><span class="w"> </span><span class="k" data-group-id="4589064126-2">do</span><span class="w">
    </span><span class="n">filter</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="4589064126-3">(</span><span class="n">published</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4589064126-3">)</span><span class="w">
  </span><span class="k" data-group-id="4589064126-2">end</span><span class="w">
</span><span class="k" data-group-id="4589064126-1">end</span></code></pre><h2 id="using-an-aggregate">Using an aggregate</h2><p>Aggregates are loaded and filtered on in the same way that calculations are. Lets look at some examples:</p><h3 id="loading-aggregates-in-a-query-or-on-records">Loading aggregates in a query or on records</h3><pre><code class="makeup elixir" translate="no"><span class="nc">User</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">load</span><span class="p" data-group-id="4156466885-1">(</span><span class="ss">:count_of_posts</span><span class="p" data-group-id="4156466885-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="4156466885-2">(</span><span class="ss">:count_of_posts</span><span class="p" data-group-id="4156466885-2">)</span><span class="w">
</span><span class="c1"># =&gt; 10</span><span class="w">

</span><span class="n">users</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">load!</span><span class="p" data-group-id="4156466885-3">(</span><span class="ss">:count_of_posts</span><span class="p" data-group-id="4156466885-3">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="4156466885-4">(</span><span class="o">&amp;</span><span class="p" data-group-id="4156466885-5">(</span><span class="ni">&amp;1</span><span class="o">.</span><span class="n">count_of_posts</span><span class="p" data-group-id="4156466885-5">)</span><span class="p" data-group-id="4156466885-4">)</span><span class="w">
</span><span class="c1"># =&gt; [3, 5, 2]</span></code></pre><h3 id="filtering-on-aggregates">Filtering on aggregates</h3><pre><code class="makeup elixir" translate="no"><span class="kn">require</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="w">

</span><span class="nc">User</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="7643179032-1">(</span><span class="n">count_of_posts</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="7643179032-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="7643179032-2">(</span><span class="p" data-group-id="7643179032-2">)</span></code></pre><h3 id="sorting-aggregates">Sorting aggregates</h3><pre><code class="makeup elixir" translate="no"><span class="nc">User</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">sort</span><span class="p" data-group-id="7445352226-1">(</span><span class="ss">count_of_posts</span><span class="p">:</span><span class="w"> </span><span class="ss">:asc</span><span class="p" data-group-id="7445352226-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="7445352226-2">(</span><span class="p" data-group-id="7445352226-2">)</span></code></pre><h2 id="aggregate-types">Aggregate types</h2><ul><li><code class="inline">count</code> - counts related items meeting the criteria.</li><li><code class="inline">exists</code> - checks if any related items meet the criteria.</li><li><code class="inline">first</code> - gets the first related value matching the criteria. Must specify the <code class="inline">field</code>.</li><li><code class="inline">sum</code> - sums the related items meeting the criteria. Must specify the <code class="inline">field</code>.</li><li><code class="inline">list</code> - lists the related values. Must specify the <code class="inline">field</code>.</li><li><code class="inline">max</code> - gets the maximum related value. Must specify the <code class="inline">field</code>.</li><li><code class="inline">min</code> - gets the minimum related value. Must specify the <code class="inline">field</code>.</li><li><code class="inline">avg</code> - gets the average related value. Must specify the <code class="inline">field</code>.</li><li><code class="inline">custom</code> - allows for a custom aggregate. Implementation depends on the data layer. Must provide an <code class="inline">implementation</code>.</li></ul><p>The declared set of named aggregates can be used by extensions and referred to throughout your application As an escape hatch, they can also be loaded in the query using <a href="Ash.Query.xhtml#load/2"><code class="inline">Ash.Query.load/2</code></a>, or after the fact using <a href="Ash.xhtml#load/3"><code class="inline">Ash.load/3</code></a>. Aggregates declared on the resource will be keys in the resource's struct.</p><p>See the docs on <code class="inline">d:Ash.Resource.Dsl.aggregates</code> for more information.</p><h2 id="custom-aggregates-in-the-query">Custom aggregates in the query</h2><p>Custom aggregates can be added to the query and will be placed in the <code class="inline">aggregates</code> key of the results. This is an escape hatch, and is not the primary way that you should be using aggregates. It does, however, allow for dynamism, i.e if you are accepting user input that determines what the filter and/or field should be, that kind of thing.</p><p>Example:</p><pre><code class="makeup elixir" translate="no"><span class="nc">User</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">aggregate</span><span class="p" data-group-id="8033297479-1">(</span><span class="w">
  </span><span class="ss">:count_of_posts</span><span class="p">,</span><span class="w">
  </span><span class="ss">:count</span><span class="p">,</span><span class="w">
  </span><span class="ss">:posts</span><span class="p">,</span><span class="w">
  </span><span class="ss">query</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8033297479-2">[</span><span class="w">
    </span><span class="ss">filter</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8033297479-3">[</span><span class="ss">published</span><span class="p">:</span><span class="w"> </span><span class="n">published?</span><span class="p" data-group-id="8033297479-3">]</span><span class="w">
  </span><span class="p" data-group-id="8033297479-2">]</span><span class="w">
</span><span class="p" data-group-id="8033297479-1">)</span></code></pre><p>See the documentation for <a href="Ash.Query.xhtml#aggregate/4"><code class="inline">Ash.Query.aggregate/4</code></a> for more information.</p><h2 id="join-filters">Join Filters</h2><p>Join filters allows for more complex aggregate queries, including joining with predicates based on multiple related values.</p><h3 id="example">Example</h3><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="n">aggregates</span><span class="w"> </span><span class="k" data-group-id="1552993220-1">do</span><span class="w">
    </span><span class="n">sum</span><span class="w"> </span><span class="ss">:saved_money</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1552993220-2">[</span><span class="ss">:redeems</span><span class="p">,</span><span class="w"> </span><span class="ss">:deal</span><span class="p" data-group-id="1552993220-2">]</span><span class="p">,</span><span class="w"> </span><span class="ss">:amount</span><span class="w"> </span><span class="k" data-group-id="1552993220-3">do</span><span class="w">
      </span><span class="c1"># where any redeem of the deal is redeemed</span><span class="w">
      </span><span class="n">filter</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="1552993220-4">(</span><span class="n">redeems</span><span class="o">.</span><span class="n">redeemed</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="1552993220-4">)</span><span class="w">

      </span><span class="c1"># where the `redeems` are `redeemed`</span><span class="w">
      </span><span class="n">join_filter</span><span class="w"> </span><span class="ss">:redeems</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="1552993220-5">(</span><span class="n">redeemed</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="1552993220-5">)</span><span class="w">

      </span><span class="c1"># where the `redeems.deal.active` == `redeems.require_active`</span><span class="w">
      </span><span class="n">join_filter</span><span class="w"> </span><span class="p" data-group-id="1552993220-6">[</span><span class="ss">:redeems</span><span class="p">,</span><span class="w"> </span><span class="ss">:deal</span><span class="p" data-group-id="1552993220-6">]</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="1552993220-7">(</span><span class="n">active</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">parent</span><span class="p" data-group-id="1552993220-8">(</span><span class="n">require_active</span><span class="p" data-group-id="1552993220-8">)</span><span class="p" data-group-id="1552993220-7">)</span><span class="w">
    </span><span class="k" data-group-id="1552993220-3">end</span><span class="w">
  </span><span class="k" data-group-id="1552993220-1">end</span></code></pre><h2 id="inline-aggregates">Inline Aggregates</h2><p>Aggregates can be created in-line in expressions, with their relationship path specified and any options provided that match the options given to <a href="Ash.Query.Aggregate.xhtml#new/4"><code class="inline">Ash.Query.Aggregate.new/4</code></a>. For example:</p><pre><code class="makeup elixir" translate="no"><span class="n">calculate</span><span class="w"> </span><span class="ss">:grade</span><span class="p">,</span><span class="w"> </span><span class="ss">:decimal</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="4188552284-1">(</span><span class="w">
  </span><span class="n">count</span><span class="p" data-group-id="4188552284-2">(</span><span class="n">answers</span><span class="p">,</span><span class="w"> </span><span class="ss">query</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4188552284-3">[</span><span class="ss">filter</span><span class="p">:</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="4188552284-4">(</span><span class="n">correct</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4188552284-4">)</span><span class="p" data-group-id="4188552284-3">]</span><span class="p" data-group-id="4188552284-2">)</span><span class="w"> </span><span class="o">/</span><span class="w">
  </span><span class="n">count</span><span class="p" data-group-id="4188552284-5">(</span><span class="n">answers</span><span class="p">,</span><span class="w"> </span><span class="ss">query</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4188552284-6">[</span><span class="ss">filter</span><span class="p">:</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="4188552284-7">(</span><span class="n">correct</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="4188552284-7">)</span><span class="p" data-group-id="4188552284-6">]</span><span class="p" data-group-id="4188552284-5">)</span><span class="w">
</span><span class="p" data-group-id="4188552284-1">)</span></code></pre><p>See the <a href="expressions.xhtml#inline-aggregates">Expressions guide</a> for more.</p>

  </body>
</html>
